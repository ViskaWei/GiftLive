# 🎁 GiftLive — 直播打赏预测与分配优化

> **离线实验仓库** | 数据: KuaiLive | 状态: Phase 0-3 ✅ 完成

## 🎯 核心问题

**如何在直播场景下最大化全局打赏收益？**

分解为三个子问题：
1. **估计层**: 如何准确预测极稀疏、重尾的打赏行为？
2. **分配层**: 如何在全局最优下分配高价值用户？
3. **评估层**: 如何可靠评估分配策略？

## 🔑 核心结论 (12个实验验证)

| # | 结论 | 证据 | 决策 |
|---|------|------|------|
| K1 | **直接回归优于两段式** | Top-1%: 54.5% vs 35.7% (Δ=+18.8pp) | 保留简单架构 |
| K2 | **交互历史是最强特征** | `pair_gift_mean` 重要性是第二名的3倍 | 优先维护交互特征 |
| K3 | **延迟反馈不是问题** | 86.3%礼物立即发生，Chapelle方法ECE变差 | 简单负例处理足够 |
| K4 | **多任务学习无优势** | Multi PR-AUC=0.165 < Single=0.182 | 保留单任务 |
| K5 | **Two-Stage适合精排** | gift子集Spearman: 0.89 > Direct 0.74 | 可用于召回-精排分工 |
| K6 | **软约束冷启动有效** | 收益+32%, 成功率+263% | 采用λ=0.5 |
| K7 | **凹收益分配无显著优势** | Δ Revenue = -1.17% | 简化为Greedy |
| K8 | **SNIPS是最佳OPE方法** | RelErr: Softmax 0.57%, Greedy 9.97% | 探索率≥0.3, 日志量≥5000 |

## 🏗️ 推荐架构

```
用户请求
    ↓
┌─────────────────────────────────────────────────────┐
│ 1️⃣ 估计层: Direct Regression                        │
│    - 模型: LightGBM 回归 log(1+Y)                    │
│    - 特征: 用户-主播交互历史为核心                    │
│    - 输出: 期望收益 EV(u,s)                          │
└─────────────────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────────────┐
│ 2️⃣ 分配层: Greedy + 软约束                          │
│    - 策略: argmax EV(u,s) + λ·冷启动bonus           │
│    - 参数: λ=0.5, min_alloc=10                      │
│    - 效果: 收益+32%, 新主播成功率+263%               │
└─────────────────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────────────┐
│ 3️⃣ 评估层: SNIPS OPE                               │
│    - 方法: Self-Normalized IPS                      │
│    - 要求: 探索率≥0.3, 日志量≥5000                  │
│    - 精度: RelErr < 10%                             │
└─────────────────────────────────────────────────────┘
```

## 📊 关键数字

| 类别 | 指标 | 值 |
|------|------|-----|
| **数据特征** | 打赏率 | 1.48% |
| | User Gini | 0.942 (Top 1%贡献60%收益) |
| | Streamer Gini | 0.930 |
| | 矩阵密度 | 0.0064% |
| | 冷启动主播占比 | 92.2% |
| **预测性能** | Direct Reg Top-1% | 54.5% |
| | Direct Reg Spearman | 0.331 |
| | Two-Stage NDCG@100 | 0.359 (精排更优) |
| | Stage1 PR-AUC | 0.651 |
| | Stage1 ECE | 0.018 |
| **分配性能** | Greedy/Random收益比 | 2.94x |
| | 软约束收益提升 | +32% |
| | 软约束成功率提升 | +263% |
| **评估性能** | SNIPS最优RelErr | 0.57% (Softmax) |
| | Simulator Gini误差 | <5% |

## 📋 实验索引 (12/13 完成)

| MVP | 名称 | 状态 | 关键结论 |
|-----|------|------|---------|
| 0.1 | KuaiLive EDA | ✅ | Gini=0.94, 两段式建模必要性确认 |
| 0.2 | Baseline | ✅ | Top-1%=56.2%, 交互特征主导 |
| 0.3 | Simulator V1 | ✅ | Gini误差<5%, Greedy 3x Random |
| 1.1 | Two-Stage | ✅ | 揭示与Baseline不可直接对比 |
| 1.1-fair | 公平对比 | ✅ | Direct胜出 (Δ=+18.8pp) |
| 1.2 | 延迟建模 | ✅ | 延迟不是问题，DG2关闭 |
| 1.2-audit | 延迟审计 | ✅ | 代码bug修复，pct_late_50=13.3% |
| 1.3 | 多任务 | ✅ | 无优势 (Δ=-1.76pp)，DG5关闭 |
| 1.4 | 诊断拆解 | ✅ | 主因=Stage1分类不足，Stage2精排有优势 |
| 2.1 | 凹收益分配 | ✅ | Δ=-1.17%无显著优势，DG3关闭 |
| 2.2 | 冷启动约束 | ✅ | 软约束+32%收益，Gate-2关闭 |
| 3.1 | OPE验证 | ✅ | SNIPS最佳，Gate-3关闭 |
| 1.5 | 召回-精排 | ⏳ | 可选优化 |

## 📁 项目结构

```
GiftLive/
├── gift_allocation/           # 主实验目录
│   ├── gift_allocation_hub.md         # 智库导航
│   ├── gift_allocation_roadmap.md     # 实验追踪
│   ├── exp/                           # 12个实验报告
│   ├── results/                       # 结果JSON
│   └── img/                           # 图表
├── scripts/                   # 训练脚本
└── data/KuaiLive/             # 数据集
```

## 🔗 导航

| 文档 | 路径 |
|------|------|
| 🧠 Hub | [gift_allocation_hub.md](gift_allocation/gift_allocation_hub.md) |
| 🗺️ Roadmap | [gift_allocation_roadmap.md](gift_allocation/gift_allocation_roadmap.md) |

## 📌 问题与解法

| 问题 | 解法 | 验证结果 |
|------|------|---------|
| **稀疏+重尾** (打赏率1.48%, Gini=0.94) | Direct Regression + log(1+Y) | Top-1% Capture = 54.5% |
| **延迟反馈** | 简单负例处理 | 86.3%礼物立即发生，无需延迟校正 |
| **资源约束** | Greedy + 软约束冷启动 | 收益+32%, 成功率+263% |

## 📅 更新日志

| 日期 | 事件 |
|------|------|
| 2026-01-08 | Phase 0-3 完成：12/13 MVP，Gate-2/3关闭 |
| 2026-01-08 | 推荐策略确定：Direct Reg + Greedy + 软约束 + SNIPS |

**作者**: Viska Wei | **数据**: KuaiLive | **完成度**: 92%
