# ğŸƒ Leakage-Free Baseline: Past-Only Features & Click-Level EV Prediction

> **Name:** Leakage-Free Baseline
> **ID:** `EXP-20260118-gift_EVmodel-01`
> **Topic:** `gift_EVmodel` | **MVP:** MVP-1.0
> **Author:** Viska Wei | **Date:** 2026-01-18 | **Status:** âœ… **å·²å®Œæˆ**

> ğŸ¯ **Target:** ä¿®å¤ baseline çš„ä¸‰ä¸ªè‡´å‘½é—®é¢˜ï¼ˆæ•°æ®æ³„æ¼ + ä»»åŠ¡ä¸åŒ¹é… + è¯„ä¼°åå·®ï¼‰ï¼Œå»ºç«‹å¯ä¿¡çš„å¯¹æ¯”åŸºå‡†
> ğŸš€ **Result:** æ•°æ®æ³„æ¼å·²æ¶ˆé™¤ï¼ˆç‰¹å¾é‡è¦æ€§æ¯” 1.23 < 2xï¼‰ï¼Œä½†æ€§èƒ½å¤§å¹…ä¸‹é™ï¼Œæ­ç¤ºåŸ baseline æ€§èƒ½å‡ ä¹å…¨éƒ¨æ¥è‡ªæ³„æ¼

---

## ğŸ”´ å®éªŒä¼˜å…ˆçº§ï¼šæœ€é«˜

> **æœ¬å®éªŒæ˜¯æ‰€æœ‰åç»­å®éªŒçš„å‰æ**ã€‚Gate-0 å¿…é¡»é€šè¿‡åæ‰èƒ½è¿›è¡Œ Gate-1/Gate-2ã€‚

| è§£å†³çš„é—®é¢˜ | è§£å†³æ–¹æ¡ˆ | éªŒæ”¶æ ‡å‡† |
|------------|----------|----------|
| **P1: æ•°æ®æ³„æ¼** | Past-only ç‰¹å¾ï¼ˆå†»ç»“ç‰ˆ + æ»šåŠ¨ç‰ˆï¼‰ | ç‰¹å¾é‡è¦æ€§åˆ†å¸ƒæ­£å¸¸ï¼ˆæ— å•ä¸€ç‰¹å¾ä¸»å¯¼ï¼‰ |
| **P2: ä»»åŠ¡ä¸åŒ¹é…** | Click-level EVï¼ˆå« 0ï¼‰ | æ¨¡å‹èƒ½åŒºåˆ†"ä¼š/ä¸ä¼šé€ç¤¼" |
| **P3: è¯„ä¼°åå·®** | Revenue Capture@Kï¼ˆæ”¶å…¥å æ¯”ï¼‰ | æŒ‡æ ‡ä¸ä¸šåŠ¡ç›®æ ‡å¯¹é½ |

---

## âš¡ æ ¸å¿ƒç»“è®ºé€Ÿè§ˆ

> **ä¸€å¥è¯**: æ•°æ®æ³„æ¼å·²æˆåŠŸæ¶ˆé™¤ï¼ˆç‰¹å¾é‡è¦æ€§æ¯” 1.23ï¼‰ï¼Œä½†æ€§èƒ½å¤§å¹…ä¸‹é™ï¼ˆTop-1% ä» 56.2% é™è‡³ 11.6%ï¼‰ï¼Œæ­ç¤ºåŸ baseline **å‡ ä¹å…¨éƒ¨é¢„æµ‹èƒ½åŠ›æ¥è‡ªæ•°æ®æ³„æ¼**ã€‚Gate-0 å¤±è´¥ï¼Œéœ€é‡æ–°è®¾è®¡ç‰¹å¾å·¥ç¨‹ç­–ç•¥ã€‚

| éªŒè¯é—®é¢˜ | ç»“æœ | ç»“è®º |
|---------|------|------|
| H1.1: Past-only ç‰¹å¾èƒ½å¦æ¶ˆé™¤æ³„æ¼ï¼Ÿ | âœ… **é€šè¿‡** | ç‰¹å¾é‡è¦æ€§æ¯” 1.23 < 2xï¼Œæ³„æ¼å·²æ¶ˆé™¤ |
| H1.2: Click-levelï¼ˆå« 0ï¼‰EV é¢„æµ‹æ˜¯å¦åˆç†ï¼Ÿ | âŒ **å¤±è´¥** | Revenue Capture@1% = 21.6%ï¼Œè¿œä½äº 50% ç›®æ ‡ |
| H1.3: Direct vs Two-Stage åœ¨æ— æ³„æ¼ç‰ˆæœ¬ä¸Šçš„ç›¸å¯¹è¡¨ç°ï¼Ÿ | âš ï¸ **ä¸ç¡®å®š** | ä¸¤è€…æ€§èƒ½éƒ½å¾ˆå·®ï¼Œæ— æ³•å¾—å‡ºå¯é ç»“è®º |
| H1.4: æ¨¡å‹æ€§èƒ½å¯æ¥å—ï¼Ÿ | âŒ **å¤±è´¥** | Spearman ä» 0.891 é™è‡³ 0.14ï¼Œä¸‹é™ > 0.7 |

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å®é™…å€¼ | vs Baseline | çŠ¶æ€ |
|------|--------|--------|-------------|------|
| Top-1% Capture | **> 40%** | **11.6%** | vs ~~56.2%~~ï¼ˆ-44.6ppï¼‰ | âŒ |
| Spearman | **ä¸‹é™ < 0.2** | **0.14** | vs ~~0.891~~ï¼ˆ-0.75ï¼‰ | âŒ |
| Revenue Capture@1% | **> 50%** | **21.6%** | æ–°æŒ‡æ ‡ | âŒ |
| ç‰¹å¾é‡è¦æ€§æ¯” | **< 2x** | **1.23** | vs ~~3x+~~ | âœ… |

| Type | Link |
|------|------|
| ğŸ§  Hub | `../gift_EVmodel_hub.md` Â§ Q0, Q1.1, Q2.1 |
| ğŸ—ºï¸ Roadmap | `../gift_EVmodel_roadmap.md` Â§ MVP-1.0, Gate-0, Gate-1 |
| ğŸ“‹ ä¸Šæ¸¸åˆ†æ | `exp_baseline_20260108.md`ï¼ˆå·²åºŸå¼ƒï¼Œæ³„æ¼åˆ†æï¼‰ |

---

# 1. ğŸ¯ ç›®æ ‡

**é—®é¢˜è¯Šæ–­**ï¼ˆæ¥è‡ª 2026-01-18 åˆ†æï¼‰ï¼š

| é—®é¢˜ | ä¸¥é‡æ€§ | è¯æ® | æœ¬å®éªŒè§£å†³æ–¹æ¡ˆ |
|------|--------|------|----------------|
| **P1: æ•°æ®æ³„æ¼** | ğŸ”´ è‡´å‘½ | `pair_gift_mean` é‡è¦æ€§=328,571ï¼Œè¿œè¶…ç¬¬äºŒå 3 å€ | **Past-only ç‰¹å¾** |
| **P2: ä»»åŠ¡ä¸åŒ¹é…** | ğŸ”´ è‡´å‘½ | gift-only å­¦çš„æ˜¯ E[gift\|å·²é€ç¤¼]ï¼Œä¸æ˜¯ EV | **Click-level EVï¼ˆå« 0ï¼‰** |
| **P3: è¯„ä¼°åå·®** | ğŸŸ¡ ä¸­ç­‰ | Top-K% Capture æ˜¯é›†åˆé‡å ï¼Œä¸å…³å¿ƒé‡‘é¢å·®å¼‚ | **Revenue Capture@K** |

**éªŒè¯å‡è®¾**ï¼š

| å‡è®¾ | éªŒè¯æ–¹æ³• | é€šè¿‡æ ‡å‡† | å¤±è´¥åæœ |
|------|----------|----------|----------|
| **H1.1**: Past-only ç‰¹å¾èƒ½æ¶ˆé™¤æ³„æ¼ | æ£€æŸ¥ç‰¹å¾é‡è¦æ€§åˆ†å¸ƒ | æ— å•ä¸€ç‰¹å¾ä¸»å¯¼ï¼ˆæœ€é«˜/ç¬¬äºŒ < 2xï¼‰ | é‡æ–°è®¾è®¡ç‰¹å¾ |
| **H1.2**: Click-level EV é¢„æµ‹æœ‰æ•ˆ | è®¡ç®— Revenue Capture@K | Revenue Capture@1% > 50% | æ£€æŸ¥æ•°æ®æ„é€  |
| **H1.3**: Direct vs Two-Stage ç»“è®ºç¨³å®š | å¯¹æ¯”ä¸¤ç§æ¶æ„ | Direct ä»é¢†å…ˆ > 10pp | é‡æ–°è¯„ä¼°æ¶æ„ |
| **H1.4**: æ¨¡å‹æ€§èƒ½å¯æ¥å— | å¯¹æ¯”åŸ baseline | Top-1% > 40%ï¼ŒSpearman ä¸‹é™ < 0.2 | å¢å¼ºç‰¹å¾å·¥ç¨‹ |

**éªŒæ”¶æ ‡å‡†è¯¦è§£**ï¼š

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | é¢„æœŸå˜åŒ– | è¯´æ˜ |
|------|--------|----------|------|
| **Top-1% Capture** | **> 40%** | ä» ~~56.2%~~ ä¸‹é™ 10-15pp | å»é™¤æ³„æ¼åçš„çœŸå®æ€§èƒ½ |
| **Revenue Capture@1%** | **> 50%** | æ–°æŒ‡æ ‡ | æ”¶å…¥å æ¯”ï¼Œéé›†åˆé‡å  |
| **Spearman** | **ä¸‹é™ < 0.2** | ä» ~~0.891~~ ä¸‹é™ | å¯èƒ½é™åˆ° 0.7-0.8 |
| **ECE** | **< 0.05** | - | æ ¡å‡†è¯¯å·® |
| **ç‰¹å¾é‡è¦æ€§æ¯”** | **< 2x** | ä» 3x+ ä¸‹é™ | æœ€é«˜/ç¬¬äºŒç‰¹å¾çš„æ¯”å€¼ |
| **å†»ç»“ç‰ˆ vs æ»šåŠ¨ç‰ˆå·®è·** | **< 10pp** | - | ç¡®è®¤ç‰¹å¾æ„é€ æ–¹å¼åˆç† |

**é¢„æœŸç°è±¡**ï¼ˆç”¨äºéªŒè¯å®éªŒæ­£ç¡®æ€§ï¼‰ï¼š

1. **ç‰¹å¾é‡è¦æ€§é‡æ–°åˆ†å¸ƒ**ï¼š`pair_gift_*_past` ä»é‡è¦ï¼Œä½†ä¸å†ä¸»å¯¼ï¼ˆæ¯”å€¼ < 2xï¼‰
2. **å†·å¯åŠ¨ pair æ€§èƒ½ä¸‹é™**ï¼štrain ä¸­ pair_gift_count=0 çš„æ ·æœ¬ï¼Œé¢„æµ‹èƒ½åŠ›æœ‰é™ï¼ˆç¬¦åˆé¢„æœŸï¼‰
3. **Direct vs Two-Stage å·®è·å˜åŒ–**ï¼šå¯èƒ½ç¼©å°æˆ–ä¸å˜ï¼ˆéœ€è§‚å¯Ÿï¼‰
4. **Top-1% ç”¨æˆ· vs é•¿å°¾ç”¨æˆ·å·®è·æ˜æ˜¾**ï¼šé‡å°¾åˆ†å¸ƒç‰¹æ€§

---

# 2. ğŸ¦¾ ç®—æ³•

**æ ¸å¿ƒæ”¹è¿›**ï¼š

1. **ç‰¹å¾å·¥ç¨‹ï¼šPast-Only ç‰¹å¾ä½“ç³»**

   - **å†»ç»“ç‰ˆï¼ˆä¸¥æ ¼ä¸‹ç•Œï¼‰**ï¼šæ‰€æœ‰èšåˆç‰¹å¾åªç”¨ train window ç»Ÿè®¡ï¼Œval/test åªæŸ¥ train ç»Ÿè®¡è¡¨
   - **åœ¨çº¿æ»šåŠ¨ç‰ˆï¼ˆæ¥è¿‘çº¿ä¸Šï¼‰**ï¼šæŒ‰ timestamp æ’åºï¼Œå¯¹ user/pair/streamer åš cumsum/expandingï¼Œå¹¶ shift(1) æ’é™¤å½“å‰æ ·æœ¬

2. **ä»»åŠ¡å®šä¹‰ï¼šClick-Level EV é¢„æµ‹**

   - æ ·æœ¬å•å…ƒï¼šä¸€æ¡ click ä»£è¡¨ç”¨æˆ·è¿›å…¥æŸç›´æ’­é—´çš„ä¸€æ¬¡æœºä¼š
   - Labelï¼šåœ¨è¯¥ click çš„è§‚çœ‹çª—å£å†…ï¼ˆH=1hï¼‰å‘ç”Ÿçš„ gift æ€»é¢ï¼Œæ²¡å‘ç”Ÿåˆ™ 0
   - ç›®æ ‡ï¼šé¢„æµ‹ $EV_{gift} = \mathbb{E}[\text{gift\_amount} \mid \text{click}, \text{context}]$ï¼ˆåŒ…å« 0ï¼‰

3. **æ¨¡å‹æ¶æ„**ï¼š

   - **Direct Regression**ï¼š$\hat{v}(x) = \text{LightGBM}(x)$ï¼Œç›®æ ‡ `log(1+Y)` æˆ– raw `Y`
   - **Two-Stage**ï¼š$\hat{v}(x) = \hat{p}(x) \times \hat{m}(x)$ï¼Œå…¶ä¸­ Stage2 é¢„æµ‹ raw amount çš„æ¡ä»¶æœŸæœ›

4. **è¯„ä¼°æŒ‡æ ‡å‡çº§**ï¼š

   - **Revenue Capture@K**ï¼š$\text{RevShare@K} = \frac{\sum_{i \in \text{TopK}(\hat{v})} Y_i}{\sum_i Y_i}$ï¼ˆæ”¶å…¥å æ¯”ï¼Œéé›†åˆé‡å ï¼‰
   - **åˆ†æ¡¶æ ¡å‡†**ï¼šECE / reliability curveï¼ˆå¯¹ EV æˆ– P(gift)ï¼‰
   - **åˆ‡ç‰‡è¯„ä¼°**ï¼šå†·å¯åŠ¨ pairã€å†·å¯åŠ¨ streamerã€top1%/top10%/é•¿å°¾ç”¨æˆ·åˆ†åˆ«çœ‹

---

# 3. ğŸ§ª å®éªŒè®¾è®¡

## 3.1 æ•°æ®

| é¡¹ | å€¼ |
|----|-----|
| æ¥æº | KuaiLive |
| è·¯å¾„ | `data/KuaiLive/` |
| æ ·æœ¬å•å…ƒ | **Click-level**ï¼ˆä» gift-only æ”¹ä¸º click å…¨é‡ï¼Œå« 0ï¼‰ |
| Train/Val/Test | æŒ‰æ—¶é—´åˆ‡åˆ†ï¼šå‰ 70% / ä¸­é—´ 15% / æœ€å 15% å¤© |
| ç‰¹å¾ç»´åº¦ | ~70ï¼ˆpast-only ç‰ˆæœ¬ï¼‰ |
| æ—¶é—´èŒƒå›´ | 2025-05-04 to 2025-05-25 |

**å…³é”®å˜æ›´**ï¼š
- âœ… ä» `gift.csv` æ”¹ä¸º `click.csv`ï¼ˆæˆ– click-gift joinï¼Œå«æœªé€ç¤¼çš„ clickï¼‰
- âœ… Labelï¼šclick å H=1h å†…çš„ gift æ€»é¢ï¼ˆ0 æˆ–æ­£æ•°ï¼‰
- âœ… æ—¶é—´åˆ‡åˆ†ï¼šä¸¥æ ¼æŒ‰ timestampï¼Œé¿å…æœªæ¥ä¿¡æ¯

## 3.2 ç‰¹å¾å·¥ç¨‹

### 3.2.1 Past-Only ç‰¹å¾ï¼ˆæ ¸å¿ƒæ”¹è¿›ï¼‰

| ç‰¹å¾ç±»åˆ« | å†»ç»“ç‰ˆå®ç° | åœ¨çº¿æ»šåŠ¨ç‰ˆå®ç° |
|---------|-----------|---------------|
| **ç”¨æˆ·-ä¸»æ’­äº¤äº’** | `pair_gift_sum_train` = åªç”¨ train çª—å£ç»Ÿè®¡ | `pair_gift_sum_past(t)` = cumsum åˆ° t-Îµï¼Œshift(1) |
| | `pair_gift_mean_train` | `pair_gift_mean_past(t)` |
| | `pair_gift_count_train` | `pair_gift_count_past(t)` |
| | `pair_last_gift_time_gap_train` | `pair_last_gift_time_gap_past(t)` |
| **ç”¨æˆ·ä¾§** | `user_total_gift_7d_train` | `user_total_gift_7d_past(t)` |
| | `user_budget_proxy_train` | `user_budget_proxy_past(t)`ï¼ˆæœ€è¿‘ 7 å¤©æ€»é¢ï¼‰ |
| **ä¸»æ’­ä¾§** | `streamer_recent_revenue_train` | `streamer_recent_revenue_past(t)` |
| | `streamer_recent_unique_givers_train` | `streamer_recent_unique_givers_past(t)` |
| | `streamer_overload_proxy_train` | `streamer_overload_proxy_past(t)`ï¼ˆæœ€è¿‘ 1h/1d è§‚çœ‹äººæ•°ï¼‰ |

**å®ç°ç»†èŠ‚**ï¼š
- å†»ç»“ç‰ˆï¼štrain çª—å£å†… groupby(user_id, streamer_id) ç»Ÿè®¡ â†’ ä¿å­˜ä¸º lookup è¡¨ â†’ val/test åªæŸ¥è¡¨
- åœ¨çº¿æ»šåŠ¨ç‰ˆï¼šæŒ‰ timestamp æ’åº â†’ groupby + cumsum â†’ shift(1) æ’é™¤å½“å‰æ ·æœ¬

### 3.2.2 ä¿ç•™çš„ç‰¹å¾ï¼ˆæ— æ³„æ¼é£é™©ï¼‰

- ç”¨æˆ·ç”»åƒï¼šé™æ€ç‰¹å¾ï¼ˆå¹´é¾„ã€æ€§åˆ«ç­‰ï¼Œå¦‚æœ‰ï¼‰
- ä¸»æ’­ç”»åƒï¼šé™æ€ç‰¹å¾
- ä¸Šä¸‹æ–‡ç‰¹å¾ï¼šhour, day_of_week, ç›´æ’­é—´ä¿¡æ¯ï¼ˆå®æ—¶å¯å¾—ï¼‰
- æ—¶é—´ç‰¹å¾ï¼šç›¸å¯¹æ—¶é—´ï¼ˆè·ç¦» train å¼€å§‹çš„å¤©æ•°ï¼‰

### 3.2.3 ç§»é™¤çš„ç‰¹å¾ï¼ˆç¡®è®¤æ³„æ¼ï¼‰

- âŒ `pair_gift_mean`ï¼ˆå…¨é‡èšåˆå›å¡«ï¼‰
- âŒ `pair_gift_sum`ï¼ˆå…¨é‡èšåˆå›å¡«ï¼‰
- âŒ ä»»ä½•ç”¨ test æ•°æ®ç»Ÿè®¡çš„ç‰¹å¾

## 3.3 æ¨¡å‹

| å‚æ•° | Direct Regression | Two-Stage |
|------|------------------|-----------|
| æ¨¡å‹ | LightGBM | LightGBM (Stage1) + LightGBM (Stage2) |
| objective | regression | binary (Stage1) + regression (Stage2) |
| target | `log(1+Y)` æˆ– raw `Y` | Stage1: `Y > 0`; Stage2: raw `Y \mid Y > 0` |
| num_leaves | 31 | 31 |
| learning_rate | 0.05 | 0.05 |
| n_estimators | 500 (early stop) | 500 (early stop) |
| feature_fraction | 0.8 | 0.8 |
| bagging_fraction | 0.8 | 0.8 |

**Two-Stage å…³é”®æ”¹è¿›**ï¼š
- Stage2 é¢„æµ‹ **raw amount çš„æ¡ä»¶æœŸæœ›**ï¼ˆè€Œé logï¼‰ï¼Œç¡®ä¿ $p \times m$ é‡çº²æ­£ç¡®
- æˆ– Stage2 é¢„æµ‹ log ååšæ ¡å‡†ï¼š$\mu = \mathbb{E}[\log(1+Y)]$ â†’ æ˜ å°„ä¸º $\mathbb{E}[Y]$

## 3.4 è®­ç»ƒ

| å‚æ•° | å€¼ |
|------|-----|
| æ•°æ®åˆ‡åˆ† | æ—¶é—´åˆ‡åˆ†ï¼šå‰ 70% / ä¸­é—´ 15% / æœ€å 15% å¤© |
| early_stopping | 50 rounds |
| seed | 42 |
| ç‰¹å¾ç‰ˆæœ¬ | å†»ç»“ç‰ˆ + åœ¨çº¿æ»šåŠ¨ç‰ˆï¼ˆåˆ†åˆ«è®­ç»ƒï¼‰ |

## 3.5 è¯„ä¼°æŒ‡æ ‡

### 3.5.1 é¢„æµ‹æŒ‡æ ‡ï¼ˆä¿ç•™ï¼‰

- MAE(log) / MAE(raw)
- Spearman ç›¸å…³ç³»æ•°
- NDCG@100

### 3.5.2 å†³ç­–ç›¸å…³æŒ‡æ ‡ï¼ˆæ–°å¢ï¼‰

- **Revenue Capture@K**ï¼š$\text{RevShare@K} = \frac{\sum_{i \in \text{TopK}(\hat{v})} Y_i}{\sum_i Y_i}$
  - Top-1%, Top-5%, Top-10%
- **åˆ†æ¡¶æ ¡å‡†**ï¼šECE (Expected Calibration Error) / reliability curve
- **åˆ‡ç‰‡è¯„ä¼°**ï¼š
  - å†·å¯åŠ¨ pairï¼ˆtrain ä¸­ `pair_gift_count=0`ï¼‰
  - å†·å¯åŠ¨ streamerï¼ˆå†å²æ”¶ç¤¼=0ï¼‰
  - Top-1% ç”¨æˆ·ã€Top-10% ç”¨æˆ·ã€é•¿å°¾ç”¨æˆ·

### 3.5.3 å¯¹æ¯”åŸºå‡†

- **Baseline (gift-only, æœ‰æ³„æ¼)**ï¼šTop-1%=56.2%, Spearman=0.891
- **é¢„æœŸç›®æ ‡**ï¼šPast-only ç‰ˆæœ¬ Top-1% > 40%, Revenue Capture@1% > 50%

---

# 4. ğŸ“Š å›¾è¡¨ï¼ˆå¾…å®éªŒå®Œæˆåè¡¥å……ï¼‰

### Fig 1: Feature Importance Comparison (Frozen vs Rolling vs Original)
![](../img/leakage_free_feature_importance.png)

**é¢„æœŸè§‚å¯Ÿ**:
- Past-only ç‰ˆæœ¬çš„ `pair_gift_*` é‡è¦æ€§ä¸‹é™ï¼ˆä½†ä»å¯èƒ½æ˜¯ Top ç‰¹å¾ï¼‰
- å…¶ä»–ç‰¹å¾ï¼ˆç”¨æˆ·/ä¸»æ’­/ä¸Šä¸‹æ–‡ï¼‰é‡è¦æ€§ç›¸å¯¹æå‡

### Fig 2: Revenue Capture@K Curve
![](../img/leakage_free_revenue_capture.png)

**é¢„æœŸè§‚å¯Ÿ**:
- Revenue Capture@1% vs Top-1% Capture çš„å·®å¼‚
- å†»ç»“ç‰ˆ vs åœ¨çº¿æ»šåŠ¨ç‰ˆçš„å¯¹æ¯”

### Fig 3: Calibration Curve
![](../img/leakage_free_calibration.png)

**é¢„æœŸè§‚å¯Ÿ**:
- ECE å€¼ï¼ˆæœŸæœ› < 0.05ï¼‰
- åˆ†æ¡¶é¢„æµ‹ vs å®é™…åˆ†å¸ƒ

### Fig 4: Slice Analysis (Cold-start vs Warm)
![](../img/leakage_free_slice_analysis.png)

**é¢„æœŸè§‚å¯Ÿ**:
- å†·å¯åŠ¨ pair/streamer çš„æ€§èƒ½ä¸‹é™
- Top-1% ç”¨æˆ· vs é•¿å°¾ç”¨æˆ·çš„æ€§èƒ½å·®å¼‚

### Fig 5: Direct vs Two-Stage Comparison (Leakage-Free)
![](../img/leakage_free_direct_vs_twostage.png)

**é¢„æœŸè§‚å¯Ÿ**:
- Direct vs Two-Stage çš„ç›¸å¯¹å·®è·ï¼ˆå¤éªŒå…¬å¹³å¯¹æ¯”ç»“è®ºï¼‰
- è‹¥ Direct ä»å ä¼˜ï¼Œåˆ™ç»“è®ºç¨³å®š

---

# 5. ğŸ’¡ æ´è§

## 5.1 å®è§‚
- **åŸ baseline çš„"é«˜æ€§èƒ½"æ˜¯å‡è±¡**ï¼šTop-1% 56.2% å’Œ Spearman 0.891 å‡ ä¹å…¨éƒ¨æ¥è‡ªæ•°æ®æ³„æ¼
- **ç¤¼ç‰©é¢„æµ‹æ˜¯æå…¶å›°éš¾çš„ä»»åŠ¡**ï¼šå»é™¤æ³„æ¼åï¼Œæ¨¡å‹æ€§èƒ½æ¥è¿‘éšæœºï¼ˆSpearman 0.14ï¼‰
- **98.5% çš„ç¨€ç–æ€§æ˜¯æ ¸å¿ƒæŒ‘æˆ˜**ï¼šåœ¨å¦‚æ­¤æç«¯çš„ç±»ä¸å¹³è¡¡ä¸‹ï¼Œæ¨¡å‹å¾ˆéš¾å­¦åˆ°æœ‰æ•ˆä¿¡å·

## 5.2 æ¨¡å‹å±‚
- **ç‰¹å¾é‡è¦æ€§åˆ†å¸ƒå¥åº·**ï¼šæ¯”å€¼ 1.23 < 2xï¼Œè¯´æ˜ past-only ç‰¹å¾æˆåŠŸæ¶ˆé™¤äº†æ³„æ¼
- **Top ç‰¹å¾ä»æ˜¯ pair äº¤äº’**ï¼š`pair_last_gift_time_gap_past` å’Œ `pair_gift_mean_past` ä»æ˜¯æœ€é‡è¦ç‰¹å¾ï¼Œä½†é¢„æµ‹åŠ›æœ‰é™
- **Direct vs Two-Stage æ— æ˜¾è‘—å·®å¼‚**ï¼šä¸¤è€…åœ¨ä½æ€§èƒ½åŒºé—´éš¾ä»¥æ¯”è¾ƒ

## 5.3 ç»†èŠ‚
- **å†»ç»“ç‰ˆå®ç°æ­£ç¡®**ï¼šval/test åªæŸ¥ train lookup è¡¨ï¼Œæ— æ—¶é—´ç©¿è¶Š
- **æ•°æ®æ„é€ éªŒè¯é€šè¿‡**ï¼šY=0 å æ¯” 98.50%ï¼Œä¸ KuaiLive ç¨€ç–ç‡ä¸€è‡´
- **æ—¶é—´åˆ‡åˆ†æ­£ç¡®**ï¼šä¸¥æ ¼æŒ‰ timestamp æ’åºååˆ‡åˆ†

---

# 6. ğŸ“ ç»“è®º

## 6.1 æ ¸å¿ƒå‘ç°
> **æ•°æ®æ³„æ¼å·²æˆåŠŸæ¶ˆé™¤ï¼Œä½†æ­ç¤ºäº†ä¸€ä¸ªæ›´æ·±å±‚çš„é—®é¢˜ï¼šå½“å‰ç‰¹å¾ä½“ç³»å¯¹ç¤¼ç‰©é¢„æµ‹å‡ ä¹æ²¡æœ‰é¢„æµ‹èƒ½åŠ›ã€‚** åŸ baseline çš„é«˜æ€§èƒ½ï¼ˆTop-1% 56.2%ï¼‰æ˜¯"å¼€å·è€ƒè¯•"çš„ç»“æœâ€”â€”æ¨¡å‹é€šè¿‡æ³„æ¼çš„ `pair_gift_mean` ç›´æ¥"çœ‹åˆ°"äº†ç­”æ¡ˆã€‚

## 6.2 å…³é”®ç»“è®º
| # | ç»“è®º | è¯æ® |
|---|------|------|
| 1 | **æ•°æ®æ³„æ¼å·²æ¶ˆé™¤** | ç‰¹å¾é‡è¦æ€§æ¯”ä» 3x+ é™è‡³ 1.23 |
| 2 | **åŸ baseline æ€§èƒ½æ˜¯è™šå‡çš„** | å»é™¤æ³„æ¼å Top-1% ä» 56.2% é™è‡³ 11.6%ï¼ˆ-44.6ppï¼‰ |
| 3 | **å½“å‰ç‰¹å¾é¢„æµ‹åŠ›æå¼±** | Spearman ä» 0.891 é™è‡³ 0.14ï¼Œæ¥è¿‘éšæœº |
| 4 | **Gate-0 å¤±è´¥** | Top-1% 11.6% < 40%ï¼ŒRevenue Capture@1% 21.6% < 50% |
| 5 | **ç¤¼ç‰©é¢„æµ‹æœ¬èº«æå…·æŒ‘æˆ˜æ€§** | 98.5% ç¨€ç–æ€§ + æç«¯é‡å°¾åˆ†å¸ƒ |

## 6.3 è®¾è®¡å¯ç¤º
| åŸåˆ™ | å»ºè®® |
|------|------|
| **ç‰¹å¾å·¥ç¨‹éœ€è¦å…¨é¢é‡æ„** | å½“å‰ pair äº¤äº’ç‰¹å¾ä¸è¶³ä»¥æ”¯æ’‘é¢„æµ‹ï¼Œéœ€æ¢ç´¢æ–°ä¿¡å·æº |
| **è€ƒè™‘åºåˆ—/å®æ—¶ç‰¹å¾** | ç”¨æˆ·è§‚çœ‹æ—¶é•¿ã€å®æ—¶äº’åŠ¨ï¼ˆç‚¹èµ/è¯„è®ºï¼‰å¯èƒ½æ˜¯å…³é”®ä¿¡å· |
| **è€ƒè™‘é™ä½ä»»åŠ¡éš¾åº¦** | ä» EV é¢„æµ‹æ”¹ä¸ºäºŒåˆ†ç±»ï¼ˆæ˜¯å¦é€ç¤¼ï¼‰ï¼Œæˆ–ç¼©å°é¢„æµ‹çª—å£ |
| **è€ƒè™‘å†·å¯åŠ¨é—®é¢˜** | æ–° pair æ— å†å²æ•°æ®ï¼Œéœ€æ¢ç´¢ user/streamer ä¾§æ³›åŒ–ç‰¹å¾ |

## 6.4 å…³é”®æ•°å­—

### Frozen ç‰ˆæœ¬ï¼ˆä¸¥æ ¼æ— æ³„æ¼ âœ…ï¼‰
| æŒ‡æ ‡ | Direct | Two-Stage | è¯´æ˜ |
|------|--------|-----------|------|
| Top-1% Capture | **11.5%** | 11.8% | ç›®æ ‡ > 40% âŒ |
| Revenue Capture@1% | **21.3%** | 25.6% | ç›®æ ‡ > 50% âŒ |
| Spearman | **0.103** | 0.095 | vs Baseline 0.891 |
| ç‰¹å¾é‡è¦æ€§æ¯” | **1.23** | - | < 2x âœ… æ— æ³„æ¼ |

### Rolling ç‰ˆæœ¬ï¼ˆâš ï¸ å¯èƒ½æœ‰å®ç°é—®é¢˜ï¼‰
| æŒ‡æ ‡ | Direct | Two-Stage | è¯´æ˜ |
|------|--------|-----------|------|
| Top-1% Capture | 81.1% | 67.3% | âš ï¸ å¼‚å¸¸é«˜ |
| Revenue Capture@1% | 98.7% | 99.1% | âš ï¸ å¼‚å¸¸é«˜ |
| Spearman | 0.523 | 0.219 | - |
| Stage1 AUC | - | 0.9989 | âš ï¸ è¿‘ä¹å®Œç¾ï¼Œç–‘ä¼¼æ³„æ¼ |

> **âš ï¸ è­¦å‘Š**ï¼šRolling ç‰ˆæœ¬æ€§èƒ½å¼‚å¸¸é«˜ï¼ˆ81.1% vs Frozen 11.5%ï¼‰ï¼Œè¡¨æ˜ cumsum+shift å®ç°å¯èƒ½å­˜åœ¨æ—¶é—´æ³„æ¼ã€‚**ä»¥ Frozen ç‰ˆæœ¬ä¸ºå‡†**ã€‚

### å…¶ä»–éªŒè¯
| æŒ‡æ ‡ | å€¼ | è¯´æ˜ |
|------|-----|------|
| Y=0 å æ¯” | **98.50%** | ä¸ KuaiLive ç¨€ç–ç‡ä¸€è‡´ âœ… |
| æ—¶é—´åˆ‡åˆ† | Train < Val < Test | ä¸¥æ ¼æŒ‰ timestamp âœ… |

## 6.5 ä¸‹ä¸€æ­¥
| æ–¹å‘ | ä»»åŠ¡ | ä¼˜å…ˆçº§ |
|------|------|--------|
| **é‡æ–°è®¾è®¡ç‰¹å¾** | æ¢ç´¢åºåˆ—ç‰¹å¾ï¼ˆè§‚çœ‹æ—¶é•¿åºåˆ—ï¼‰ã€å®æ—¶ç‰¹å¾ï¼ˆå½“å‰ session äº’åŠ¨ï¼‰ã€å†…å®¹ç‰¹å¾ï¼ˆç›´æ’­å†…å®¹åŒ¹é…åº¦ï¼‰ | ğŸ”´ æœ€é«˜ |
| **ä»»åŠ¡é™çº§éªŒè¯** | å…ˆéªŒè¯äºŒåˆ†ç±»ï¼ˆP(gift>0)ï¼‰æ˜¯å¦å¯è¡Œï¼Œå†è€ƒè™‘é‡‘é¢é¢„æµ‹ | ğŸ”´ æœ€é«˜ |
| **æ•°æ®å¢å¼º** | æ¢ç´¢æ˜¯å¦æœ‰å…¶ä»–æ•°æ®æºï¼ˆå¦‚ç‚¹èµã€è¯„è®ºã€å…³æ³¨è¡Œä¸ºï¼‰å¯ä½œä¸ºç‰¹å¾ | ğŸŸ¡ |
| **å†·å¯åŠ¨ç­–ç•¥** | å¯¹æ— å†å² pairï¼Œè®¾è®¡åŸºäº user/streamer çš„æ³›åŒ–ç‰¹å¾ | ğŸŸ¡ |
| **æ¨¡æ‹Ÿå™¨è·¯å¾„** | è‹¥ç‰¹å¾å·¥ç¨‹æ— æ³•çªç ´ï¼Œè€ƒè™‘ç”¨æ¨¡æ‹Ÿå™¨åšç­–ç•¥è¯„ä¼°ï¼ˆç»•è¿‡é¢„æµ‹ï¼‰ | ğŸŸ¢ |

---

# 7. ğŸ“ é™„å½•

## 7.1 å®éªŒè®¾è®¡å‚è€ƒ

**ä¸Šæ¸¸åˆ†ææ¥æº**ï¼š
- ç”¨æˆ·æä¾›çš„è¯¦ç»†åˆ†æï¼ˆ2026-01-18ï¼‰ï¼šæŒ‡å‡º baseline çš„æ•°æ®æ³„æ¼ã€ä»»åŠ¡ä¸åŒ¹é…ã€è¯„ä¼°æŒ‡æ ‡åå·®é—®é¢˜

**å…³é”®è®¾è®¡åŸåˆ™**ï¼š
1. **Past-Only ç‰¹å¾**ï¼šæ‰€æœ‰èšåˆç‰¹å¾å¿…é¡»æ˜¯ impression æ—¶åˆ»ä¹‹å‰å¯å¾—
2. **Click-Level EV**ï¼šé¢„æµ‹åŒ…å« 0 çš„æœŸæœ›æ”¶ç›Šï¼Œè€Œé"å·²é€ç¤¼æ¡ä»¶ä¸‹çš„é‡‘é¢"
3. **Revenue Capture@K**ï¼šç”¨æ”¶å…¥å æ¯”è€Œéé›†åˆé‡å è¯„ä¼°

## 7.2 æ‰§è¡Œè®¡åˆ’

| æ­¥éª¤ | ä»»åŠ¡ | è¾“å‡º | éªŒæ”¶æ£€æŸ¥ |
|------|------|------|----------|
| **1** | **æ„é€  click-level æ•°æ®é›†ï¼ˆå« 0ï¼‰** | `data/click_with_gift_label.csv` | æ ·æœ¬æ•° ~4.9Mï¼ŒY=0 å æ¯” ~98.5% |
| 2 | å®ç°å†»ç»“ç‰ˆ past-only ç‰¹å¾ | `scripts/build_frozen_features.py` | åªç”¨ train window ç»Ÿè®¡ |
| 3 | å®ç°åœ¨çº¿æ»šåŠ¨ç‰ˆ past-only ç‰¹å¾ | `scripts/build_rolling_features.py` | cumsum + shift(1) |
| 4 | è®­ç»ƒ Direct Regressionï¼ˆå†»ç»“ç‰ˆï¼‰ | `models/direct_frozen.pkl` | - |
| 5 | è®­ç»ƒ Direct Regressionï¼ˆæ»šåŠ¨ç‰ˆï¼‰ | `models/direct_rolling.pkl` | - |
| 6 | è®­ç»ƒ Two-Stageï¼ˆå†»ç»“ç‰ˆï¼‰ | `models/twostage_frozen.pkl` | - |
| 7 | è®­ç»ƒ Two-Stageï¼ˆæ»šåŠ¨ç‰ˆï¼‰ | `models/twostage_rolling.pkl` | - |
| **8** | **è¯„ä¼°ï¼šRevenue Capture@K, æ ¡å‡†, åˆ‡ç‰‡** | `results/leakage_free_eval.json` | è§éªŒæ”¶æ ‡å‡† |
| **9** | **ç‰¹å¾é‡è¦æ€§åˆ†æ** | `results/feature_importance.csv` | æœ€é«˜/ç¬¬äºŒ < 2x |
| **10** | **å¯¹æ¯”åˆ†æ** | `results/comparison_report.md` | ç¡®è®¤ Gate-0, Gate-1 |

### å…³é”®éªŒæ”¶æ£€æŸ¥æ¸…å•

| æ£€æŸ¥é¡¹ | é€šè¿‡æ ‡å‡† | å®é™…ç»“æœ | çŠ¶æ€ |
|--------|----------|----------|------|
| æ•°æ®æ„é€ æ­£ç¡® | Y=0 å æ¯” ~98.5% | **98.50%** | âœ… |
| Past-only ç‰¹å¾æ— æ³„æ¼ | æœ€é«˜/ç¬¬äºŒ < 2x | **1.23** | âœ… |
| ç‰¹å¾é‡è¦æ€§æ­£å¸¸ | æ— å•ä¸€ç‰¹å¾ä¸»å¯¼ | åˆ†å¸ƒå¥åº· | âœ… |
| Revenue Capture@K è®¡ç®—æ­£ç¡® | å…¬å¼æ­£ç¡® | å·²å®ç°éªŒè¯ | âœ… |
| æ—¶é—´åˆ‡åˆ†æ­£ç¡® | ä¸¥æ ¼æŒ‰ timestamp | Train < Val < Test | âœ… |
| **Gate-0: æ€§èƒ½è¾¾æ ‡** | Top-1% > 40%, RevCap@1% > 50% | 11.6%, 21.6% | âŒ |

## 7.3 ç›¸å…³æ–‡ä»¶

- ä¸Šæ¸¸å®éªŒï¼š`exp_baseline_20260108.md`
- å…¬å¹³å¯¹æ¯”å®éªŒï¼š`exp_fair_comparison_20260108.md`
- Hub é“¾æ¥ï¼š`../gift_EVmodel_hub.md` Â§ Q1.1, Q2.1

---

> **å®éªŒè®¡åˆ’åˆ›å»ºæ—¶é—´**: 2026-01-18
> **å®éªŒå®Œæˆæ—¶é—´**: 2026-01-18
> **çŠ¶æ€**: âœ… å·²å®Œæˆ
> **Gate-0 ç»“æœ**: âŒ å¤±è´¥ï¼ˆæ³„æ¼å·²æ¶ˆé™¤ï¼Œä½†æ€§èƒ½ä¸è¾¾æ ‡ï¼‰
