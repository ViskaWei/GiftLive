# Simulator V2 增强：离散档位校准 — 5min 汇报

> **Experiment**: VIT-20260109-gift_allocation-14  \
> **Author**: Viska Wei  \
> **Date**: 2026-01-09  \
> **Language**: 中文

---

## V2+ 离散档位：P50/P90/Mean 误差 <30% — Gate-4A 通过

- **目的**：V1 金额分布严重失真（P50 误差 2163%），引入离散档位校准。成功标准：误差 <30%
- **X 一句话**：$X := \underbrace{\text{离散档位模型}}_{\text{V2+ 金额分布}}\;\xrightarrow{\text{真实礼物价格档}}\;\underbrace{\text{P50/P90/Mean 校准}}_{\text{误差<30\%}}$
  - Why: V1 用连续分布，但真实礼物是固定价格档
  - How: Categorical 分布选择档位，财富/匹配度调节概率
- **I/O（带符号）**：输入档位配置，输出金额分布，核心校准是「分位数误差」

| 类型 | 符号 | 说明 | 示例 |
|------|------|------|------|
| 🫐 输入 | tiers | 10 级档位 | (1,2,10,52,100,520,1000,1314,5200,13140) |
| 🫐 输入 | $\pi_k$ | 档位概率 | 财富调节后 softmax |
| 🫐 输出 | amounts | 生成金额 | [1, 10, 52, 100, ...] |
| 📊 指标 | P50, P90, Mean | 分位数 | 2.0 / 68.1 / 60.7 |
| 🍁 基线 | V1/V2 | 连续分布 | P50 误差 2163%/55% |

<details>
<summary><b>note</b></summary>

今天分享 Simulator V2 增强实验。

核心结论是：**V2+ 离散档位模型成功校准金额分布**，P50/P90/Mean 误差均 <30%，Gate-4A 通过。

V1 的问题是：用 lognormal 连续分布生成金额，但真实礼物是固定价格档（1/2/10/52/100/520/1000/1314/5200/13140）。这导致 P50 误差高达 2163%。

解决方法是离散档位模型：用 Categorical 分布直接抽取真实档位，财富越高的用户更可能选高档礼物。

看 I/O 表：输入是 10 级档位配置，输出是生成金额。我们需要校准 P50、P90、Mean 三个分位数指标。

</details>

---

## 离散 Categorical 分布 + 校准流程 + 关键结果

- **算法**：离散档位选择，财富调节概率

$$\text{tier}_k \sim \text{Categorical}(\pi_1, \pi_2, ..., \pi_{10})$$
$$\pi_k = \text{softmax}\left( \log(p_k^{(\text{base})}) + \alpha_w \cdot \log(w_u) \cdot \frac{k}{K} \right)$$

**档位设计（基于 KuaiLive 数据）**：

| 档位 | 金额 | 基础概率 | 备注 |
|------|------|----------|------|
| 1-2 | 1, 2 | 0.38, 0.32 | 小额（70%） |
| 3-5 | 10, 52, 100 | 0.15, 0.08, 0.04 | 中额 |
| 6-10 | 520-13140 | 0.02-0.0005 | 大额（稀有） |

- **流程（4 步）**：
```
校准流程
├── 1. 初始化 3 版模拟器
│   └── V1(lognormal) / V2(lognormal+pareto) / V2+(离散)
├── 2. 核心循环 ⭐
│   ├── × 50 次模拟 × 50 轮 × 200 用户
│   └── 用户到达 → Greedy 分配 → 观察打赏
│       └── 单步输出: {'user_id': 0, 'streamer_id': 42, 'did_gift': True, 'amount': 52.0}
├── 3. 循环输出 + 计算分位数
│   └── trajectory = [{...}, ...] → P50=2.0/P90=68.1/Mean=60.7
└── 4. 校准对比
    └── 目标: P50=2, P90=88, Mean=82.7 → 误差 0%/23%/27%
```

- **结果**：

| Version | P50 误差 | P90 误差 | Mean 误差 | 判定 |
|---------|----------|----------|-----------|------|
| V1 | 2163% | 496% | 322% | ❌ |
| V2 | 55% | 29% | 375% | ❌ |
| **V2+** | **0%** | **23%** | **27%** | ✅ Gate-4A Pass |

<details>
<summary><b>note</b></summary>

算法核心是 Categorical 分布：用 softmax 将基础概率转换为调节后概率。财富高的用户 α_w·log(w_u) 项更大，更可能选高档礼物。

档位设计基于真实数据：70% 是 1-2 元小额礼物，体现"小额刷存在感"的行为模式。520、1314 这些有特殊寓意（我爱你、一生一世）。

校准流程：3 个版本对比，50 次模拟取平均，计算分位数误差。

看结果表——**V2+ 全面胜出**：
- P50 误差 0%（完美校准，P50=2 刚好是离散档位）
- P90 误差 23%（<30% 阈值）
- Mean 误差 27%（<30% 阈值）

V2 尝试用 lognormal+pareto 混合，但 Mean 误差 375%——Pareto 尾部太重，拉高了均值。

</details>

---

## 离散档位比连续分布更适合礼物场景 — 决策：采用 V2+

- **结论**：「真实礼物有固定价格档，离散模型比连续分布更准确」
  - 机制层：Pareto 尾部在礼物场景过于极端，导致 Mean 被拉高
  - 证据层：V2+ Mean 误差 27% vs V2 375%
- **决策**：✅ **Gate-4A PASS → 采用 V2+，继续 MVP-4.2**
  - 三个关键指标（P50/P90/Mean）误差均 <30%
- **权衡**：分位数准确（赚到），离散化损失精度（可接受）
- **配置建议**：
  - `amount_version = 3`（启用 V2+ 离散档位）
  - `wealth_scale = 0.10`（财富效应强度）
- **下一步**：
  - 🔴 P0: 继续 MVP-4.2 并发容量建模
  - 🟡 P1: 进一步校准 P99（当前误差 33%）
  - 🟢 P2: 将 V2+ 设为默认 amount_version

<details>
<summary><b>note</b></summary>

金句是：**真实礼物有固定价格档，离散模型比连续分布更准确**。

直播平台的礼物都是固定价格：1 元鲜花、10 元棒棒糖、520 我爱你……用连续分布生成 45.3 元的礼物，根本不存在。离散档位模型直接抽取真实价格，自然更准确。

V2 尝试用 Pareto 模拟大额礼物，但 Pareto 分布太极端了。在礼物场景，即使是"土豪"也不会送 10 万元的礼物——但 Pareto 会生成这样的极端值，导致 Mean 被严重拉高。

决策：**采用 V2+**。设置 amount_version=3 启用离散档位，wealth_scale=0.10 控制财富效应。

下一步：Gate-4A 通过，继续 MVP-4.2 并发容量建模。

</details>
