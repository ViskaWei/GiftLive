# 鲸鱼分层匹配：Gate-5C FAIL — 5min 汇报

> **Experiment**: VIT-20260109-gift_allocation-53  \
> **Author**: Viska Wei  \
> **Date**: 2026-01-09  \
> **Language**: 中文

---

## 分层匹配未降低 Gini，所有 k 值结果相同 — Gate-5C 未通过

- **目的**：分层匹配策略能否分散鲸鱼用户，降低生态集中度？成功标准：超载率 <10% + Gini↓ + 收益 >-5%
- **X 一句话**：$X := \underbrace{\text{分层匹配}}_{\text{鲸鱼+普通分层}}\;\xrightarrow{\text{b-matching 约束}}\;\underbrace{\text{分散鲸鱼}}_{\text{降低集中度}}$
  - Why: 鲸鱼同时涌入导致头部主播过载、马太效应
  - How: 先 b-matching 分配鲸鱼（每主播最多 k 个），再 Greedy 填充普通用户
- **I/O（带符号）**：输入鲸鱼识别 + k 约束，输出分配结果 + 集中度指标

| 类型 | 符号 | 说明 | 示例 |
|------|------|------|------|
| 🫐 输入 | $W$ | 鲸鱼集合 | Top 1% 财富，100 人 |
| 🫐 输入 | $k$ | 每主播鲸鱼上限 | 1, 2, 3, 5 |
| 🫐 输出 | allocations | 分配结果 | 鲸鱼层 + 普通层 |
| 📊 指标 | $G, \text{overload}$ | Gini/超载率 | 0.912 / 0.0% |
| 🍁 基线 | Greedy | 无分层 | Gini=0.912 |

<details>
<summary><b>note</b></summary>

今天分享鲸鱼分层匹配实验。

核心结论是：**Gate-5C FAIL**。分层匹配未能降低生态集中度，所有 k 值配置下 Gini 与基线完全相同（0.912）。

我们想解决的问题是：鲸鱼用户（Top 1% 财富）同时涌入头部主播，导致过载和马太效应。能不能把鲸鱼分散到更多主播？

方法是分层匹配：
1. **鲸鱼层**：b-matching 约束，每主播最多 k 个鲸鱼
2. **普通层**：Greedy 填充剩余容量

看 I/O 表：输入是鲸鱼识别和 k 约束，输出是分配结果。我们测试了 k=1,2,3,5 四个配置。

</details>

---

## b-matching 分层 + 实验流程 + 关键结果

- **算法**：鲸鱼层 b-matching 约束，普通层 Greedy 填充

$$\text{whale\_alloc} = \arg\max_{\pi} \sum_{u \in W} \sum_s \pi_{u,s} \cdot EV(u,s)$$
$$\text{s.t.} \quad \sum_{u \in W} \pi_{u,s} \leq k, \quad \forall s$$

- **流程（4 步）**：
```
实验流程
├── 1. 识别鲸鱼
│   └── Top 1% 财富 → whale_ids (100 人)
├── 2. 鲸鱼层：b-matching
│   └── 每主播最多 k 个鲸鱼
├── 3. 普通层：Greedy 填充
│   └── 剩余容量分配普通用户
└── 4. 评估
    └── Gini / 超载率 / Revenue
```

**失败原因分析**：
```python
# 鲸鱼数量太少！
n_whales = 100  # Top 1%
n_streamers = 500
avg_whales_per_streamer = 100 / 500 = 0.2  # 平均每主播 <1 个鲸鱼

# 即使 k=1，约束也几乎不生效
# 因为每个主播本来就分不到 1 个鲸鱼
```

- **结果**：

| 配置 | 超载率 | Gini | Revenue Δ | k 影响 |
|------|--------|------|-----------|--------|
| Baseline | 0.28% | 0.912 | 0% | - |
| k=1 | **0.0%** | 0.912 | +0.07% | **无** |
| k=2 | **0.0%** | 0.912 | +0.07% | **无** |
| k=5 | **0.0%** | 0.912 | +0.07% | **无** |

<details>
<summary><b>note</b></summary>

算法核心是分层：鲸鱼先分配（b-matching 约束），普通用户后填充（Greedy）。

实验流程很直接：识别鲸鱼 → b-matching 分配 → Greedy 填充 → 评估。

**但结果出乎意料**——所有 k 值下，Gini 都是 0.912，与基线完全相同！

为什么？看失败原因分析：
- **鲸鱼数量太少**：Top 1% 只有 100 人，500 个主播平均每个只有 0.2 个鲸鱼
- 即使 k=1，约束也几乎不生效——因为每个主播本来就分不到 1 个鲸鱼
- 普通用户（9900 人）仍然 Greedy 堆叠到头部主播，决定了最终 Gini

超载率确实降到 0%，但这是因为容量本来就足够，不是分层匹配的功劳。

</details>

---

## 鲸鱼占比太少，分散效果不明显 — 决策：保留统一分配

- **结论**：「Top 1% 鲸鱼仅 100 人，分散到 500 主播后对 Gini 无影响」
  - 机制层：普通用户（9900 人）仍 Greedy 堆叠到头部，决定了 Gini
  - 证据层：所有 k 值下 Gini=0.912，与基线完全相同
- **决策**：❌ **Gate-5C FAIL → 保留统一分配，分层匹配需重新设计**
  - ✅ 超载率 0.0% < 10% 目标
  - ❌ Gini 无改善
  - ✅ 收益 +0.07% > -5% 目标
- **权衡**：分层逻辑增加复杂度，但当前设置下无效果
- **改进方向**：
  - 降低容量设置，触发拥挤场景
  - 测试 Top 5% 而非 Top 1%（扩大"鲸鱼"定义）
  - 考虑基于收益的分散而非基于数量
- **下一步**：
  - ❌ FAIL: 保留统一分配
  - 🟡 P1: 降低容量设置，测试 Top 5% 鲸鱼阈值
  - 🟡 P1: 考虑基于收益的分散策略

<details>
<summary><b>note</b></summary>

金句是：**Top 1% 鲸鱼仅 100 人，分散到 500 主播后对 Gini 无影响**。

这个失败很有启发性。我们本来以为分散鲸鱼能改善生态，但忽略了一个关键问题：**鲸鱼占比太少**。

100 个鲸鱼分散到 500 个主播，每主播平均 0.2 个。b-matching 约束 k=1 都触发不了。而决定 Gini 的是 9900 个普通用户的分配，他们仍然 Greedy 堆叠到头部。

算法选择也无所谓——b-matching 和 greedy-swaps 结果完全相同。问题不在算法，而在策略本身。

改进方向：
1. **扩大鲸鱼定义**：Top 5% 而非 Top 1%
2. **降低容量**：让拥挤场景出现
3. **换策略**：不按数量分散，按收益分散

决策：Gate-5C FAIL，保留统一分配。分层匹配需要重新设计才有可能生效。

</details>
