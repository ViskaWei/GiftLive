# 延迟数据审计：发现 Bug，DG2 关闭确认 — 5min 汇报

> **Experiment**: VIT-20260108-gift_allocation-13  \
> **Author**: Viska Wei  \
> **Date**: 2026-01-08  \
> **Language**: 中文

---

## 审计通过 + 发现代码 Bug — 延迟校正方向关闭

- **目的**：MVP-1.2 延迟实验存在红旗警告，审计确认 DG2（延迟校正无价值）结论是否成立
- **X 一句话**：$X := \underbrace{\text{数据审计}}_{\text{一致性校验}}\;\xrightarrow{\text{四项检查}}\;\underbrace{\text{确认 DG2 结论}}_{\text{延迟校正无价值}}$
  - Why: MVP-1.2 有红旗（样本数差异、口径矛盾）
  - How: 四项审计：样本数、口径定义、0 延迟分析、匹配质量
- **I/O（带符号）**：输入 click + gift 数据，输出审计报告，核心判定是「数据是否可信」

| 类型 | 符号 | 说明 | 示例 |
|------|------|------|------|
| 🫐 输入 | click.csv | 点击记录 | 72,646 行 |
| 🫐 输入 | gift.csv | 礼物记录 | 77,824 配对 |
| 🫐 输出 | 审计报告 | 四项检查结果 | 发现 ms/sec Bug |
| 📊 指标 | pass/fail | 数据正确性 | ✅ 通过 |
| 🍁 基线 | MVP-1.2 | 原始结果 | pct_late=68.8%（错误） |

<details>
<summary><b>note</b></summary>

今天分享延迟数据审计实验。

核心结论是：**审计通过 + 发现并修复代码 Bug**。修正后 pct_late_50=13.3%，DG2 延迟校正方向关闭确认。

背景是 MVP-1.2 有红旗警告：样本数 72,646 vs 77,824 差异、pct_late_50=68.8% 异常高。我们需要审计确认数据是否可信。

审计方法是四项检查：样本数一致性、口径定义、零延迟分析、匹配质量。

看 I/O 表：输入是 KuaiLive 的 click 和 gift 数据，输出是审计报告。

</details>

---

## 发现 ms/sec 单位 Bug + 审计流程 + 关键发现

- **算法**：无特定算法，纯数据审计

- **流程（4 项审计）**：
```
审计流程
├── 🚩1. 样本数一致性
│   └── gift 72,646 vs click 77,824 → 膨胀比例分析
├── 🚩2. 口径定义（关键！）
│   └── pct_late_* 计算逻辑 → 发现 ms/sec 单位 Bug！
├── 🚩3. 零延迟分析
│   └── 86.3% delay=0 → watch_time 分布合理性
└── 🚩4. 匹配质量
    └── gift→click 一对一率 → 92.6% 正常
```

**Bug 发现（核心）**：
```python
# ❌ 原代码错误
relative_delay = delay_sec / watch_time  # watch_time 是 ms！
pct_late_50_buggy = 68.8%

# ✅ 修复后
watch_time_sec = watch_time / 1000
pct_late_50_fixed = 13.3%  # 正确！
```

- **结果**：

| 审计项 | 结果 | 说明 |
|--------|------|------|
| 🚩1 样本数 | ✅ 1.14x 膨胀可解释 | gift×click 配对导致 |
| 🚩2 pct_late | ✅ **修复 Bug**: 68.8% → 13.3% | ms/sec 单位错误 |
| 🚩3 0 延迟 | ✅ 86.3% 合理 | 即时打赏为主 |
| 🚩4 匹配 | ✅ 92.6% 一对一 | 匹配质量良好 |

<details>
<summary><b>note</b></summary>

审计流程四项检查。

第一项，样本数：gift 72,646 vs 配对后 77,824，膨胀 1.14x。原因是用户可能在同一直播间多次进出，一个 gift 匹配多个 click session。92.6% 是一对一，0.3% 多匹配。这是正常的。

**第二项是关键发现**：我们审查 pct_late 计算代码，发现 watch_time 单位是毫秒，但被当作秒使用。这导致 pct_late 从 68.8% 误报为异常高。修复后是 13.3%——合理多了。

第三项，86.3% 的礼物 delay=0，说明大多数打赏是即时冲动行为。这符合直播打赏的特性。

第四项，匹配质量 92.6% 一对一，良好。

结论：四项审计全部通过，DG2 延迟校正无价值的结论仍然成立。

</details>

---

## 86.3% 即时打赏 — 决策：DG2 关闭确认，延迟校正无价值

- **结论**：「直播打赏是即时冲动行为，延迟校正假设不适用」
  - 机制层：86.3% 礼物 delay=0，用户进来就送礼
  - 证据层：修复后 pct_late_50=13.3%（远低于错误的 68.8%）
- **决策**：✅ **DG2 关闭确认 → 延迟校正方向彻底关闭**
  - 延迟反馈假设来自广告场景，不适用于直播打赏
- **权衡**：发现隐藏 Bug（赚到），额外审计时间（值得）
- **教训**：
  - 数值异常应立即触发代码审查
  - ms vs sec 单位混用是常见 Bug
- **下一步**：
  - ✅ 完成: DG2 关闭确认
  - ❌ 取消: 伪在线验证（延迟问题不存在）
  - 🟡 P1: 继续 MVP-1.5 或 MVP-1.3

<details>
<summary><b>note</b></summary>

金句是：**直播打赏是即时冲动行为，延迟校正假设不适用**。

86.3% 的礼物在进入直播间后立即发生（delay=0）。这完全不同于广告场景——广告用户可能几天后才转化。直播打赏是冲动消费，用户觉得主播好玩，立刻就送礼。

所以 Chapelle 延迟校正方法在这里没用。我们验证了 DG2 结论：延迟校正无价值。

审计还有一个意外收获：发现了代码 Bug。watch_time 单位 ms 被当作 sec，导致 pct_late 虚高到 68.8%。修复后是 13.3%。

教训是：**数值异常应立即触发代码审查**。68.8% 太高了，应该怀疑而不是接受。

下一步：DG2 关闭，取消伪在线验证，继续其他 MVP。

</details>
