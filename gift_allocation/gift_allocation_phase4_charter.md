# 📋 Gift Allocation Phase 4 立项书

> **Status:** 📝 立项中 | **Date:** 2026-01-09 | **Author:** Viska Wei

---

## 1. 🎯 问题回顾

### 1.1 核心挑战（来自 README）

| 挑战 | 描述 | Phase 0-3 进展 | 残留问题 |
|------|------|----------------|----------|
| **稀疏与重尾** | 打赏极稀疏(1.48%)、重尾(Gini=0.94)、高方差 | ✅ 离线基本解决 | 极端尾部风险控制 |
| **延迟反馈** | 进房后很久才打赏 / 多次打赏 | ✅ 非主要问题 (86.3%立即发生) | 无 |
| **资源约束** | 大哥稀缺、主播承接上限、避免过度集中 | ⚠️ 部分解决 (仿真中) | **缺乏真实容量/并发建模** |

### 1.2 Phase 0-3 核心结论

| 层 | 方法 | 性能 | 状态 |
|----|------|------|------|
| 估计层 | Direct Regression (LightGBM) | Top-1%=54.5% | ✅ 闭环 |
| 分配层 | Greedy + 软约束冷启动 | 收益+32% | ⚠️ 仿真验证 |
| 评估层 | SNIPS OPE | RelErr<10% | ✅ 可用 |

### 1.3 Phase 4 核心命题

> **"资源约束问题"在模拟器中仅做近似，尚未有效解决真实场景的：**
> 1. 主播并发承载上限与拥挤外部性
> 2. 鲸鱼（大哥）的互斥分配与分散
> 3. 长期生态健康（留存/满意度）
> 4. 金额分布的准确校准（V1 误差大）

---

## 2. 🏆 Phase 4 目标

### 2.1 总体目标

**构建更逼真的模拟环境 + 更优的分配策略，为未来在线验证做准备**

### 2.2 具体目标

| 目标 | 度量 | 阈值 |
|------|------|------|
| G1: Simulator V2 金额分布校准 | 分位数误差 (P50/P90/P99) | < 30% |
| G2: Simulator V2 并发容量建模 | 拥挤效应可观测 | 收益随并发边际递减 |
| G3: 召回-精排分工 | Top-1% Capture (整体) | ≥ 56% (+1.5pp) |
| G4: 供需匹配/影子价格 | 收益 vs Greedy | ≥ +5% |
| G5: 鲸鱼分散策略 | 头部主播超载率 | < 10% |
| G6: 不确定性排序 | 尾部风险 (CVaR) | 改善 |

### 2.3 非目标 (Not Goals)

- ❌ 在线 A/B 测试（无线上流量）
- ❌ 深度学习模型替换（现有 LightGBM 足够）
- ❌ 实时推荐系统工程（专注算法验证）

---

## 3. 📊 MVP 规划

### 3.1 MVP 列表

| MVP | 名称 | 优先级 | 依赖 | 预期产出 |
|-----|------|--------|------|----------|
| **4.1+** | Simulator V2 - 增强版 | 🔴 P0 | - | 离散档位+预算+社交+时序，误差<30% |
| **4.2** | Simulator V2 - 并发容量 | 🔴 P0 | 4.1+ | 拥挤外部性可观测 |
| **4.3** | 召回-精排分工 | 🟡 P1 | - | Top-1% ≥56% |
| **4.4** | 供需匹配/影子价格 | 🟡 P1 | 4.2 | 收益+5% |
| **4.5** | 鲸鱼分散 (b-matching) | 🟢 P2 | 4.2 | 超载率<10% |
| **4.6** | 不确定性排序 (UCB) | 🟢 P2 | - | CVaR 改善 |
| **4.7** | 多目标生态调度 | 🟢 P2 | 4.4 | Pareto 前沿 |

### 3.2 依赖关系

```
4.1+ 增强校准 ──┬── 4.2 并发容量 ──┬── 4.4 供需匹配
               │                  │
               │                  └── 4.5 鲸鱼分散
               │
               └── 4.3 召回-精排 (独立)

4.6 不确定性排序 (独立)

4.7 多目标调度 ←── 4.4 供需匹配
```

---

## 4. 📝 详细设计

### 4.1+ MVP-4.1+: Simulator V2 - 增强版

**问题**: V1 金额分布误差大（P50: 285%, Mean: 111%, Top-1% Share: 62%）

**根因分析** (来自问题分析):
| V1 缺陷 | 真实场景 | 影响 |
|---------|---------|------|
| 连续金额分布 | 礼物有固定价格档 | 金额分布失真 |
| 无预算约束 | 用户有日/周预算 | Top-1% Share 过高 |
| 用户独立 | 社交效应：跟风/挤出 | 打赏模式不真实 |
| 单次交互 | 同一 session 多次打赏 | Gift Rate 偏差 |

**V2 四大核心机制**:

1. **离散金额档位**: `gift_tiers = [1, 10, 52, 100, 520, 1000, 1314, 5200, 13140]`
2. **用户预算约束**: 日预算 + 剩余预算追踪
3. **社交效应**: 羊群效应 (α=0.1) + 挤出效应 (β=0.05)
4. **Session 时序建模**: 模拟完整观看 session 的多次打赏

**验收标准**:
| 指标 | V1 误差 | V2 目标 |
|------|---------|---------|
| P50 | 285% | < 30% |
| P90 | 122% | < 30% |
| Amount Mean | 111% | < 30% |
| Top-1% Share | 62% | < 15% |
| User Gini | 5% | < 5% |

**实验报告**: [exp_simulator_v2_20260109.md](./exp/exp_simulator_v2_20260109.md)

### 4.2 MVP-4.2: Simulator V2 - 并发容量

**问题**: V1 无主播承载上限，无法建模"过度集中导致体验损伤"

**方法**:
1. 主播并发容量 $C_s$：每时刻最多服务 $C_s$ 用户
2. 拥挤外部性：$r_{us} = r_{us}^{base} \cdot g(n_s / C_s)$，其中 $g$ 递减
3. 排队/溢出机制：超过容量的用户被拒绝或降级体验

**参数设计**:
```python
# 并发容量 (按主播热度分层)
capacity = {
    "top_10%": 100,
    "middle": 50,
    "tail": 20
}

# 拥挤惩罚函数
def crowding_penalty(n_current, capacity):
    """当并发超过容量时，收益边际递减"""
    if n_current <= capacity:
        return 1.0
    else:
        return 1.0 / (1 + 0.5 * (n_current - capacity) / capacity)
```

**验收标准**:
- 观测到收益随并发边际递减
- 头部主播在高并发时收益饱和

### 4.3 MVP-4.3: 召回-精排分工

**问题**: Direct 全量排序强，Two-Stage 金主内排序强，如何结合？

**方法**:
1. **召回阶段**: Direct Regression 对全量 click 打分，取 Top-M (M=100-500)
2. **精排阶段**: Two-Stage 的 $m(x)$ 在召回集上重排

**实验设计**:
| 参数 | 范围 | 说明 |
|------|------|------|
| M (召回数) | [50, 100, 200, 500] | 召回规模 |
| 精排模型 | Stage2 m(x) vs Direct | 对比 |

**验收标准**:
- Top-1% Capture ≥ 56% (+1.5pp vs Direct-only)
- NDCG@10 ≥ 0.4 (+0.1 vs Direct)

### 4.4 MVP-4.4: 供需匹配/影子价格贪心

**问题**: 纯贪心不考虑约束，凹收益效果不显著

**方法**:
拉格朗日对偶分配：
$$s^* = \arg\max_s \left[ E[Y|u,s] - \sum_c \lambda_c \cdot \text{violation}_c(s) \right]$$

**约束类型**:
| 约束 | 描述 | $\lambda$ 更新规则 |
|------|------|-------------------|
| 并发容量 | $n_s \leq C_s$ | $\lambda \uparrow$ if 超载 |
| 冷启动覆盖 | 新主播分配 ≥ min_alloc | $\lambda \uparrow$ if 未达 |
| 头部上限 | Top-10% 收益占比 ≤ 0.5 | $\lambda \uparrow$ if 超标 |

**验收标准**:
- 收益 vs Greedy ≥ +5%
- 约束满足率 > 95%

### 4.5 MVP-4.5: 鲸鱼分散 (b-matching)

**问题**: 多个鲸鱼同时涌入同一主播，导致承接饱和

**方法**:
1. 识别 Top-0.1% 鲸鱼用户
2. b-matching 约束：每主播同时最多服务 k 个鲸鱼
3. 分散算法：贪心 + 互斥

**验收标准**:
- 头部主播鲸鱼超载率 < 10%
- 总收益损失 < 2%

### 4.6 MVP-4.6: 不确定性排序 (UCB)

**问题**: 重尾分布下极端预测不确定性高

**方法**:
$$\text{score}(u,s) = \hat{E}[Y|u,s] + k \cdot \hat{\sigma}[Y|u,s]$$

**实现**:
- 使用分位数回归或 ensemble variance 估计 $\sigma$
- k 作为探索系数

**验收标准**:
- CVaR@5% 改善（减少极端损失）
- Top-1% Capture 不降低

### 4.7 MVP-4.7: 多目标生态调度

**问题**: 单目标收益最大化可能损害生态

**方法**:
$$\max \quad \alpha_1 \cdot \text{Revenue} + \alpha_2 \cdot \text{ColdStart} + \alpha_3 \cdot \text{Diversity} - \alpha_4 \cdot \text{Gini}$$

**实验**:
- 扫描 $\alpha$ 权重，绘制 Pareto 前沿
- 识别"收益-公平-多样性"最优权衡点

**验收标准**:
- 生成 Pareto 前沿图
- 找到 ≥2 个可用配置点

---

## 5. 📅 里程碑

| 周 | 任务 | 产出 |
|----|------|------|
| W1 | MVP-4.1+ 增强版校准 | Simulator V2 (完整4机制) |
| W1-2 | MVP-4.2 并发容量 | Simulator V2 (完整) |
| W2 | MVP-4.3 召回-精排 | Top-1%≥56% |
| W3 | MVP-4.4 供需匹配 | 影子价格分配策略 |
| W3-4 | MVP-4.5/4.6 鲸鱼+UCB | 辅助策略 |
| W4 | MVP-4.7 多目标 | Pareto 前沿 |
| W4 | Hub/Roadmap 更新 | Phase 4 闭环 |

---

## 6. 🔬 新假设与决策门

### 6.1 新假设

| ID | 假设 | 验证 MVP | 判断标准 |
|----|------|----------|----------|
| H4.1 | 离散档位可校准金额分布 | 4.1 | ✅ P50=0%, P90=13%, P99=26% |
| H4.2 | 并发容量影响收益边际 | 4.2 | 可观测边际递减 |
| H4.3 | 召回-精排优于单模型 | 4.3 | Top-1% ≥56% |
| H4.4 | 影子价格优于纯贪心 | 4.4 | 收益+5% |
| H4.5 | 鲸鱼分散减少超载 | 4.5 | 超载率<10% |

### 6.2 决策门

| Gate | 条件 | 通过动作 | 失败动作 |
|------|------|----------|----------|
| Gate-4A | Simulator V2 校准误差<30% | ✅ 通过 (所有指标<30%) | → 继续 MVP-4.2 |
| Gate-4B | 召回-精排 Top-1%≥56% | → 采用分工架构 | → 保留 Direct |
| Gate-4C | 影子价格收益≥+5% | → 替换 Greedy | → 保留 Greedy+约束 |

---

## 7. 📐 评估指标体系

### 7.1 现有指标

| 类别 | 指标 | 来源 |
|------|------|------|
| 预测 | Top-1%/5%/10% Capture, Spearman, NDCG | Phase 1 |
| 分配 | Revenue, Gini, Coverage, Cold-Start Success | Phase 2 |
| 评估 | SNIPS RelErr | Phase 3 |

### 7.2 新增指标

| 指标 | 定义 | 目的 |
|------|------|------|
| **Top-0.1% Capture** | 捕获极端鲸鱼的能力 | 精准识别大哥 |
| **超载率** | 主播并发超过容量的比例 | 容量约束有效性 |
| **CVaR@5%** | 最差 5% 情况的平均收益 | 尾部风险控制 |
| **Pareto 距离** | 到理想点的距离 | 多目标权衡 |
| **留存代理** | 新主播成功率 × 用户回访率 | 生态健康 |

---

## 8. 📎 附录

### 8.1 相关文件

| 文件 | 用途 |
|------|------|
| [Hub](./gift_allocation_hub.md) | 核心结论 (Phase 0-3) |
| [Roadmap](./gift_allocation_roadmap.md) | 实验索引 |
| [Simulator V1](./exp/exp_simulator_v1_20260108.md) | V1 校准结果 |

### 8.2 V1 Simulator 问题诊断

| 问题 | 表现 | V2 解决方案 |
|------|------|-------------|
| 金额分布误差大 | P50: 2→7.7 (285%) | 分位数匹配校准 |
| 无并发容量 | 无法模拟拥挤 | 加入 $C_s$ 与惩罚函数 |
| Top-1% Share 偏高 | 60%→97% | 调整 Pareto 参数 |
| 无长期效应 | 单轮静态 | 加入状态转移与留存 |

### 8.3 参考文献

- Chapelle (2014): Delayed Feedback
- Bottou et al. (2013): Counterfactual Reasoning
- Kleinberg & Tardos: Matching Algorithms
- Chen et al.: Online Allocation with Fairness Constraints

---

> **立项时间**: 2026-01-09  
> **预计完成**: 2026-01-31 (4 周)  
> **负责人**: Viska Wei
