# ğŸƒ Two-Stage vs Direct Regression: Fair Comparison

> **Name:** Fair Comparison on Click Data  
> **ID:** `EXP-20260108-gift-allocation-04`  
> **Topic:** `gift_allocation` | **MVP:** MVP-1.1-fair  
> **Author:** Viska Wei | **Date:** 2026-01-08 | **Status:** âœ…

> ğŸ¯ **Target:** åœ¨ç›¸åŒæ•°æ®é›†(clickå…¨é‡)ä¸Šå…¬å¹³å¯¹æ¯”ä¸¤æ®µå¼å»ºæ¨¡ä¸ç›´æ¥å›å½’ï¼Œå…³é—­DG1  
> ğŸš€ **Next:** Direct Regression èƒœå‡º â†’ ä¿ç•™ç®€å•æ¶æ„ï¼Œè€ƒè™‘ç‰¹å¾å·¥ç¨‹ä¼˜åŒ–

## âš¡ æ ¸å¿ƒç»“è®ºé€Ÿè§ˆ

> **ä¸€å¥è¯**: åœ¨å…¬å¹³å¯¹æ¯”ä¸‹ï¼Œ**Direct Regression çš„ Top-1% Capture (54.5%) è¿œè¶… Two-Stage (35.8%)**ï¼Œå·®è· 18.7ppã€‚Two-Stage åœ¨ Click å…¨é‡æ•°æ®ä¸Šå¹¶æ— ä¼˜åŠ¿ã€‚

| éªŒè¯é—®é¢˜ | ç»“æœ | ç»“è®º |
|---------|------|------|
| DG1: ä¸¤æ®µå¼ vs ç›´æ¥å›å½’çš„å¢ç›Šæœ‰å¤šå¤§ï¼Ÿ | âŒ Î” Top-1% = -18.7pp | Two-Stage è¡¨ç°æ›´å·®ï¼ŒREJECT |

| æŒ‡æ ‡ | Two-Stage | Direct Reg | Delta | èƒœè€… |
|------|-----------|-----------|-------|------|
| Top-1% Capture | 35.8% | **54.5%** | -18.7pp | Direct âœ… |
| Top-5% Capture | 40.4% | **41.4%** | -1.0pp | Direct |
| Spearman | 0.247 | **0.331** | -0.084 | Direct âœ… |
| MAE(log) | 0.081 | **0.044** | +0.037 | Direct âœ… |
| NDCG@100 | **0.371** | 0.217 | +0.154 | Two-Stage |

| Type | Link |
|------|------|
| ğŸ§  Hub | `gift_allocation/gift_allocation_hub.md` Â§ DG1 |
| ğŸ—ºï¸ Roadmap | `gift_allocation/gift_allocation_roadmap.md` Â§ MVP-1.1-fair |
| ğŸ“— Prior Exp | `gift_allocation/exp/exp_two_stage_20260108.md` |

---

# 1. ğŸ¯ ç›®æ ‡

**é—®é¢˜**: MVP-1.1 å®éªŒæ­ç¤ºäº†ä¸¤æ®µå¼ä¸Baselineåœ¨ä¸åŒæ•°æ®é›†ä¸Šè¯„ä¼°ï¼Œæ— æ³•å…¬å¹³å¯¹æ¯”ã€‚éœ€åœ¨ç›¸åŒå€™é€‰é›†ä¸Šé‡æ–°éªŒè¯ã€‚

**éªŒè¯**: DG1 - ä¸¤æ®µå¼ vs ç›´æ¥å›å½’çš„å¢ç›Šæœ‰å¤šå¤§ï¼Ÿ

| é¢„æœŸ | åˆ¤æ–­æ ‡å‡† |
|------|---------|
| Top-1% Capture æå‡ â‰¥ 5pp | é€šè¿‡ â†’ ç¡®è®¤ä¸¤æ®µå¼è·¯çº¿ï¼Œè¿›å…¥Gate-1 |
| Top-1% Capture æå‡ < 5pp | ä¿ç•™Baselineæ¶æ„ï¼Œè€ƒè™‘ç«¯åˆ°ç«¯ |

**å…³é”®è®¾è®¡å˜æ›´**ï¼ˆvs MVP-1.1ï¼‰:
1. âœ… ç»Ÿä¸€æ•°æ®é›†ï¼šä¸¤æ¨¡å‹å‡åœ¨ click å…¨é‡æ•°æ®ä¸Šè®­ç»ƒå’Œè¯„ä¼°
2. âœ… ç»Ÿä¸€å€™é€‰é›†ï¼šç›¸åŒçš„ test set (å«0å€¼æ ·æœ¬)
3. âœ… ç»Ÿä¸€ç›®æ ‡å˜é‡ï¼šlog(1+Y)ï¼Œå…¶ä¸­ Y=0 è¡¨ç¤ºæ— æ‰“èµ

---

# 2. ğŸ¦¾ ç®—æ³•

**æ–¹æ¡ˆ A: Direct Regression on Click (æ–°å¢)**
$$\hat{y} = f(x) = \text{LightGBM}(x), \quad Y = \log(1 + \text{amount})$$
- è®­ç»ƒæ•°æ®ï¼šclick å…¨é‡ (1.87Mï¼Œå« 98% çš„ Y=0)
- ç›®æ ‡ï¼šç›´æ¥é¢„æµ‹æœŸæœ›æ”¶ç›Š

**æ–¹æ¡ˆ B: Two-Stage (å·²æœ‰)**
$$v(x) = p(x) \cdot m(x)$$
- Stage 1: $p(x) = \Pr(Y > 0 | x)$ â€” åˆ†ç±»
- Stage 2: $m(x) = \mathbb{E}[\log(1+Y) | Y > 0, x]$ â€” æ¡ä»¶å›å½’

**å¯¹æ¯”ç»´åº¦**:
- æ’åºèƒ½åŠ›ï¼šTop-K% Capture, Spearman, NDCG@100
- æ ¡å‡†èƒ½åŠ›ï¼šECE (Stage 1), é¢„æµ‹åˆ†å¸ƒ
- è®¡ç®—å¼€é”€ï¼šè®­ç»ƒæ—¶é—´

---

# 3. ğŸ§ª å®éªŒè®¾è®¡

## 3.1 æ•°æ®

| é¡¹ | å€¼ |
|----|-----|
| æ¥æº | KuaiLive |
| è·¯å¾„ | `data/KuaiLive/` |
| æ ·æœ¬ | click å…¨é‡ (å«æ‰“èµ+éæ‰“èµ) |
| Train/Val/Test | 1,872,509 / 1,701,600 / 1,335,406 |
| æ­£æ ·æœ¬ç‡ | 1.82% (æ‰“èµæ ·æœ¬) |
| æ—¶é—´åˆ‡åˆ† | æŒ‰å¤©ï¼Œæœ€å7å¤©testï¼Œå‰7å¤©val |

**âš ï¸ å…³é”®**ï¼šä¸¤æ¨¡å‹ä½¿ç”¨å®Œå…¨ç›¸åŒçš„ train/val/test åˆ‡åˆ†

## 3.2 æ¨¡å‹

| æ¨¡å‹ | Objective | è®­ç»ƒæ•°æ® | å¤‡æ³¨ |
|------|-----------|---------|------|
| Direct Reg | regression (MAE) | click å…¨é‡ | æ–°å¢ |
| Two-Stage Stage1 | binary | click å…¨é‡ | åˆ†ç±» |
| Two-Stage Stage2 | regression (MAE) | gift-only | æ¡ä»¶å›å½’ |

**å…±åŒè¶…å‚**:

| å‚æ•° | å€¼ |
|------|-----|
| æ¨¡å‹ | LightGBM |
| num_leaves | 31 |
| learning_rate | 0.05 |
| n_estimators | 500 |
| early_stopping | 50 |
| feature_fraction | 0.8 |
| seed | 42 |

## 3.3 è¯„ä¼°æŒ‡æ ‡

| ç±»åˆ« | æŒ‡æ ‡ | è¯´æ˜ |
|------|------|------|
| æ’åº | Top-1%/5%/10% Capture | é¢„æµ‹æ’åä¸çœŸå®æ’åé‡å  |
| æ’åº | Spearman | æ’åç›¸å…³ç³»æ•° |
| æ’åº | NDCG@100 | å½’ä¸€åŒ–æŠ˜æŸç´¯è®¡å¢ç›Š |
| æ ¡å‡† | ECE | æœŸæœ›æ ¡å‡†è¯¯å·® (Stage 1) |
| è¯¯å·® | MAE(log) | logç©ºé—´å¹³å‡ç»å¯¹è¯¯å·® |

## 3.4 é€šè¿‡é—¨æ§›

| æŒ‡æ ‡ | é—¨æ§› | å†³ç­– |
|------|------|------|
| Top-1% Capture æå‡ | â‰¥ 5pp | â†’ ç¡®è®¤ä¸¤æ®µå¼ |
| Top-1% Capture æå‡ | < 5pp | â†’ ä¿ç•™Baseline |
| PR-AUC | > 0.65 | â†’ Stage 1 åˆ†ç±»æœ‰æ•ˆ |

---

# 4. ğŸ“Š å›¾è¡¨

### Fig 1: Top-K% Capture Comparison
![](../img/fair_comparison_topk.png)

**è§‚å¯Ÿ**:
- Direct Regression åœ¨ Top-1% å¤§å¹…é¢†å…ˆ (+18.7pp)
- Two-Stage åœ¨ Top-5% å’Œ Top-10% ç•¥æœ‰å·®è·ï¼Œä½†æ–¹å‘ä¸€è‡´

### Fig 2: Top-K% Capture Rate Curve
![](../img/fair_comparison_topk_curve.png)

**è§‚å¯Ÿ**:
- Direct Regression åœ¨æ‰€æœ‰ K å€¼ä¸‹éƒ½è¡¨ç°æ›´å¥½
- æ›²çº¿å·®è·åœ¨ Top-5% ä»¥ä¸‹é€æ¸æ”¶æ•›

### Fig 3: Predicted vs Actual Scatter
![](../img/fair_comparison_scatter.png)

**è§‚å¯Ÿ**:
- Direct Regression çš„é¢„æµ‹åˆ†å¸ƒæ›´é›†ä¸­
- Two-Stage çš„é¢„æµ‹å€¼å­˜åœ¨æ›´å¤§æ–¹å·®

### Fig 4: Feature Importance Comparison
![](../img/fair_comparison_feature_importance.png)

**è§‚å¯Ÿ**:
- ä¸¤æ¨¡å‹çš„ Top ç‰¹å¾æœ‰è¾ƒå¤§é‡å 
- `pair_gift_sum` å’Œ `pair_gift_count` åœ¨ä¸¤æ¨¡å‹ä¸­éƒ½é‡è¦

### Fig 5: All Metrics Comparison
![](../img/fair_comparison_all_metrics.png)

**è§‚å¯Ÿ**:
- Direct Regression åœ¨å¤šæ•°æŒ‡æ ‡ä¸Šå ä¼˜
- Two-Stage ä»…åœ¨ NDCG@100 ä¸Šè¡¨ç°æ›´å¥½

---

# 5. ğŸ’¡ æ´è§

## 5.1 å®è§‚

1. **æ•°æ®åæ–œé—®é¢˜**: Click æ•°æ®ä¸­ 98% æ˜¯ Y=0ï¼ŒDirect Regression é€šè¿‡å¤§é‡è´Ÿæ ·æœ¬å­¦ä¼šäº†"ä»€ä¹ˆäººä¸ä¼šé€ç¤¼"ï¼Œè¿™å¯¹æ’åºå¾ˆæœ‰å¸®åŠ©ã€‚

2. **Two-Stage çš„å±€é™**: å½“æ­£æ ·æœ¬æå°‘æ—¶ï¼ŒStage 1 çš„åˆ†ç±»å™¨å¾ˆå¿« early stopï¼ˆåªè®­ç»ƒäº† 9 è½®ï¼‰ï¼Œå¯¼è‡´ $p(x)$ é¢„æµ‹ä¸ç¨³å®šã€‚

3. **å…¬å¹³æ¯”è¾ƒçš„é‡è¦æ€§**: ä¹‹å‰ MVP-1.1 çš„è¯¯å¯¼æ€§ç»“è®ºæ¥è‡ªäºä¸å…¬å¹³çš„æ•°æ®å¯¹æ¯”ï¼ˆBaseline åœ¨ gift-only 72k è®­ç»ƒï¼ŒTwo-Stage åœ¨ click 4.9M è®­ç»ƒï¼‰ã€‚

## 5.2 æ¨¡å‹å±‚

1. **Stage 1 è®­ç»ƒä¸å……åˆ†**: Two-Stage çš„ Stage 1 åªè®­ç»ƒäº† 9 è½®å°± early stopï¼ŒPR-AUC è™½ç„¶è¾¾åˆ° 0.646ï¼Œä½†åˆ†ç±»è¾¹ç•Œä¸å¤Ÿç²¾ç»†ã€‚

2. **ä¹˜æ³•ç»„åˆçš„ä¸ç¨³å®šæ€§**: $v(x) = p(x) \cdot m(x)$ çš„ç»„åˆæ–¹å¼ä¼šæ”¾å¤§ $p(x)$ çš„è¯¯å·®ï¼Œå°¤å…¶åœ¨æç«¯å€¼é™„è¿‘ã€‚

3. **Direct Regression çš„ä¼˜åŠ¿**: ç›´æ¥åœ¨ log(1+Y) ä¸Šå›å½’ï¼Œå¤§é‡ Y=0 æ ·æœ¬å¸®åŠ©æ¨¡å‹å­¦ä¹ "ä¸é€ç¤¼"çš„ç‰¹å¾æ¨¡å¼ã€‚

## 5.3 ç»†èŠ‚

- Stage 1 ECE = 0.018ï¼Œæ ¡å‡†è‰¯å¥½
- Direct Reg è®­ç»ƒæ—¶é—´ 6.4sï¼ŒTwo-Stage æ€»è®¡ 4.3sï¼ˆS1=3.4s + S2=0.9sï¼‰
- 68 ä¸ªç‰¹å¾ï¼Œä¸¤æ¨¡å‹ç‰¹å¾é‡è¦æ€§æ’åºç›¸ä¼¼

---

# 6. ğŸ“ ç»“è®º

## 6.1 æ ¸å¿ƒå‘ç°

> **Direct Regression åœ¨å…¬å¹³å¯¹æ¯”ä¸‹å¤§å¹…èƒœå‡ºï¼ŒTop-1% Capture é«˜ 18.7ppã€‚Two-Stage æ¶æ„åœ¨æ­¤åœºæ™¯æ— ä¼˜åŠ¿ã€‚**

- âŒ DG1: Two-Stage æå‡ â‰¥ 5ppï¼Ÿ**å¦**ï¼Œåè€Œä¸‹é™ 18.7pp
- âœ… ç»“è®ºï¼šåœ¨ click å…¨é‡æ•°æ® + é«˜ç¨€ç–æ€§ï¼ˆ98% ä¸º 0ï¼‰åœºæ™¯ä¸‹ï¼Œç›´æ¥å›å½’æ›´ä¼˜

## 6.2 å…³é”®ç»“è®º

| # | ç»“è®º | è¯æ® |
|---|------|------|
| 1 | **Direct Regression æ’åºèƒ½åŠ›æ›´å¼º** | Top-1%: 54.5% vs 35.8% |
| 2 | **Two-Stage Stage 1 è®­ç»ƒä¸å……åˆ†** | ä»… 9 è½® early stop |
| 3 | **ä¹‹å‰ç»“è®ºå…·æœ‰è¯¯å¯¼æ€§** | æºäºä¸å…¬å¹³çš„æ•°æ®å¯¹æ¯” |
| 4 | **æ•°æ®ç¨€ç–æ€§å½±å“æ¨¡å‹é€‰æ‹©** | 98% Y=0 æ—¶ç›´æ¥å›å½’æ›´ä¼˜ |

## 6.3 è®¾è®¡å¯ç¤º

| åŸåˆ™ | å»ºè®® |
|------|------|
| æ¨¡å‹æ¯”è¾ƒéœ€å…¬å¹³ | ç›¸åŒæ•°æ®é›†ã€ç›¸åŒåˆ‡åˆ†ã€ç›¸åŒè¯„ä¼°é›† |
| é«˜ç¨€ç–åœºæ™¯ | ç›´æ¥å›å½’å¯èƒ½ä¼˜äºä¸¤é˜¶æ®µ |
| Two-Stage é€‚ç”¨åœºæ™¯ | æ­£æ ·æœ¬ç‡æ›´é«˜ã€åˆ†ç±»è¾¹ç•Œæ¸…æ™°æ—¶ |

| âš ï¸ é™·é˜± | åŸå›  |
|---------|------|
| ä¸åŒæ•°æ®é›†å¯¹æ¯” | å¯¼è‡´è™šå‡çš„æ€§èƒ½å·®å¼‚ |
| è¿‡æ—©å¾—å‡ºæ¶æ„ç»“è®º | éœ€å¤šåœºæ™¯éªŒè¯ |

## 6.4 å…³é”®æ•°å­—

| æŒ‡æ ‡ | Two-Stage | Direct Reg | Delta |
|------|-----------|-----------|-------|
| Top-1% Capture | 35.8% | **54.5%** | -18.7pp |
| Top-5% Capture | 40.4% | **41.4%** | -1.0pp |
| Top-10% Capture | 27.4% | 26.9% | +0.5pp |
| Spearman | 0.247 | **0.331** | -0.084 |
| MAE(log) | 0.081 | **0.044** | +0.037 |
| NDCG@100 | **0.371** | 0.217 | +0.154 |
| PR-AUC (S1) | 0.646 | N/A | - |
| ECE (S1) | 0.018 | N/A | - |

## 6.5 ä¸‹ä¸€æ­¥

| æ–¹å‘ | ä»»åŠ¡ | ä¼˜å…ˆçº§ |
|------|------|--------|
| ç‰¹å¾å·¥ç¨‹ | ä¼˜åŒ– Direct Regression ç‰¹å¾ | ğŸ”´ |
| æ•°æ®å¢å¼º | æ¢ç´¢æ›´å¥½çš„æ­£è´Ÿæ ·æœ¬é‡‡æ ·ç­–ç•¥ | ğŸŸ¡ |
| ç«¯åˆ°ç«¯ | è€ƒè™‘ç¥ç»ç½‘ç»œæ–¹æ¡ˆ | ğŸŸ¡ |
| Two-Stage æ”¹è¿› | å¢åŠ  Stage 1 è®­ç»ƒè½®æ•°é™åˆ¶ | ğŸŸ¢ |

---

# 7. ğŸ“ é™„å½•

## 7.1 æ•°å€¼ç»“æœ

| æ¨¡å‹ | Top-1% | Top-5% | Top-10% | Spearman | MAE(log) | NDCG@100 |
|------|--------|--------|---------|----------|----------|----------|
| Direct Reg | 54.5% | 41.4% | 26.9% | 0.331 | 0.044 | 0.217 |
| Two-Stage | 35.8% | 40.4% | 27.4% | 0.247 | 0.081 | 0.371 |

| Stage 1 æŒ‡æ ‡ | å€¼ |
|-------------|-----|
| PR-AUC | 0.646 |
| ECE | 0.018 |
| Log Loss | 0.053 |

## 7.2 æ‰§è¡Œè®°å½•

| é¡¹ | å€¼ |
|----|-----|
| è„šæœ¬ | `scripts/train_fair_comparison.py` |
| æ—¥å¿— | `logs/fair_comparison_20260108.log` |
| ç»“æœ JSON | `gift_allocation/results/fair_comparison_20260108.json` |
| æ¨¡å‹ | `gift_allocation/models/fair_direct_reg_20260108.pkl` |

```bash
# è¿è¡Œå®éªŒ
source init.sh
nohup python scripts/train_fair_comparison.py > logs/fair_comparison_20260108.log 2>&1 &

# æŸ¥çœ‹æ—¥å¿—
tail -f logs/fair_comparison_20260108.log
```

## 7.3 è®­ç»ƒä¿¡æ¯

| æ¨¡å‹ | è®­ç»ƒæ—¶é—´ | Best Iteration |
|------|---------|----------------|
| Direct Regression | 6.4s | 162 |
| Two-Stage Stage 1 | 3.4s | 9 |
| Two-Stage Stage 2 | 0.9s | 105 |

---

> **å®éªŒå®Œæˆæ—¶é—´**: 2026-01-08
