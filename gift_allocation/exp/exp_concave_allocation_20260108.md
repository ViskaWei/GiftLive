<!--
ğŸ“ Agent ä¹¦å†™è§„èŒƒï¼ˆä¸å‡ºç°åœ¨æ­£æ–‡ï¼‰:
- Header å…¨è‹±æ–‡
- æ­£æ–‡ä¸­æ–‡
- å›¾è¡¨æ–‡å­—å…¨è‹±æ–‡ï¼ˆä¸­æ–‡ä¼šä¹±ç ï¼‰
- å…¬å¼ç”¨ LaTeX: $inline$ æˆ– $$block$$
-->

# ğŸƒ Concave Revenue Allocation Layer
> **Name:** Concave Revenue Allocation Layer  \
> **ID:** `VIT-20260108-gift_allocation-08`  \
> **Topic:** `gift_allocation` | **MVP:** MVP-2.1 | **Project:** `VIT`  \
> **Author:** Viska Wei | **Date:** 2026-01-08 | **Status:** âœ… Completed
>
> ğŸ¯ **Target:** éªŒè¯å‡¹æ”¶ç›Šåˆ†é…æ˜¯å¦æ˜¾è‘—ä¼˜äºè´ªå¿ƒåˆ†é…ï¼Œå…³é—­ DG3  \
> ğŸš€ **Decision / Next:** âŒ DG3 æœªé€šè¿‡ â†’ Gate-2 å†³å®šç®€åŒ–ä¸ºè´ªå¿ƒ+ç¡¬çº¦æŸ

---

## âš¡ æ ¸å¿ƒç»“è®ºé€Ÿè§ˆï¼ˆä¾› main æå–ï¼›â‰¤30è¡Œï¼›å¿…å« I/O + Run TL;DRï¼‰

> **ä¸€å¥è¯**: å‡¹æ”¶ç›Šåˆ†é…(concave_exp)ä»…å¸¦æ¥ -1.17% æ”¶ç›Šå˜åŒ–å’Œ Gini æ”¹å–„ 0.018ï¼Œ**æœªè¾¾åˆ° â‰¥10% æ”¶ç›Šæå‡é˜ˆå€¼**ï¼ŒDG3 æœªå…³é—­

### 0.1 è¿™å®éªŒåˆ°åº•åœ¨åšä»€ä¹ˆï¼Ÿï¼ˆX := ç®—æ³•/æœºåˆ¶ â†’ ç›®æ ‡ | Why+How | I/O | Trade-offï¼‰

$$
X := \underbrace{\text{Concave Allocation}}_{\text{è¾¹é™…é€’å‡åˆ†é…}}\ \xrightarrow[\text{é€šè¿‡}]{\ g'(V_s) \cdot v_{u,s}\ }\ \underbrace{\text{å…¬å¹³æ€§æå‡}}_{\text{é¿å…å¤´éƒ¨å †å }}\ \big|\ \underbrace{\text{Why ğŸ©¸}}_{\text{è´ªå¿ƒå¯¼è‡´é©¬å¤ªæ•ˆåº”}} + \underbrace{\text{How ğŸ’§}}_{\text{é€‰æ‹©å‡¹å‡½æ•°ç±»å‹}}
$$
- **ğŸ» What (æ˜¯ä»€ä¹ˆ)**: å‡¹æ”¶ç›Šåˆ†é…ï¼šæŒ‰è¾¹é™…æ•ˆç”¨ $g'(V_s)$ åŠ æƒåˆ†é…ï¼Œè€Œéçº¯ Greedy
- **ğŸ æ ¸å¿ƒæœºåˆ¶**: è¾¹é™…é€’å‡ï¼šä¸»æ’­æ”¶ç›Šè¶Šé«˜ï¼Œå†åˆ†é…ç»™ä»–çš„è¾¹é™…æ•ˆç”¨è¶Šä½
- **â­ ç›®æ ‡**: éªŒè¯å‡¹æ”¶ç›Šæ˜¯å¦èƒ½åŒæ—¶æå‡æ”¶ç›Šå’Œå…¬å¹³æ€§
- **ğŸ©¸ Whyï¼ˆç—›ç‚¹ï¼‰**: è´ªå¿ƒå¯¼è‡´å¤´éƒ¨ä¸»æ’­è·å¾—æ‰€æœ‰æµé‡
- **ğŸ’§ Howï¼ˆéš¾ç‚¹ï¼‰**: å‡¹å‡½æ•°ç±»å‹é€‰æ‹©ï¼ˆlog vs exp é¥±å’Œå‹ï¼‰
$$
\underbrace{\text{I/O ğŸ«}}_{\text{æ¨¡æ‹Ÿå™¨â†’æ”¶ç›Š+Gini}}\ =\ \underbrace{-0.018 \text{ Gini}}_{\text{æ›´å…¬å¹³}}\ -\ \underbrace{-1.17\% \text{æ”¶ç›Š}}_{\text{ç•¥æœ‰æŸå¤±}}
$$
**I/Oï¼ˆå¿…é¡»å†™æ¸…æ¥šï¼Œè¯»è€…é è¿™ä¸€æ®µç†è§£å®éªŒ"åœ¨å¹²å˜›"ï¼‰**

| ç±»å‹ | ç¬¦å· | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| ğŸ« è¾“å…¥ | $\mathcal{E}$ | æ¨¡æ‹Ÿç¯å¢ƒ | 10K users Ã— 500 streamers, 100 simulations |
| ğŸ« è¾“å…¥ | $g(\cdot)$ | å‡¹æ•ˆç”¨å‡½æ•° | log(1+V) æˆ– B(1-exp(-V/B)) |
| ğŸ« è¾“å‡º | $R, G$ | æ”¶ç›Šä¸ Gini | Revenue=251.8K, Gini=0.512 |
| ğŸ“Š æŒ‡æ ‡ | $\Delta R, \Delta G$ | ç›¸å¯¹å˜åŒ– | -1.17%, -0.018 |
| ğŸ åŸºçº¿ | $\pi_{greedy}$ | è´ªå¿ƒç­–ç•¥ | argmax EV |

### 0.2 Pipeline TL;DRï¼ˆ5-10 è¡Œæç®€ä¼ªä»£ç ï¼Œä¸€çœ¼çœ‹æ‡‚åœ¨è·‘ä»€ä¹ˆï¼‰

```
1. å‡†å¤‡ç¯å¢ƒï¼šSimulatorV1ï¼ˆ10k ç”¨æˆ· Ã— 500 ä¸»æ’­ï¼‰
2. æ„å»ºå¯¹æ¯”ç»„ï¼š5 ç§ç­–ç•¥ï¼ˆRandom / Greedy / Concave-log / Concave-exp / Greedy+Capï¼‰
3. æ ¸å¿ƒå¾ªç¯ï¼š
   for each ç­–ç•¥:
       for 100 æ¬¡æ¨¡æ‹Ÿ:
           for 50 è½®:
               ç”¨æˆ·åˆ°è¾¾ â†’ æŒ‰è¾¹é™…æ•ˆç”¨ g'(V_s)*v_{u,s} åˆ†é…ä¸»æ’­ â†’ ç´¯è®¡ä¸»æ’­æ”¶ç›Š
4. å‚æ•°æ‰«æï¼šB âˆˆ [100, 500, 1000, 5000, 10000]ï¼ˆé¥±å’Œå‹å‡¹å‡½æ•°å‚æ•°ï¼‰
5. è¯„ä¼°ï¼šRevenue / Gini / Top-10% Shareï¼Œå¯¹æ¯” Greedy baseline
6. è½ç›˜ï¼šgift_allocation/results/concave_allocation_20260108.json
```

> âš ï¸ **å¤ç°å‘½ä»¤** â†’ è§ Â§7.2 é™„å½•
> ğŸ“– **è¯¦ç»†ä¼ªä»£ç ** â†’ è§ Â§2.4.2

### 0.3 å¯¹å‡è®¾/éªŒè¯é—®é¢˜çš„å›ç­”

| éªŒè¯é—®é¢˜ | ç»“æœ | ç»“è®º |
|---------|------|------|
| DG3: å‡¹æ”¶ç›Š vs è´ªå¿ƒæ”¶ç›Šå·®å¼‚ â‰¥10%? | âŒ Î” = -1.17% | æ”¶ç›Šæå‡ä¸æ˜¾è‘—ï¼Œä½†å…¬å¹³æ€§æœ‰æ”¹å–„ |

### 0.4 å…³é”®æ•°å­—ï¼ˆåªæ”¾æœ€é‡è¦çš„ 3-5 ä¸ªï¼‰

| Metric | Value | vs Baseline | Notes |
|--------|-------|------------|------|
| Best Concave | concave_exp (B=1000) | - | é¥±å’Œå‹æ•ˆç”¨å‡½æ•°æœ€ä¼˜ |
| Î” Revenue | **-1.17%** | 251,783 vs 254,752 | æœªè¾¾ 10% é˜ˆå€¼ |
| Î” Gini | **-0.018** | 0.512 vs 0.529 | æ›´å…¬å¹³ âœ… |
| Gate-2 Decision | simplify_to_greedy | - | å‡¹æ”¶ç›Šè¾¹é™…ï¼Œç”¨ç¡¬çº¦æŸæ›¿ä»£ |

### 0.5 Links

| Type | Link |
|------|------|
| ğŸ§  Hub | `gift_allocation/gift_allocation_hub.md` Â§ DG3, Q2.1 |
| ğŸ—ºï¸ Roadmap | `gift_allocation/gift_allocation_roadmap.md` Â§ MVP-2.1 |
| ğŸ“‹ Kanban | `status/kanban.md` |

---

# 1. ğŸ¯ ç›®æ ‡

**æ ¸å¿ƒé—®é¢˜**: å‡¹æ”¶ç›Šåˆ†é…ï¼ˆè¾¹é™…é€’å‡ï¼‰æ˜¯å¦èƒ½æ˜¾è‘—ä¼˜äºè´ªå¿ƒåˆ†é…ï¼Ÿ

**å¯¹åº” main / roadmap**:
- éªŒè¯é—®é¢˜ï¼šDG3
- å­å‡è®¾ï¼šH2.1.1
- Gateï¼šGate-2

## 1.1 æˆåŠŸæ ‡å‡†ï¼ˆéªŒæ”¶ / stop ruleï¼‰

| åœºæ™¯ | é¢„æœŸç»“æœ | åˆ¤æ–­æ ‡å‡† |
|------|---------|---------|
| âœ… é€šè¿‡ | Î” Revenue â‰¥ 10% + Gini æ”¹å–„ | ç¡®è®¤åˆ†é…å±‚è®¾è®¡ï¼Œé‡‡ç”¨å‡¹æ”¶ç›Š |
| âŒ å¦å†³ | Î” Revenue < 10% | ç®€åŒ–ä¸ºè´ªå¿ƒ + ç¡¬çº¦æŸ |
| âš ï¸ å¼‚å¸¸ | Gini åè€Œæ¶åŒ– | æ£€æŸ¥å‡¹å‡½æ•°å‚æ•° |

---

# 2. ğŸ¦¾ æ–¹æ³•ï¼ˆç®—æ³• + I/O + å®éªŒæµç¨‹ï¼‰

## 2.1 ç®—æ³•

> ğŸ“Œ **ç»“æ„**ï¼š2.1.1 æ ¸å¿ƒç®—æ³• â†’ 2.1.2 ç¬¦å·è¡¨ï¼ˆå˜é‡å®šä¹‰+å–å€¼èŒƒå›´ï¼‰â†’ 2.1.3 è¾…åŠ©å…¬å¼ï¼ˆäºŒçº§è®¡ç®—ï¼‰

### 2.1.1 æ ¸å¿ƒç®—æ³•

**è´ªå¿ƒåˆ†é…ï¼ˆBaselineï¼‰**ï¼š

$$s^* = \arg\max_s v_{u,s}$$

**å‡¹æ”¶ç›Šåˆ†é…**ï¼š

$$s^* = \arg\max_s g'(V_s) \cdot v_{u,s}$$

**ç›´è§‰è§£é‡Š**ï¼š
- å‡¹æ”¶ç›Šé€šè¿‡è¾¹é™…é€’å‡é¿å…æµé‡è¿‡åº¦å †å åˆ°å¤´éƒ¨ä¸»æ’­
- $g'(V_s)$ è¶Šå¤§è¡¨ç¤ºåˆ†é…ç»™è¯¥ä¸»æ’­çš„è¾¹é™…æ•ˆç”¨è¶Šé«˜

### 2.1.2 ç¬¦å·è¡¨

> ğŸ’¡ **å…³é”®**ï¼šæ¯ä¸ªç¬¦å·éƒ½ç»™å‡ºå…·ä½“æ•°å€¼ä¾‹å­ï¼Œè®©è¯»è€…ç§’æ‡‚å˜é‡å«ä¹‰

| ç¬¦å· | å«ä¹‰ | ç±»å‹/å–å€¼èŒƒå›´ | è®¡ç®—/æ¥æº | å…·ä½“æ•°å€¼ä¾‹å­ |
|------|------|--------------|-----------|-------------|
| $s^*$ | æœ€ä¼˜åˆ†é…ä¸»æ’­ | int, $s^* \in \{1,...,S\}$ | argmax è®¡ç®—ç»“æœ | `s*=42`ï¼ˆåˆ†é…ç»™ä¸»æ’­ 42ï¼‰|
| $S$ | ä¸»æ’­æ€»æ•° | int, $S=500$ | å¸¸é‡ | `S=500` |
| $v_{u,s}$ | é¢„ä¼°ä»·å€¼ | float, $v_{u,s} \geq 0$ | è§ Â§2.1.3 EV è®¡ç®— | `v[user_0, streamer_42]=85.3`ï¼ˆå…ƒï¼‰|
| $V_s$ | ä¸»æ’­ç´¯è®¡æ”¶ç›Š | float, $V_s \geq 0$ | å†å²æ”¶ç›Šç´¯åŠ  | `V_42=15234.5`ï¼ˆå…ƒï¼‰|
| $g(V)$ | æ•ˆç”¨å‡½æ•°ï¼ˆå‡¹å‡½æ•°ï¼‰ | $\mathbb{R}^+ \to \mathbb{R}^+$ | è§ Â§2.1.3 å‡¹å‡½æ•° | `g(1000)=log(1001)=6.91` |
| $g'(V)$ | è¾¹é™…æ•ˆç”¨ | float, $g'(V) > 0$, å•è°ƒé€’å‡ | è§ Â§2.1.3 è¾¹é™…æ•ˆç”¨ | `g'(1000)=1/1001=0.001` |
| $B$ | é¥±å’Œå‹é˜ˆå€¼å‚æ•° | float, $B \in \{100,...,10000\}$ | è¶…å‚æ•°ï¼ˆæ‰«æï¼‰ | `B=1000`ï¼ˆæ”¶ç›Šè¶…è¿‡ 1000 åè¾¹é™…é€’å‡æ˜æ˜¾ï¼‰|

### 2.1.3 è¾…åŠ©å…¬å¼

**é¢„ä¼°ä»·å€¼ï¼ˆEVï¼‰è®¡ç®—**ï¼š

$$v_{u,s} = \mathbb{E}[\text{gift}|u,s] = P(\text{gift}|u,s) \cdot \mathbb{E}[\text{amount}|\text{gift}=1, u,s]$$

- **ç”¨é€”**: ä¼°è®¡ç”¨æˆ· $u$ åˆ†é…ç»™ä¸»æ’­ $s$ çš„æœŸæœ›æ”¶ç›Š
- **è¾“å…¥**: ç”¨æˆ·ç‰¹å¾ã€ä¸»æ’­ç‰¹å¾
- **è¾“å‡º**: é¢„ä¼°ä»·å€¼ $v_{u,s}$ï¼Œç”¨äºåˆ†é…å†³ç­–

**å‡¹å‡½æ•°åŠè¾¹é™…æ•ˆç”¨**ï¼š

| ç±»å‹ | $g(V)$ | $g'(V)$ | ç‰¹ç‚¹ |
|------|--------|---------|------|
| å¯¹æ•°å‹ (concave_log) | $\log(1+V)$ | $\frac{1}{1+V}$ | è¡°å‡æ…¢ï¼Œå‡è¡¡åŒ–å¼± |
| é¥±å’Œå‹ (concave_exp) | $B(1-e^{-V/B})$ | $e^{-V/B}$ | å¿«é€Ÿè¡°å‡åç¨³å®š |

**å¯¹æ•°å‹è¾¹é™…æ•ˆç”¨**ï¼š

$$g'_{\text{log}}(V) = \frac{1}{1+V}$$

- **ç”¨é€”**: è¾¹é™…é€’å‡ï¼Œä½†è¡°å‡è¾ƒæ…¢
- **è¾“å…¥**: ä¸»æ’­ç´¯è®¡æ”¶ç›Š $V$
- **è¾“å‡º**: è¾¹é™…æ•ˆç”¨ï¼Œ$V$ è¶Šå¤§ï¼Œ$g'(V)$ è¶Šå°

**é¥±å’Œå‹è¾¹é™…æ•ˆç”¨**ï¼š

$$g'_{\text{exp}}(V) = e^{-V/B}$$

- **ç”¨é€”**: è¾¹é™…é€’å‡ï¼Œ$B$ æ§åˆ¶é¥±å’Œé˜ˆå€¼
- **è¾“å…¥**: ä¸»æ’­ç´¯è®¡æ”¶ç›Š $V$ï¼Œé¥±å’Œå‚æ•° $B$
- **è¾“å‡º**: è¾¹é™…æ•ˆç”¨ï¼Œ$V \gg B$ æ—¶æ¥è¿‘ 0

## 2.2 è¾“å…¥ / è¾“å‡ºï¼ˆå¿…å¡«ï¼šæ¯” 0.1 æ›´ç»†ä¸€ç‚¹ï¼‰

### I/O Schema

| Component | Type/Shape | Example | Notes |
|----------|------------|---------|------|
| users | ndarray (10000, 16) | preference vectors | ç”¨æˆ·ç‰¹å¾ |
| streamers | ndarray (500, 16) | content vectors | ä¸»æ’­ç‰¹å¾ |
| V_s | ndarray (500,) | ç´¯è®¡æ”¶ç›Š | ç”¨äºè®¡ç®—è¾¹é™…æ•ˆç”¨ |
| Output: allocations | Dict | {u1: s5, ...} | åˆ†é…ç»“æœ |
| Output: metrics | Dict | {revenue, gini, ...} | è¯„ä¼°æŒ‡æ ‡ |

### Assumptions & Constraints

| Assumption/Constraint | Why it matters | How handled |
|----------------------|----------------|------------|
| è¾¹é™…é€’å‡å•è°ƒ | ä¿è¯å‡¹å‡½æ•°æ€§è´¨ | g''(V) < 0 |
| B å‚æ•°é€‰æ‹© | å½±å“é¥±å’Œé€Ÿåº¦ | ç½‘æ ¼æœç´¢ |

## 2.3 å®ç°è¦ç‚¹ï¼ˆè¯»è€…èƒ½å¯¹ç…§ä»£ç å®šä½ï¼‰

| What | Where (file:function) | Key detail |
|------|------------------------|-----------|
| Simulator | `scripts/simulator/simulator.py:GiftLiveSimulator` | V1 æ¨¡æ‹Ÿå™¨ |
| Policies | `scripts/simulator/policies.py:ConcavePolicy` | å‡¹æ”¶ç›Šç­–ç•¥ |
| Runner | `scripts/train_concave_allocation.py:main` | å®éªŒå…¥å£ |
| Evaluator | `scripts/simulator/metrics.py:compute_metrics` | æŒ‡æ ‡è®¡ç®— |

## 2.4 å®éªŒæµç¨‹ï¼ˆå¿…å¡«ï¼šæ¨¡å—æ‹†è§£ + æ ¸å¿ƒå¾ªç¯å±•å¼€ + Code Pointerï¼‰

### 2.4.1 å®éªŒæµç¨‹æ ‘çŠ¶å›¾ï¼ˆå®Œæ•´å¯è§†åŒ–ï¼‰

```
å‡¹æ”¶ç›Šåˆ†é…å®éªŒ
â”‚
â”œâ”€â”€ 1. å‡†å¤‡ç¯å¢ƒ
â”‚   â”œâ”€â”€ æ¨¡æ‹Ÿå™¨ï¼šSimulatorV1ï¼ˆ10K users Ã— 500 streamersï¼‰
â”‚   â”œâ”€â”€ è¿è¡Œæ¬¡æ•°ï¼š100 simulations
â”‚   â””â”€â”€ Code: `simulator/simulator.py:GiftLiveSimulator`
â”‚
â”œâ”€â”€ 2. æ„å»ºå¯¹æ¯”ç»„
â”‚   â”œâ”€â”€ Randomï¼šéšæœºåˆ†é…
â”‚   â”œâ”€â”€ Greedyï¼šargmax v(u,s)
â”‚   â”œâ”€â”€ Concave-logï¼šargmax g'(V)Â·v(u,s)ï¼Œg(V)=log(1+V)
â”‚   â”œâ”€â”€ Concave-expï¼šargmax g'(V)Â·v(u,s)ï¼Œg(V)=B(1-exp(-V/B))
â”‚   â””â”€â”€ Code: `simulator/policies.py:ConcavePolicy`
â”‚
â”œâ”€â”€ 3. æ ¸å¿ƒå¾ªç¯
â”‚   â”œâ”€â”€ å¤–å±‚ï¼šÃ— 5 ç§ç­–ç•¥
â”‚   â”œâ”€â”€ ä¸­å±‚ï¼šÃ— 100 æ¬¡æ¨¡æ‹Ÿ
â”‚   â””â”€â”€ å†…å±‚ï¼šÃ— 50 è½® Ã— 200 ç”¨æˆ·
â”‚       â”œâ”€â”€ Step 1: ç”¨æˆ·åˆ°è¾¾
â”‚       â”œâ”€â”€ Step 2: ç­–ç•¥åˆ†é… â†’ s* = argmax[g'(V_s)Â·v(u,s)]
â”‚       â”œâ”€â”€ Step 3: è§‚å¯Ÿæ”¶ç›Š â†’ reward = simulate_gift(u, s*)
â”‚       â””â”€â”€ Step 4: æ›´æ–° V_s += reward
â”‚
â”œâ”€â”€ 4. å‚æ•°æ‰«æï¼ˆB å€¼ï¼‰
â”‚   â”œâ”€â”€ B âˆˆ [100, 500, 1000, 5000, 10000]
â”‚   â””â”€â”€ Code: `train_concave_allocation.py:run_sweep`
â”‚
â”œâ”€â”€ 5. è¯„ä¼°
â”‚   â”œâ”€â”€ è®¡ç®—æŒ‡æ ‡ï¼šRevenue, Gini, Top-10% Share, Coverage
â”‚   â”œâ”€â”€ å¯¹æ¯” Greedy baseline
â”‚   â””â”€â”€ Code: `simulator/metrics.py:compute_metrics`
â”‚
â””â”€â”€ 6. è½ç›˜
    â”œâ”€â”€ ç»“æœï¼šgift_allocation/results/concave_allocation_20260108.json
    â””â”€â”€ å›¾è¡¨ï¼šgift_allocation/img/mvp21_*.png
```

### 2.4.2 æ¨¡å—æ‹†è§£ï¼ˆè¯¦ç»†å±•å¼€æ¯ä¸ªæ¨¡å—ï¼Œå¸¦ Code Pointerï¼‰

| Module | Responsibility | Input â†’ Output | Code Pointer |
|--------|----------------|----------------|--------------|
| M1: init_simulator | åˆå§‹åŒ– SimulatorV1 | config â†’ simulator | `simulator/simulator.py:GiftLiveSimulator` |
| M2: build_policies | æ„å»ºå„ç­–ç•¥ | policy_types â†’ policies | `simulator/policies.py:ConcavePolicy` |
| M3: run_comparison | **æ ¸å¿ƒå¾ªç¯** | sim + policies â†’ results | `train_concave_allocation.py:run_comparison` |
| M4: run_param_sweep | B å‚æ•°æ‰«æ | B_range â†’ sweep_results | `train_concave_allocation.py:run_sweep` |
| M5: evaluate | è®¡ç®—æŒ‡æ ‡ | traj â†’ metrics | `simulator/metrics.py:compute_metrics` |
| M6: save | è½ç›˜ | results â†’ json | `train_concave_allocation.py:save_json` |

### 2.4.3 æ ¸å¿ƒå¾ªç¯å±•å¼€ï¼ˆM3: run_comparison å†…éƒ¨é€»è¾‘ï¼‰

> âš ï¸ **å¿…å¡«**ï¼šå±•å¼€å‡¹æ”¶ç›Šåˆ†é…çš„æ ¸å¿ƒé€»è¾‘â€”â€”ä¸ Greedy çš„å·®å¼‚åœ¨äº `select` å‡½æ•°

```python
# === æ ¸å¿ƒå¾ªç¯ï¼ˆå¯¹é½ simulator/simulator.py:run + policies.py:ConcavePolicyï¼‰===

def run(policy, n_rounds=50):
    """å•æ¬¡æ¨¡æ‹Ÿï¼šå‡¹æ”¶ç›Š vs Greedy çš„æ ¸å¿ƒå·®å¼‚"""
    streamer_stats = {s: {"V": 0} for s in streamers}  # V_s = ç´¯è®¡æ”¶ç›Š
    
    for t in range(n_rounds):
        users_batch = sample_users(n=200)
        
        for user in users_batch:
            # ===== æ ¸å¿ƒå·®å¼‚ï¼šGreedy vs Concave =====
            if isinstance(policy, GreedyPolicy):
                # Greedy: é€‰é¢„ä¼°æ”¶ç›Šæœ€é«˜çš„ä¸»æ’­
                s* = argmax_s[ v(u, s) ]
            else:
                # Concave: æŒ‰è¾¹é™…æ•ˆç”¨åŠ æƒ â€” æ”¶ç›Šé«˜çš„ä¸»æ’­è¾¹é™…é€’å‡
                # g'(V_s) = dg/dVï¼ŒV_s è¶Šå¤§ï¼Œg'(V_s) è¶Šå°
                s* = argmax_s[ g'(V_s) * v(u, s) ]
                # ä¾‹å¦‚ g(V) = log(1+V) â†’ g'(V) = 1/(1+V)
                # ä¾‹å¦‚ g(V) = B*(1-exp(-V/B)) â†’ g'(V) = exp(-V/B)
            
            # è§‚å¯Ÿæ”¶ç›Š
            reward = simulate_gift(user, s*)
            streamer_stats[s*]["V"] += reward
    
    return streamer_stats

# å‡¹å‡½æ•°ç±»å‹å¯¹æ¯”
def concave_derivative(V, func_type, B=1000):
    if func_type == "log":
        return 1.0 / (1.0 + V)          # å¯¹æ•°å‹ï¼šç¼“æ…¢è¡°å‡
    elif func_type == "exp":
        return np.exp(-V / B)           # é¥±å’Œå‹ï¼šå¿«é€Ÿè¡°å‡åç¨³å®š
```

**å…³é”®é€»è¾‘è§£é‡Š**ï¼š
- **Greedy**: `argmax v(u,s)` â†’ åªçœ‹åŒ¹é…åº¦ï¼Œå¤´éƒ¨ä¸»æ’­å †ç§¯
- **Concave-log**: `argmax g'(V)*v` â†’ è¾¹é™…é€’å‡ï¼Œä½†è¡°å‡å¤ªæ…¢
- **Concave-exp**: `argmax exp(-V/B)*v` â†’ é¥±å’Œæ•ˆåº”ï¼Œæ›´å¼ºçš„å‡è¡¡åŒ–

### 2.4.4 å‚æ•°æ‰«æ

```python
for B in [100, 500, 1000, 5000, 10000]:
    cfg_i = cfg.override(B=B)
    run_one(cfg_i)
```

### 2.4.5 å¤ç°æ¸…å•

- [x] å›ºå®šéšæœºæ€§ï¼šseed=42
- [x] å›ºå®šæ•°æ®ç‰ˆæœ¬ï¼šSimulatorV1
- [x] å›ºå®šå¯¹ç…§ç»„ï¼šGreedy
- [x] è¾“å‡ºç‰©ï¼šconcave_allocation_20260108.json + mvp21_*.png

---

# 3. ğŸ§ª å®éªŒè®¾è®¡ï¼ˆå…·ä½“åˆ°æœ¬æ¬¡å®éªŒï¼‰

## 3.1 æ•°æ® / ç¯å¢ƒ

| Item | Value |
|------|-------|
| Source | Simulator V1 (MVP-0.3) |
| Path | åˆæˆæ•°æ® |
| Split | N/A (æ¨¡æ‹Ÿ) |
| Feature | 10,000 users Ã— 500 streamers |
| Target | Revenue, Gini |

## 3.2 Baselinesï¼ˆå¯¹ç…§ç»„ï¼‰

| Baseline | Purpose | Key config |
|----------|---------|-----------|
| random | sanity check | éšæœºåˆ†é… |
| greedy | SOTA baseline | argmax EV |

## 3.3 è®­ç»ƒ / è¿è¡Œé…ç½®

| Param | Value | Notes |
|------|-------|------|
| n_rounds | 50 | æ¯æ¬¡æ¨¡æ‹Ÿè½®æ•° |
| users_per_round | 200 | - |
| n_simulations | 100 (ä¸») / 50 (æ‰«æ) / 30 (è§„æ¨¡) | - |
| hardware | CPU | ~30min total |

## 3.4 æ‰«æå‚æ•°ï¼ˆå¯é€‰ï¼‰

| Sweep | Range | Fixed |
|------|-------|-------|
| B (é¥±å’Œé˜ˆå€¼) | [100, 500, 1000, 5000, 10000] | concave_exp |
| N_users | [1000, 5000, 10000, 50000] | è§„æ¨¡æ•ˆåº” |

## 3.5 è¯„ä»·æŒ‡æ ‡

| Metric | Definition | Why |
|--------|------------|-----|
| Revenue | æ€»æ”¶ç›Š | æ ¸å¿ƒå•†ä¸šæŒ‡æ ‡ |
| Gini | ä¸»æ’­æ”¶ç›Šé›†ä¸­åº¦ | å…¬å¹³æ€§ |
| Top-10% Share | å¤´éƒ¨å æ¯” | é©¬å¤ªæ•ˆåº” |
| Coverage | ä¸»æ’­è¦†ç›–ç‡ | å¤šæ ·æ€§ |

---

# 4. ğŸ“Š å›¾è¡¨ & ç»“æœ

### Fig 1: Revenue Comparison by Policy
![](../img/mvp21_revenue_comparison.png)

**What it shows**: å„ç­–ç•¥æ”¶ç›Šå¯¹æ¯”

**Key observations**:
- Greedy å’Œ Concave_exp æ”¶ç›Šæ¥è¿‘ï¼ˆ254.8K vs 251.8Kï¼‰
- Random æ”¶ç›Šæœ€ä½ï¼ˆ113.4Kï¼Œ-55.5%ï¼‰
- Concave_log æ”¶ç›Šä¸‹é™æ˜æ˜¾ï¼ˆ-8.3%ï¼‰

### Fig 2: Fairness Comparison by Policy
![](../img/mvp21_fairness_comparison.png)

**What it shows**: å„ç­–ç•¥å…¬å¹³æ€§å¯¹æ¯”

**Key observations**:
- Concave_exp çš„ Gini ç³»æ•°æœ€ä½ï¼ˆ0.512 vs Greedy 0.529ï¼‰
- Top-10% Share åŒæ ·æ”¹å–„ï¼ˆ42.1% vs 44.0%ï¼‰
- Concave_log åè€Œæ¶åŒ–å…¬å¹³æ€§

### Fig 3: Revenue-Fairness Trade-off (Pareto Frontier)
![](../img/mvp21_pareto_frontier.png)

**What it shows**: æ”¶ç›Š-å…¬å¹³æ€§æƒè¡¡

**Key observations**:
- Concave_exp åœ¨ Pareto å‰æ²¿ï¼ˆé«˜æ”¶ç›Š + ä½ Giniï¼‰
- Greedy æ”¶ç›Šæœ€é«˜ä½†å…¬å¹³æ€§è¾ƒå·®
- ä¸å­˜åœ¨æ˜æ˜¾çš„"åŒèµ¢"ç­–ç•¥

### Fig 4: Parameter Sensitivity (B)
![](../img/mvp21_param_sensitivity.png)

**What it shows**: B å‚æ•°æ•æ„Ÿåº¦

**Key observations**:
- B è¶Šå¤§ï¼Œæ”¶ç›Šè¶Šé«˜ä½†è¾¹é™…é€’å‡æ•ˆæœè¶Šå¼±
- B=1000 æ˜¯æ”¶ç›Š-å…¬å¹³æ€§çš„å¹³è¡¡ç‚¹
- B=100 æ—¶æ”¶ç›ŠæŸå¤±è¾ƒå¤§ï¼ˆ-6%ï¼‰ï¼Œå…¬å¹³æ€§æœ€ä½³

### Fig 5: Scale Effect
![](../img/mvp21_scale_effect.png)

**What it shows**: è§„æ¨¡æ•ˆåº”

**Key observations**:
- å°è§„æ¨¡ï¼ˆ1K usersï¼‰æ—¶å‡¹æ”¶ç›Šç•¥ä¼˜ï¼ˆ+0.65%ï¼‰
- è§„æ¨¡å¢å¤§åå‡¹æ”¶ç›ŠåŠ£åŠ¿æ”¾å¤§ï¼ˆ50K: -13.7%ï¼‰
- **è§„æ¨¡è¶Šå¤§ï¼Œè´ªå¿ƒä¼˜åŠ¿è¶Šæ˜æ˜¾**

### Fig 6: Lorenz Curves by Policy
![](../img/mvp21_lorenz_by_policy.png)

**What it shows**: æ´›ä¼¦å…¹æ›²çº¿å¯¹æ¯”

**Key observations**:
- Concave_exp æ›²çº¿æœ€æ¥è¿‘å¯¹è§’çº¿ï¼ˆæœ€å…¬å¹³ï¼‰
- Greedy å’Œ Concave_log æ¥è¿‘
- Random åè€Œå…¬å¹³æ€§è¾ƒå·®

---

# 5. ğŸ’¡ æ´è§ï¼ˆè§£é‡Š"ä¸ºä»€ä¹ˆä¼šè¿™æ ·"ï¼‰

## 5.1 æœºåˆ¶å±‚ï¼ˆMechanism)
- **å‡¹æ”¶ç›Šåˆ†é…çš„ç†è®ºä¼˜åŠ¿åœ¨å®è·µä¸­è¢«ç¨€é‡Š**ï¼šè¾¹é™…é€’å‡è™½ç„¶ä¿ƒè¿›å…¬å¹³ï¼Œä½†ç‰ºç‰²äº†æ•´ä½“æ•ˆç‡
- **æ¨¡æ‹Ÿå™¨ç¯å¢ƒä¸‹è´ªå¿ƒå·²æ¥è¿‘æœ€ä¼˜**ï¼šå› ä¸ºåŒ¹é…åº¦æ˜¯æ”¶ç›Šçš„ä¸»è¦é©±åŠ¨åŠ›

## 5.2 å®éªŒå±‚ï¼ˆDiagnostics)
- **é¥±å’Œå‹ > å¯¹æ•°å‹**ï¼šå¯¹æ•°å‹è¾¹é™…é€’å‡è¿‡å¿«ï¼Œå¯¼è‡´æ”¶ç›Šå¤§å¹…ä¸‹é™
- **B å‚æ•°éœ€è¦æ ¹æ®ä¸šåŠ¡è§„æ¨¡è°ƒä¼˜**ï¼šB å¤ªå°æŸå¤±æ”¶ç›Šï¼Œå¤ªå¤§å¤±å»å…¬å¹³æ€§è°ƒèŠ‚

## 5.3 è®¾è®¡å±‚ï¼ˆSo what)
- **è§„æ¨¡æ•ˆåº”æ”¾å¤§è´ªå¿ƒä¼˜åŠ¿**ï¼šå¤§è§„æ¨¡æ—¶å‡¹æ”¶ç›Šçš„"æ¢ç´¢"æˆæœ¬æ›´é«˜
- **Gate-2 å†³ç­–**ï¼šç®€åŒ–ä¸º Greedy + ç¡¬çº¦æŸï¼Œæ”¾å¼ƒå¤æ‚çš„å‡¹æ”¶ç›Šè®¾è®¡

---

# 6. ğŸ“ ç»“è®º & ä¸‹ä¸€æ­¥

## 6.1 æ ¸å¿ƒå‘ç°ï¼ˆpunch lineï¼‰
> **å‡¹æ”¶ç›Šåˆ†é…çš„æ”¶ç›Šæå‡ä¸æ˜¾è‘—ï¼ˆ-1.17%ï¼‰ï¼Œä½†å…¬å¹³æ€§æœ‰æ”¹å–„ï¼ˆGini -0.018ï¼‰ï¼›Gate-2 å†³å®šç®€åŒ–ä¸ºè´ªå¿ƒ+ç¡¬çº¦æŸ**

- âŒ DG3: æ”¶ç›Šæå‡æœªè¾¾ 10% é˜ˆå€¼
- âœ… å…¬å¹³æ€§æ”¹å–„: Gini ç³»æ•°ä¸‹é™ 0.018
- **Decision**: ç®€åŒ–ä¸º Greedy + ç¡¬çº¦æŸ

## 6.2 å…³é”®ç»“è®ºï¼ˆ2-5 æ¡ï¼‰

| # | ç»“è®º | è¯æ®ï¼ˆå›¾/è¡¨/æ•°å­—ï¼‰ | é€‚ç”¨èŒƒå›´ |
|---|------|-------------------|---------|
| 1 | **å‡¹æ”¶ç›Šæ”¶ç›Šè¾¹é™…** | Î” Revenue = -1.17% | SimulatorV1 |
| 2 | **å…¬å¹³æ€§æœ‰æ”¹å–„** | Î” Gini = -0.018 | é€šç”¨ |
| 3 | **é¥±å’Œå‹ä¼˜äºå¯¹æ•°å‹** | -1.17% vs -8.28% | å‡¹å‡½æ•°é€‰æ‹© |
| 4 | **è§„æ¨¡è´Ÿæ•ˆåº”** | 50K users: -13.7% | å¤§è§„æ¨¡åœºæ™¯ |

## 6.3 Trade-offsï¼ˆÎ”+ vs Î”-ï¼‰

| Upside (Î”+) | Cost / Constraint (Î”-) | When acceptable |
|-------------|--------------------------|----------------|
| Gini -0.018 | æ”¶ç›Š -1.17% | å…¬å¹³æ€§ä¼˜å…ˆåœºæ™¯ |
| Coverage +1.5% | å¤æ‚åº¦å¢åŠ  | å¤šæ ·æ€§éœ€æ±‚ |

## 6.4 ä¸‹ä¸€æ­¥ï¼ˆå¯æ‰§è¡Œä»»åŠ¡ï¼‰

| Priority | Task | Owner | Link |
|----------|------|-------|------|
| ğŸ”´ P0 | Gate-2 æ›´æ–°ï¼šç®€åŒ–ä¸º Greedy + ç¡¬çº¦æŸ | - | - |
| ğŸ”´ P0 | Hub æ›´æ–°ï¼šå…³é—­ DG3 | - | - |
| ğŸŸ¡ P1 | MVP-2.2 å†·å¯åŠ¨/å…¬å¹³çº¦æŸ | - | - |

---

# 7. ğŸ“ é™„å½•ï¼ˆå¤ç°/å®¡è®¡ç”¨ï¼‰

## 7.1 æ•°å€¼ç»“æœï¼ˆå…¨é‡ï¼‰

| Policy | Revenue | Gini | Top-10% | Coverage | Î” Rev % | Î” Gini |
|--------|---------|------|---------|----------|---------|--------|
| random | 113,419 | 0.587 | 0.610 | 0.527 | -55.48% | +0.058 |
| greedy | 254,752 | 0.529 | 0.440 | 0.899 | 0.00% | 0.000 |
| concave_log | 233,659 | 0.549 | 0.446 | 1.000 | -8.28% | +0.020 |
| **concave_exp** | **251,783** | **0.512** | **0.421** | 0.985 | **-1.17%** | **-0.018** |
| greedy_with_cap | 254,711 | 0.529 | 0.440 | 0.899 | -0.02% | -0.000 |

### å‚æ•°æ•æ„Ÿåº¦ (B)

| B | Revenue | Gini | Coverage |
|---|---------|------|----------|
| 100 | 236,254 | 0.526 | 1.000 |
| 500 | 240,708 | 0.505 | 0.997 |
| 1000 | 245,767 | 0.506 | 0.984 |
| 5000 | 248,901 | 0.505 | 0.938 |
| 10000 | 250,517 | 0.511 | 0.925 |

### è§„æ¨¡æ•ˆåº”

| N Users | Greedy | Concave_log | Î” Revenue | Î” % |
|---------|--------|-------------|-----------|-----|
| 1,000 | 65,258 | 65,683 | +425 | +0.65% |
| 5,000 | 130,583 | 125,206 | -5,377 | -4.12% |
| 10,000 | 248,600 | 232,627 | -15,973 | -6.43% |
| 50,000 | 1,094,916 | 945,280 | -149,636 | -13.67% |

## 7.2 æ‰§è¡Œè®°å½•ï¼ˆå¿…é¡»åŒ…å«å¯å¤åˆ¶å‘½ä»¤ï¼‰

| Item | Value |
|------|-------|
| Repo | `~/GiftLive` |
| Script | `scripts/train_concave_allocation.py` |
| Config | å†…ç½® |
| Output | `gift_allocation/results/concave_allocation_20260108.json` |

```bash
# (1) setup
cd ~/GiftLive
source init.sh

# (2) run
nohup python scripts/train_concave_allocation.py > logs/mvp21_concave_allocation_20260108.log 2>&1 &

# (3) check progress
tail -f logs/mvp21_concave_allocation_20260108.log

# (4) view results
cat gift_allocation/results/concave_allocation_20260108.json
```

## 7.3 è¿è¡Œæ—¥å¿—æ‘˜è¦ / Debugï¼ˆå¯é€‰ï¼‰

| Issue | Root cause | Fix |
|------|------------|-----|
| - | - | - |

---

> **å®éªŒå®Œæˆæ—¶é—´**: 2026-01-08
