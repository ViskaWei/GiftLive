# 🧪 Simulator V2 - 金额分布校准
> **Name:** Simulator V2 Amount Calibration  
> **ID:** `EXP-14`  
> **Topic:** `gift_allocation` | **MVP:** MVP-4.1  
> **Author:** Viska Wei | **Date:** 2026-01-09 | **Status:** ✅ Gate-4A 通过  

> 🎯 **Target:** 校准 Simulator V2 的金额分布，使分位数误差降至 <30%  
> 🚀 **Next:** 继续 MVP-4.2 (并发容量建模)

## ⚡ 核心结论速览

> **一句话**: V2+ 离散档位模型成功校准 - P50=0%, P90=13%, P99=26%, Mean=24% 误差，全部通过 <30% 阈值

| 验证问题 | 结果 | 结论 |
|---------|------|------|
| 离散档位能否校准金额分布? | ✅ 通过 | 所有指标误差 <30%，Gate-4A 通过 |

| 指标 | 真实值 | V1 模拟 | V1 误差 | V2+ 模拟 | V2+ 误差 | 状态 |
|------|--------|---------|---------|----------|----------|------|
| P50 (Median) | 2.0 | 46.1 | 2204% | **2.0** | **0.0%** | ✅ |
| P90 | 88.0 | 536.8 | 510% | 76.3 | **13.2%** | ✅ |
| P99 | 1488.0 | 6985.2 | 369% | 1101.0 | **26.0%** | ✅ |
| Mean | 82.7 | 490.9 | 494% | 62.9 | **24.0%** | ✅ |
| User Gini | 0.942 | 0.816 | 13.4% | 0.887 | 5.8% | ✅ |

| Type | Link |
|------|------|
| 🧠 Hub | `gift_allocation/gift_allocation_hub.md` § H4.1 |
| 🗺️ Roadmap | `gift_allocation/gift_allocation_roadmap.md` § MVP-4.1 |
| 📋 Charter | `gift_allocation/gift_allocation_phase4_charter.md` § Gate-4A |

---
# 1. 🎯 目标

**问题**: V1 Simulator 的金额分布误差极大 (P50: 2204%, P90: 510%)，无法准确模拟真实打赏场景

**验证假设**: H4.1 - 分位数匹配 + Lognormal/Pareto 混合分布可校准金额分布

| 预期 | 判断标准 |
|------|---------|
| P50/P90 误差 < 30% | 通过 → Gate-4A 开启 |
| P99 误差 < 50% | 通过 → 继续 MVP-4.2 |
| 误差仍大 | 需调整分布或参数 |

---

# 2. 🦾 算法

## 2.1 V1 模型 (Baseline)

$$Y|(\text{gift}=1) = \exp\left(\mu_0 + \mu_1 \log(w_u) + \mu_2 (p_u \cdot q_s) + \epsilon\right)$$

问题：用户财富和匹配度决定金额，但未考虑真实数据的分位数分布

## 2.2 V2 模型 (Quantile Matching)

**混合分布采样**:
1. 以概率 0.9 采样 Lognormal (小额)
2. 以概率 0.1 采样 Pareto (大额)

**参数推导**:
- Lognormal: $\mu = \log(2) = 0.693$ (for P50=2), $\sigma = 2.96$ (for P90=88)
- Pareto: threshold=88, $\alpha=0.55$ (for heavy tail)

---

# 3. 🧪 实验设计

## 3.1 数据

| 项 | 值 |
|----|-----|
| 来源 | KuaiLive 真实数据统计 (MVP-0.1 EDA) |
| 校准目标 | P50=2, P90=88, P99=1488, Mean=82.7 |
| User Gini | 0.942 |

## 3.2 模型

| 版本 | 金额分布 | 参数 |
|------|---------|------|
| V1 | 纯 Lognormal (用户特征驱动) | mu0=0.5, mu1=0.9, sigma=1.5 |
| V2 | Lognormal + Pareto (分位数匹配) | lognormal_mu=0.693, sigma=2.96, pareto_alpha=0.55 |
| V2+ | 优化后混合分布 | lognormal_mu=0.0, sigma=1.5, pareto_alpha=0.8 |

## 3.3 实验

| 实验 | 配置 |
|------|------|
| V1 vs V2 对比 | 各 100 次模拟, 50 rounds, 200 users/round |
| 参数敏感性 | pareto_alpha ∈ [0.4, 0.8], lognormal_sigma ∈ [1.0, 3.0] |

---

# 4. 📊 图表

### Fig 1: Quantile Comparison
![](../img/mvp41_quantile_comparison.png)

**观察**:
- V1 所有分位数都严重高估 (2-10倍)
- V2 在 P50 和 P90 上明显改善
- V2+ 在 P99 上有所改善但 P90 反而恶化

### Fig 2: Error Comparison
![](../img/mvp41_error_comparison.png)

**观察**:
- V1 → V2: P50 误差从 2204% 降至 58% (改进 97%)
- V1 → V2: P90 误差从 510% 降至 27% ✅ (改进 95%)
- V2 P99 误差反增，说明 Pareto 尾部参数需优化

### Fig 3: Amount Distribution
![](../img/mvp41_amount_distribution.png)

**观察**:
- V2 分布更接近真实数据的重尾特性
- V2 Median 接近目标值 2.0
- 尾部仍有过多极大值

### Fig 4: CDF Comparison
![](../img/mvp41_cdf_comparison.png)

**观察**:
- V2 CDF 曲线在 P90 之前与目标接近
- P99 区域 V2 仍偏离目标

### Fig 5: Gate-4A Summary
![](../img/mvp41_gate4a_summary.png)

**观察**:
- Gate-4A 判定: ⚠️ 部分通过
- P90 通过阈值 (<30%)
- P50 和 P99 未达标

---

# 5. 💡 洞见

## 5.1 宏观
- **分位数匹配方法有效**: 相比 V1 的特征驱动模型，V2 的分位数匹配在 body 部分 (P50-P90) 显著改善
- **尾部建模困难**: P99 校准失败说明极端重尾分布难以用简单 Pareto 捕获

## 5.2 模型层
- Lognormal + Pareto 混合是正确方向，但需要:
  1. 更精确的阈值选择 (不一定是 P90)
  2. 可能需要 Generalized Pareto Distribution (GPD) 替代标准 Pareto
  3. 尾部权重需要调整 (当前 10% 可能过高)

## 5.3 细节
- User Gini 从 V1 的 0.816 提升到 V2 的 0.912，更接近真实值 0.942
- 这表明 V2 的金额分布确实更"不平等"，符合真实场景

---

# 6. 📝 结论

## 6.1 核心发现
> **V2+ 离散档位模型成功校准所有指标，Gate-4A 通过**

- ✅ P50 误差: 2204% → **0.0%** (完美匹配)
- ✅ P90 误差: 510% → **13.2%** (通过 <30% 阈值)
- ✅ P99 误差: 369% → **26.0%** (通过 <50% 阈值)
- ✅ Mean 误差: 494% → **24.0%** (通过 <30% 阈值)

## 6.2 关键结论

| # | 结论 | 证据 |
|---|------|------|
| 1 | **离散档位优于连续分布** | V2+ 所有指标通过，V2 仅 P90 通过 |
| 2 | **档位概率可精细调校** | v4 权重 (0.38, 0.32, 0.15...) 成功匹配真实分布 |
| 3 | **User Gini 接近真实** | 0.816 → 0.887 (接近真实 0.942) |

## 6.3 Gate-4A 判定

| 指标 | V2+ 误差 | 阈值 | 结果 |
|------|----------|------|------|
| P50 | **0.0%** | <30% | ✅ |
| P90 | **13.2%** | <30% | ✅ |
| P99 | **26.0%** | <50% | ✅ |
| Mean | **24.0%** | <30% | ✅ |

**决策**: ✅ Gate-4A 通过 → 继续 MVP-4.2 (并发容量建模)

## 6.4 设计启示

| 原则 | 建议 |
|------|------|
| 尾部建模 | 考虑使用 GPD 或分段 Pareto |
| 阈值选择 | 可尝试 P75/P80 作为分界而非 P90 |
| 混合权重 | 降低尾部权重至 5% |

## 6.5 关键数字

| 指标 | 值 | 条件 |
|------|-----|------|
| V2+ P50 误差 | **0.0%** ✅ | 100 simulations |
| V2+ P90 误差 | **13.2%** ✅ | 100 simulations |
| V2+ P99 误差 | **26.0%** ✅ | 100 simulations |
| V2+ Mean 误差 | **24.0%** ✅ | 100 simulations |
| User Gini | 0.887 | V2+, 接近真实 0.942 |

## 6.6 下一步

| 方向 | 任务 | 优先级 |
|------|------|--------|
| MVP-4.2 | 并发容量建模 | 🔴 P0 |
| MVP-4.3 | 召回-精排分工 | 🟡 P1 |
| MVP-4.4 | 供需匹配/影子价格 | 🟡 P1 |

---

# 7. 📎 附录

## 7.1 数值结果

| 版本 | P50 | P90 | P99 | Mean | User Gini | 状态 |
|------|-----|-----|-----|------|-----------|------|
| 真实数据 | 2.0 | 88.0 | 1488.0 | 82.7 | 0.942 | - |
| V1 | 46.1 | 536.8 | 6985.2 | 490.9 | 0.816 | ❌ |
| V2 | 3.2 | 111.9 | 10168.0 | 461.7 | 0.912 | ⚠️ |
| **V2+ (v4)** | **2.0** | **76.3** | **1101.0** | **62.9** | **0.887** | **✅** |

## 7.2 执行记录

| 项 | 值 |
|----|-----|
| 脚本 | `scripts/run_simulator_experiments.py --mvp 4.1` |
| Simulator | `scripts/simulator/simulator.py` (V2 enabled) |
| Output | `gift_allocation/results/simulator_v2_amount_20260109.json` |

```bash
# 运行实验
source init.sh
python scripts/run_simulator_experiments.py --mvp 4.1 --n_sim 100
```

## 7.3 V2+ 配置 (最终采用)

```python
# V2+ 离散档位参数 (v4)
v2plus_tiers = (1, 2, 10, 52, 100, 520, 1000, 1314, 5200, 13140)
v2plus_tier_probs = (0.38, 0.32, 0.15, 0.08, 0.035, 0.022, 0.008, 0.003, 0.0015, 0.0005)
v2plus_wealth_scale = 0.10  # 用户财富影响档位选择
v2plus_match_scale = 0.05   # 用户-主播匹配影响档位选择
```

---

> **实验完成时间**: 2026-01-09
