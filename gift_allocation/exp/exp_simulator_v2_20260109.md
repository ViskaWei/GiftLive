<!--
ğŸ“ Agent ä¹¦å†™è§„èŒƒï¼ˆä¸å‡ºç°åœ¨æ­£æ–‡ï¼‰:
- Header å…¨è‹±æ–‡
- æ­£æ–‡ä¸­æ–‡
- å›¾è¡¨æ–‡å­—å…¨è‹±æ–‡ï¼ˆä¸­æ–‡ä¼šä¹±ç ï¼‰
- å…¬å¼ç”¨ LaTeX: $inline$ æˆ– $$block$$
-->

# ğŸƒ Simulator V2 Enhanced
> **Name:** Simulator V2 Enhanced - Discrete Gift Tiers  \
> **ID:** `VIT-20260109-gift_allocation-14`  \
> **Topic:** `gift_allocation` | **MVP:** MVP-4.1+ | **Project:** `VIT`  \
> **Author:** Viska Wei | **Date:** 2026-01-09 | **Status:** âœ… Completed
>
> ğŸ¯ **Target:** è§£å†³ V1 é‡‘é¢åˆ†å¸ƒå¤±çœŸé—®é¢˜ï¼Œå¼•å…¥ç¦»æ•£é‡‘é¢æ¡£ä½æ ¡å‡†  \
> ğŸš€ **Decision / Next:** âœ… Gate-4A PASS â†’ ç»§ç»­ MVP-4.2ï¼ˆå¹¶å‘å®¹é‡å»ºæ¨¡ï¼‰

---

## âš¡ æ ¸å¿ƒç»“è®ºé€Ÿè§ˆï¼ˆä¾› main æå–ï¼›â‰¤30è¡Œï¼›å¿…å« I/O + Run TL;DRï¼‰

> **ä¸€å¥è¯**: V2+ ç¦»æ•£æ¡£ä½æ¨¡å‹æˆåŠŸæ ¡å‡†é‡‘é¢åˆ†å¸ƒï¼ŒP50/P90/Mean è¯¯å·®å‡<30%ï¼ŒGate-4A é€šè¿‡

### 0.1 è¿™å®éªŒåˆ°åº•åœ¨åšä»€ä¹ˆï¼Ÿï¼ˆX := ç®—æ³•/æœºåˆ¶ â†’ ç›®æ ‡ | Why+How | I/O | Trade-offï¼‰

$$
X := \underbrace{\text{ç¦»æ•£æ¡£ä½æ¨¡å‹}}_{\text{V2+ é‡‘é¢åˆ†å¸ƒ}}\ \xrightarrow[\text{æ›¿ä»£}]{\ \text{çœŸå®ç¤¼ç‰©ä»·æ ¼æ¡£}\ }\ \underbrace{\text{P50/P90/Mean æ ¡å‡†}}_{\text{è¯¯å·®<30\%}}\ \big|\ \underbrace{\text{Why ğŸ©¸}}_{\text{V1é‡‘é¢å¤±çœŸ}} + \underbrace{\text{How ğŸ’§}}_{\text{æ¡£ä½æ¦‚ç‡åˆ†é…}}
$$
- **ğŸ» What (æ˜¯ä»€ä¹ˆ)**: V2+ ç¦»æ•£æ¡£ä½æ¨¡å‹ï¼šç”¨çœŸå®ç¤¼ç‰©ä»·æ ¼æ¡£(1/10/52/100/520...)æ›¿ä»£è¿ç»­åˆ†å¸ƒ
- **ğŸ æ ¸å¿ƒæœºåˆ¶**: Categorical åˆ†å¸ƒé€‰æ‹©æ¡£ä½ï¼Œè´¢å¯Œ/åŒ¹é…åº¦è°ƒèŠ‚æ¡£ä½æ¦‚ç‡
- **â­ ç›®æ ‡**: ä¿®å¤ V1 é‡‘é¢åˆ†å¸ƒå¤±çœŸï¼ˆP50 è¯¯å·® 2163%ï¼‰
- **ğŸ©¸ Whyï¼ˆç—›ç‚¹ï¼‰**: V1 ç”¨è¿ç»­åˆ†å¸ƒï¼Œä½†çœŸå®ç¤¼ç‰©æ˜¯å›ºå®šä»·æ ¼æ¡£
- **ğŸ’§ Howï¼ˆéš¾ç‚¹ï¼‰**: æ¡£ä½æ¦‚ç‡åˆ†é…éœ€åŒ¹é…çœŸå®åˆ†ä½æ•°
$$
\underbrace{\text{I/O ğŸ«}}_{\text{é…ç½®â†’é‡‘é¢åˆ†å¸ƒ}}\ =\ \underbrace{0\% \text{P50è¯¯å·®}}_{\text{å®Œç¾æ ¡å‡†}}\ -\ \underbrace{27\% \text{Meanè¯¯å·®}}_{\text{å¯æ¥å—}}
$$
**I/Oï¼ˆå¿…é¡»å†™æ¸…æ¥šï¼Œè¯»è€…é è¿™ä¸€æ®µç†è§£å®éªŒ"åœ¨å¹²å˜›"ï¼‰**

| ç±»å‹ | ç¬¦å· | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| ğŸ« è¾“å…¥ | $\mathcal{T}$ | ç¦»æ•£æ¡£ä½é…ç½® | (1,2,10,52,100,520,1000,1314,5200,13140) |
| ğŸ« è¾“å…¥ | $\pi_k^{(base)}$ | åŸºç¡€æ¡£ä½æ¦‚ç‡ | (0.38,0.32,0.15,...) |
| ğŸ« è¾“å‡º | $Q_{50}, Q_{90}, Q_{99}$ | åˆ†ä½æ•° | æ¨¡æ‹Ÿé‡‘é¢åˆ†å¸ƒ |
| ğŸ“Š æŒ‡æ ‡ | $\epsilon_{P50}, \epsilon_{Mean}$ | åˆ†ä½æ•°è¯¯å·® | 0%, 27% |
| ğŸ åŸºçº¿ | $V1, V2, Real$ | å¯¹ç…§ç»„ | lognormal, lognormal+pareto, KuaiLive |

### 0.2 Pipeline TL;DRï¼ˆ5-10 è¡Œæç®€ä¼ªä»£ç ï¼Œä¸€çœ¼çœ‹æ‡‚åœ¨è·‘ä»€ä¹ˆï¼‰

```
1. åˆå§‹åŒ– 3 ç‰ˆæ¨¡æ‹Ÿå™¨ï¼šV1(lognormal) / V2(lognormal+pareto) / V2+(ç¦»æ•£æ¡£ä½)
2. ç¦»æ•£æ¡£ä½é…ç½®ï¼š(1,2,10,52,100,520,1000,1314,5200,13140) å…± 10 çº§
3. æ ¸å¿ƒå¾ªç¯ï¼š
   for each ç‰ˆæœ¬:
       for 50 æ¬¡æ¨¡æ‹Ÿ:
           for 50 è½® Ã— 200 ç”¨æˆ·:
               ç”¨æˆ·åˆ°è¾¾ â†’ Greedy åˆ†é… â†’ è§‚å¯Ÿæ‰“èµ
               â†’ å•æ­¥è¾“å‡º: {'user_id': 0, 'streamer_id': 42, 'did_gift': True, 'amount': 52.0}
4. å¾ªç¯åè¾“å‡ºï¼štrajectory = [{'user_id':0, 'streamer_id':42, 'amount':52.0, ...}, ...] (å…± 10000 æ¡)
5. è¯„ä¼°ï¼šæå–æ‰€æœ‰ amount è®¡ç®—åˆ†ä½æ•° P50/P90/P99/Meanï¼Œå¯¹æ¯”çœŸå® {P50:2, P90:88, Mean:82.7}
6. Gate-4A åˆ¤å®šï¼šP50/P90/Mean è¯¯å·® <30% â†’ PASS
7. è½ç›˜ï¼šgift_allocation/results/simulator_v2_amount_20260109.json
```

> âš ï¸ **å¤ç°å‘½ä»¤** â†’ è§ Â§7.2 é™„å½•
> ğŸ“– **è¯¦ç»†ä¼ªä»£ç ** â†’ è§ Â§2.4.2

### 0.3 å¯¹å‡è®¾/éªŒè¯é—®é¢˜çš„å›ç­”

| éªŒè¯é—®é¢˜ | ç»“æœ | ç»“è®º |
|---------|------|------|
| H4.1.1: ç¦»æ•£æ¡£ä½èƒ½å¦ä¿®å¤ P50/P90 è¯¯å·®? | âœ… | P50=0%, P90=23%, Mean=27% |
| H4.1.2: V2+ æ˜¯å¦ä¼˜äº V2 (lognormal+pareto)? | âœ… | V2+ Mean è¯¯å·® 27% vs V2 375% |
| H4.1.3: æ ¡å‡†åæ¨¡æ‹Ÿå™¨æ˜¯å¦å¯ç”¨? | âœ… | Gate-4A PASS |

### 0.4 å…³é”®æ•°å­—ï¼ˆåªæ”¾æœ€é‡è¦çš„ 3-5 ä¸ªï¼‰

| Metric | V1 è¯¯å·® | V2 è¯¯å·® | V2+ è¯¯å·® | ç›®æ ‡ |
|--------|---------|---------|----------|------|
| P50 | 2163% | 55% | **0%** âœ… | <30% |
| P90 | 496% | 29% âœ… | **23%** âœ… | <30% |
| P99 | 216% | 506% | 33% | <50% |
| Mean | 322% | 375% | **27%** âœ… | <30% |

### 0.5 Links

| Type | Link |
|------|------|
| ğŸ§  Hub | `gift_allocation/gift_allocation_hub.md` Â§ Q3.2 |
| ğŸ—ºï¸ Roadmap | `gift_allocation/gift_allocation_roadmap.md` Â§ MVP-4.1 |
| ğŸ“‹ Charter | `gift_allocation/gift_allocation_phase4_charter.md` |

---

# 1. ğŸ¯ ç›®æ ‡

**æ ¸å¿ƒé—®é¢˜**: V1 æ¨¡æ‹Ÿå™¨é‡‘é¢åˆ†å¸ƒä¸¥é‡å¤±çœŸï¼Œéœ€è¦ä¿®å¤

**å¯¹åº” main / roadmap**:
- éªŒè¯é—®é¢˜ï¼šH4.1.1, H4.1.2, H4.1.3
- Gateï¼šGate-4A

## 1.1 æˆåŠŸæ ‡å‡†ï¼ˆéªŒæ”¶ / stop ruleï¼‰

| åœºæ™¯ | é¢„æœŸç»“æœ | åˆ¤æ–­æ ‡å‡† |
|------|---------|---------|
| âœ… é€šè¿‡ | P50/P90/Mean è¯¯å·®<30% | Gate-4A PASSï¼Œç»§ç»­åç»­å®éªŒ |
| âŒ å¦å†³ | è¯¯å·®ä»>30% | éœ€è¿›ä¸€æ­¥è°ƒå‚æˆ–å¼•å…¥æ–°æœºåˆ¶ |
| âš ï¸ å¼‚å¸¸ | åˆ†å¸ƒå½¢çŠ¶ä¸åŒ¹é… | æ£€æŸ¥æ¡£ä½æ¦‚ç‡ |

---

# 2. ğŸ¦¾ æ–¹æ³•ï¼ˆç®—æ³• + I/O + å®éªŒæµç¨‹ï¼‰

## 2.1 ç®—æ³•

> ğŸ“Œ **ç»“æ„**ï¼š2.1.1 æ ¸å¿ƒç®—æ³• â†’ 2.1.2 ç¬¦å·è¡¨ï¼ˆå˜é‡å®šä¹‰+å–å€¼èŒƒå›´ï¼‰â†’ 2.1.3 è¾…åŠ©å…¬å¼ï¼ˆäºŒçº§è®¡ç®—ï¼‰

### 2.1.1 æ ¸å¿ƒç®—æ³•

**ç¦»æ•£æ¡£ä½é€‰æ‹©**ï¼š

$$\text{tier}_k \sim \text{Categorical}(\pi_1, \pi_2, ..., \pi_K)$$

**ç›´è§‰è§£é‡Š**ï¼š
- çœŸå®ç¤¼ç‰©æœ‰å›ºå®šä»·æ ¼æ¡£ï¼Œè¿ç»­åˆ†å¸ƒæ— æ³•å‡†ç¡®æ¨¡æ‹Ÿ
- ç¦»æ•£æ¡£ä½é€šè¿‡æ¦‚ç‡åˆ†é…åŒ¹é…çœŸå®åˆ†ä½æ•°

### 2.1.2 ç¬¦å·è¡¨

> ğŸ’¡ **å…³é”®**ï¼šæ¯ä¸ªç¬¦å·éƒ½ç»™å‡ºå…·ä½“æ•°å€¼ä¾‹å­ï¼Œè®©è¯»è€…ç§’æ‡‚å˜é‡å«ä¹‰

| ç¬¦å· | å«ä¹‰ | ç±»å‹/å–å€¼èŒƒå›´ | è®¡ç®—/æ¥æº | å…·ä½“æ•°å€¼ä¾‹å­ |
|------|------|--------------|-----------|-------------|
| $K$ | æ¡£ä½æ€»æ•° | int, $K=10$ | å¸¸é‡ï¼ˆ10 çº§æ¡£ä½ï¼‰ | `K=10` |
| $\text{tier}_k$ | ç¬¬ $k$ æ¡£é‡‘é¢ | int, 10 çº§ | å¸¸é‡ï¼ˆçœŸå®ç¤¼ç‰©ä»·æ ¼ï¼‰ | `tiers=(1,2,10,52,100,520,1000,1314,5200,13140)` |
| $\pi_k$ | ç¬¬ $k$ æ¡£æ¦‚ç‡ | float, $\pi_k \in (0,1)$, $\sum_k \pi_k = 1$ | è§ Â§2.1.3 æ¦‚ç‡è®¡ç®— | `Ï€=(0.38,0.32,0.15,0.08,...)` |
| $p_k^{(\text{base})}$ | åŸºç¡€æ¡£ä½æ¦‚ç‡ | float, ä»çœŸå®æ•°æ®æ‹Ÿåˆ | å¸¸é‡ | `p_base=(0.38,0.32,0.15,...)` |
| $w_u$ | ç”¨æˆ·è´¢å¯Œ | float, $w_u > 0$ | Pareto åˆ†å¸ƒé‡‡æ · | `w_u=1523.5`ï¼ˆå…ƒï¼‰ |
| $\alpha_w$ | è´¢å¯Œæ•ˆåº”å¼ºåº¦ | float, é»˜è®¤ 0.10 | è¶…å‚æ•° | `Î±_w=0.10` |
| $\alpha_m$ | åŒ¹é…æ•ˆåº”å¼ºåº¦ | float, é»˜è®¤ 0.05 | è¶…å‚æ•° | `Î±_m=0.05` |
| $\text{match}(u,s)$ | ç”¨æˆ·-ä¸»æ’­åŒ¹é…åº¦ | float, $[-1,1]$ | ä½™å¼¦ç›¸ä¼¼åº¦ | `match(user_0, streamer_42)=0.73` |

**æ¡£ä½è®¾è®¡**ï¼ˆåŸºäº KuaiLive æ•°æ®ï¼‰:

| æ¡£ä½ $k$ | é‡‘é¢ $\text{tier}_k$ | åŸºç¡€æ¦‚ç‡ $p_k^{(\text{base})}$ | å¤‡æ³¨ |
|----------|---------------------|-------------------------------|------|
| 1 | 1 | 0.38 | æœ€å°ç¤¼ç‰© |
| 2 | 2 | 0.32 | å°é¢ |
| 3 | 10 | 0.15 | å¸¸è§å°é¢ |
| 4 | 52 | 0.08 | 520 å¯“æ„ |
| 5 | 100 | 0.035 | æ•´æ•°å…³å£ |
| 6 | 520 | 0.022 | æˆ‘çˆ±ä½  |
| 7 | 1000 | 0.008 | åƒå…ƒç¤¼ |
| 8 | 1314 | 0.003 | ä¸€ç”Ÿä¸€ä¸– |
| 9 | 5200 | 0.0015 | è¶…çº§ç¤¼ç‰© |
| 10 | 13140 | 0.0005 | é¡¶çº§ç¤¼ç‰© |

### 2.1.3 è¾…åŠ©å…¬å¼

**æ¡£ä½æ¦‚ç‡è®¡ç®—ï¼ˆè´¢å¯Œ+åŒ¹é…è°ƒèŠ‚ï¼‰**ï¼š

$$\pi_k = \text{softmax}\left( \log(p_k^{(\text{base})}) + \alpha_w \cdot \log(w_u) \cdot \frac{k}{K} + \alpha_m \cdot \text{match}(u,s) \right)$$

- **ç”¨é€”**: æ ¹æ®ç”¨æˆ·è´¢å¯Œå’ŒåŒ¹é…åº¦è°ƒèŠ‚æ¡£ä½æ¦‚ç‡
- **è¾“å…¥**: åŸºç¡€æ¦‚ç‡ $p_k^{(\text{base})}$ï¼Œç”¨æˆ·è´¢å¯Œ $w_u$ï¼ŒåŒ¹é…åº¦ $\text{match}(u,s)$
- **è¾“å‡º**: è°ƒèŠ‚åæ¦‚ç‡ $\pi_k$ï¼Œå¯Œç”¨æˆ·æ›´å¯èƒ½é€‰æ‹©é«˜æ¡£ä½

**Softmax å½’ä¸€åŒ–**ï¼š

$$\text{softmax}(z)_k = \frac{\exp(z_k)}{\sum_{j=1}^{K} \exp(z_j)}$$

- **ç”¨é€”**: å°† logits è½¬æ¢ä¸ºæœ‰æ•ˆæ¦‚ç‡åˆ†å¸ƒ
- **è¾“å…¥**: logits å‘é‡ $z$
- **è¾“å‡º**: æ¦‚ç‡å‘é‡ï¼Œæ»¡è¶³ $\sum_k \pi_k = 1$

## 2.2 è¾“å…¥ / è¾“å‡ºï¼ˆå¿…å¡«ï¼šæ¯” 0.1 æ›´ç»†ä¸€ç‚¹ï¼‰

### I/O Schema

| Component | Type/Shape | Example | Notes |
|----------|------------|---------|------|
| gift_tiers | tuple | (1,2,10,52,100,520,1000,1314,5200,13140) | 10 çº§æ¡£ä½ |
| tier_probs | tuple | (0.38,0.32,0.15,...) | æ¡£ä½æ¦‚ç‡ |
| wealth_scale | float | 0.10 | è´¢å¯Œæ•ˆåº”å¼ºåº¦ |
| Output: amounts | ndarray | [1, 10, 52, 100, ...] | ç”Ÿæˆé‡‘é¢ |
| Output: quantiles | Dict | {P50: 2.0, P90: 68.1, ...} | åˆ†ä½æ•° |

### Assumptions & Constraints

| Assumption/Constraint | Why it matters | How handled |
|----------------------|----------------|------------|
| ç¤¼ç‰©æœ‰å›ºå®šä»·æ ¼æ¡£ | çœŸå®åœºæ™¯é™åˆ¶ | ç¦»æ•£ Categorical |
| è´¢å¯Œå½±å“æ¡£ä½é€‰æ‹© | å¯Œç”¨æˆ·é€å¤§é¢ | softmax è°ƒèŠ‚ |

## 2.3 å®ç°è¦ç‚¹ï¼ˆè¯»è€…èƒ½å¯¹ç…§ä»£ç å®šä½ï¼‰

| What | Where (file:function) | Key detail |
|------|------------------------|-----------|
| V2+ é‡‘é¢ç”Ÿæˆ | `scripts/simulator/simulator.py:generate_amount_v2plus` | ç¦»æ•£æ¡£ä½ |
| æ¡£ä½é…ç½® | `scripts/simulator/simulator.py:SimConfig` | amount_version=3 |
| Runner | `scripts/run_simulator_experiments.py:run_mvp41` | å®éªŒå…¥å£ |

## 2.4 å®éªŒæµç¨‹ï¼ˆå¿…å¡«ï¼šæ¨¡å—æ‹†è§£ + æ ¸å¿ƒå¾ªç¯å±•å¼€ + Code Pointerï¼‰

### 2.4.1 å®éªŒæµç¨‹æ ‘çŠ¶å›¾ï¼ˆå®Œæ•´å¯è§†åŒ–ï¼‰

> âš ï¸ **æ¯ä¸€æ­¥éƒ½å¸¦ I/O æ•°å€¼ä¾‹å­**ï¼Œè®©è¯»è€…ç§’æ‡‚ trajectory æ˜¯ä»€ä¹ˆ

```
Simulator V2+ ç¦»æ•£æ¡£ä½æ ¡å‡†å®éªŒ
â”‚
â”œâ”€â”€ 1. åˆå§‹åŒ– 3 ç‰ˆæ¨¡æ‹Ÿå™¨
â”‚   â”œâ”€â”€ V1ï¼šçº¯ Lognormalï¼ˆè¿ç»­åˆ†å¸ƒï¼‰
â”‚   â”œâ”€â”€ V2ï¼šLognormal + Paretoï¼ˆæ··åˆï¼‰
â”‚   â”œâ”€â”€ V2+ï¼šç¦»æ•£æ¡£ä½ï¼ˆ10 çº§çœŸå®ä»·æ ¼æ¡£ï¼‰
â”‚   â””â”€â”€ è¾“å‡º: sims = [SimV1, SimV2, SimV2+]ï¼ˆ3 ä¸ªæ¨¡æ‹Ÿå™¨å¯¹è±¡ï¼‰
â”‚
â”œâ”€â”€ 2. é…ç½®ç¦»æ•£æ¡£ä½
â”‚   â”œâ”€â”€ tiers = (1,2,10,52,100,520,1000,1314,5200,13140)
â”‚   â”œâ”€â”€ base_probs = (0.38,0.32,0.15,0.08,...)
â”‚   â”œâ”€â”€ è´¢å¯Œæ•ˆåº”ï¼šwealth_scale = 0.10
â”‚   â””â”€â”€ è¾“å‡º: config = {tiers: [...], probs: [...], wealth_scale: 0.10}
â”‚
â”œâ”€â”€ 3. æ ¸å¿ƒå¾ªç¯ â­ï¼ˆ50 æ¬¡æ¨¡æ‹Ÿå–å¹³å‡ï¼‰
â”‚   â”œâ”€â”€ å¤–å±‚ï¼šÃ— 3 ç‰ˆæœ¬ï¼ˆV1/V2/V2+ï¼‰
â”‚   â”œâ”€â”€ ä¸­å±‚ï¼šÃ— 50 æ¬¡æ¨¡æ‹Ÿ
â”‚   â””â”€â”€ å†…å±‚ï¼šÃ— 50 è½® Ã— 200 ç”¨æˆ·
â”‚       â”œâ”€â”€ Step 1: ç”¨æˆ·åˆ°è¾¾ â†’ user = {'id': 0, 'wealth': 1523.5}
â”‚       â”œâ”€â”€ Step 2: ç­–ç•¥åˆ†é… â†’ action = {'assigned_streamer': 42}
â”‚       â”œâ”€â”€ Step 3: é‡‘é¢ç”Ÿæˆ â†’ reward = {'did_gift': True, 'amount': 52.0}
â”‚       â””â”€â”€ Step 4: è®°å½• â†’ record = {'user_id': 0, 'streamer_id': 42, 'did_gift': True, 'amount': 52.0}
â”‚   â””â”€â”€ å¾ªç¯è¾“å‡º: trajectory = [record_1, record_2, ...] (å…± 50Ã—200=10000 æ¡)
â”‚       â””â”€â”€ ç¤ºä¾‹: [{'user_id':0, 'streamer_id':42, 'did_gift':True, 'amount':52.0}, ...]
â”‚
â”œâ”€â”€ 4. è¯„ä¼°
â”‚   â”œâ”€â”€ è¾“å…¥: trajectory (list of dicts)
â”‚   â”œâ”€â”€ æå–é‡‘é¢: amounts = [52.0, 0.0, 10.0, 1.0, ...] (åªå– did_gift=True çš„)
â”‚   â”œâ”€â”€ è®¡ç®—åˆ†ä½æ•°ï¼šP50=2.0, P90=68.1, P99=1002.6, Mean=60.7
â”‚   â”œâ”€â”€ è®¡ç®—è¯¯å·®ï¼švs çœŸå® {P50:2, P90:88, Mean:82.7} â†’ {0%, 23%, 27%}
â”‚   â””â”€â”€ è¾“å‡º: metrics = {'P50': 2.0, 'P90': 68.1, 'P50_error': 0.0, ...}
â”‚
â””â”€â”€ 5. è½ç›˜
    â”œâ”€â”€ ç»“æœï¼šgift_allocation/results/simulator_v2_amount_20260109.json
    â”œâ”€â”€ å›¾è¡¨ï¼šgift_allocation/img/mvp41_*.png
    â””â”€â”€ è¾“å‡ºç¤ºä¾‹: {"V1": {"P50": 45.3, "P50_error": 2163%}, "V2+": {"P50": 2.0, "P50_error": 0%}}
```

### 2.4.2 æ¨¡å—æ‹†è§£ï¼ˆè¯¦ç»†å±•å¼€æ¯ä¸ªæ¨¡å—ï¼Œå¸¦ Code Pointerï¼‰

| Module | Responsibility | Input â†’ Output | Code Pointer |
|--------|----------------|----------------|--------------|
| M1: init_simulators | åˆå§‹åŒ– V1/V2/V2+ | configs â†’ simulators | `simulator/simulator.py:GiftLiveSimulator` |
| M2: generate_amount | **æ ¸å¿ƒï¼šé‡‘é¢ç”Ÿæˆ** | user, tier_probs â†’ amount | `simulator/simulator.py:generate_amount_v2plus` |
| M3: run_simulation | è¿è¡Œæ¨¡æ‹Ÿ | sim + policy â†’ traj | `simulator/simulator.py:run` |
| M4: compute_quantiles | è®¡ç®—åˆ†ä½æ•° | amounts â†’ quantiles | `run_simulator_experiments.py:compute_quantiles` |
| M5: compute_errors | è®¡ç®—è¯¯å·® | sim, real â†’ errors | `run_simulator_experiments.py:compute_errors` |
| M6: save | è½ç›˜ | results â†’ json | `run_simulator_experiments.py:save_json` |

### 2.4.3 æ ¸å¿ƒå¾ªç¯å±•å¼€ï¼ˆM2: ç¦»æ•£æ¡£ä½é‡‘é¢ç”Ÿæˆ â€” V1 vs V2 vs V2+ å·®å¼‚ï¼‰

> âš ï¸ **å¿…å¡«**ï¼šV2+ çš„æ ¸å¿ƒâ€”â€”ç”¨ç¦»æ•£æ¡£ä½æ›¿ä»£è¿ç»­åˆ†å¸ƒ

```python
# === é‡‘é¢ç”Ÿæˆå¯¹æ¯”ï¼ˆå¯¹é½ simulator/simulator.pyï¼‰===

def generate_amount_v1(user):
    """V1: çº¯ lognormal â€” P50 è¯¯å·® 2163%"""
    return lognormal(mu=3, sigma=1.5)

def generate_amount_v2(user):
    """V2: lognormal + pareto æ··åˆ â€” P50 è¯¯å·® 55%"""
    if random() < 0.05:  # 5% å¤§é¢
        return pareto.rvs(alpha=1.5) * 100
    else:
        return lognormal(mu=3, sigma=1.5)

def generate_amount_v2plus(user):
    """V2+: ç¦»æ•£æ¡£ä½ â€” P50 è¯¯å·® 0% âœ…"""
    # çœŸå®ç¤¼ç‰©ä»·æ ¼æ¡£ï¼ˆå…ƒï¼‰
    tiers = (1, 2, 10, 52, 100, 520, 1000, 1314, 5200, 13140)
    
    # åŸºç¡€æ¡£ä½æ¦‚ç‡ï¼ˆä»çœŸå®æ•°æ®æ‹Ÿåˆï¼‰
    base_probs = [0.38, 0.32, 0.15, 0.08, 0.04, 0.02, 0.005, 0.003, 0.001, 0.001]
    
    # è´¢å¯Œæ•ˆåº”ï¼šå¯Œç”¨æˆ·æ›´å¯èƒ½é€é«˜æ¡£ç¤¼ç‰©
    wealth_scale = 0.10
    adjusted_probs = softmax([
        log(p) + wealth_scale * log(user.wealth) * (i / len(tiers))
        for i, p in enumerate(base_probs)
    ])
    
    # æŒ‰æ¦‚ç‡æŠ½å–æ¡£ä½
    tier_idx = categorical(adjusted_probs)
    return tiers[tier_idx]

# æ ¡å‡†ç»“æœå¯¹æ¯”
#         P50 è¯¯å·®    P90 è¯¯å·®    Mean è¯¯å·®
# V1      2163%       496%        322%
# V2      55%         29%         375%
# V2+     0% âœ…       23% âœ…      27% âœ…
```

**å…³é”®é€»è¾‘è§£é‡Š**ï¼š
- **V1 é—®é¢˜**: lognormal ç”Ÿæˆçš„é‡‘é¢æ˜¯è¿ç»­çš„ï¼Œä½†çœŸå®ç¤¼ç‰©æ˜¯å›ºå®šæ¡£ä½
- **V2+ è§£å†³**: ç”¨ Categorical åˆ†å¸ƒç›´æ¥æŠ½å–çœŸå®æ¡£ä½
- **Gate-4A**: P50/P90/Mean è¯¯å·® <30% â†’ PASS

### 2.4.4 å¤ç°æ¸…å•

- [x] å›ºå®šéšæœºæ€§ï¼šseed=42
- [x] æ ¡å‡†ç›®æ ‡ï¼šKuaiLive çœŸå®åˆ†ä½æ•°
- [x] å¯¹æ¯”ç‰ˆæœ¬ï¼šV1, V2, V2+
- [x] è¾“å‡ºç‰©ï¼šsimulator_v2_amount_20260109.json + mvp41_*.png

---

# 3. ğŸ§ª å®éªŒè®¾è®¡ï¼ˆå…·ä½“åˆ°æœ¬æ¬¡å®éªŒï¼‰

## 3.1 æ•°æ® / ç¯å¢ƒ

| Item | Value |
|------|-------|
| Source | KuaiLive (EDA ç»Ÿè®¡ä½œä¸ºæ ¡å‡†ç›®æ ‡) |
| Path | `data/KuaiLive/` |
| Split | N/A |
| Feature | æ ¡å‡†ç›®æ ‡: P50=2, P90=88, Mean=82.7 |
| Target | åˆ†ä½æ•°è¯¯å·® <30% |

## 3.2 æ¨¡å‹é…ç½®

| å‚æ•° | V1 | V2 | V2+ |
|------|----|----|-----|
| é‡‘é¢åˆ†å¸ƒ | Lognormal (è¿ç»­) | Lognormal+Pareto | ç¦»æ•£æ¡£ä½ (10çº§) |
| ç”¨æˆ·é¢„ç®— | æ—  | æ—  | å¯é€‰ |
| è´¢å¯Œæ•ˆåº” | è¿ç»­ | è¿ç»­ | scale=0.10 |

## 3.3 V2+ é…ç½®å‚æ•°

```python
v2plus_tiers = (1, 2, 10, 52, 100, 520, 1000, 1314, 5200, 13140)
v2plus_tier_probs = (0.38, 0.32, 0.15, 0.08, 0.035, 0.022, 0.008, 0.003, 0.0015, 0.0005)
v2plus_wealth_scale = 0.10
v2plus_match_scale = 0.05
```

---

# 4. ğŸ“Š å›¾è¡¨ & ç»“æœ

### Fig 1: Quantile Comparison
![](../img/mvp41_quantile_comparison.png)

**What it shows**: V1/V2/V2+/çœŸå®å€¼åˆ†ä½æ•°å¯¹æ¯”

**Key observations**:
- V1 æ‰€æœ‰åˆ†ä½æ•°éƒ½è¿œé«˜äºçœŸå®å€¼
- V2 (lognormal+pareto) P50/P90 æ¥è¿‘ï¼Œä½† P99 æç«¯åé«˜
- **V2+ ç¦»æ•£æ¡£ä½æ¨¡å‹å„åˆ†ä½æ•°æœ€æ¥è¿‘çœŸå®å€¼**

### Fig 2: Calibration Error Comparison
![](../img/mvp41_error_comparison.png)

**What it shows**: å„ç‰ˆæœ¬è¯¯å·®å¯¹æ¯”

**Key observations**:
- V2+ ä¸‰ä¸ªå…³é”®æŒ‡æ ‡ï¼ˆP50/P90/Meanï¼‰è¯¯å·®å‡<30%
- V2 çš„ Mean è¯¯å·®æå¤§ï¼ˆ375%ï¼‰ï¼Œå› ä¸º pareto å°¾éƒ¨è¿‡é‡
- **V2+ å…¨é¢ä¼˜äº V1 å’Œ V2**

### Fig 3: Amount Distribution (Histogram)
![](../img/mvp41_amount_distribution.png)

**What it shows**: é‡‘é¢åˆ†å¸ƒç›´æ–¹å›¾

**Key observations**:
- V1 åˆ†å¸ƒå³åä¸¥é‡ï¼Œä¼—æ•°è¿œé«˜äº 2
- V2 å°è¯•ç”¨ lognormal+pareto ä½†æç«¯å€¼è¿‡å¤š
- **V2+ å‘ˆç°é˜¶æ¢¯çŠ¶åˆ†å¸ƒï¼Œç¬¦åˆç¦»æ•£æ¡£ä½ç‰¹å¾**

### Fig 4: CDF Comparison
![](../img/mvp41_cdf_comparison.png)

**What it shows**: ç´¯ç§¯åˆ†å¸ƒå‡½æ•°å¯¹æ¯”

**Key observations**:
- V2+ çš„ CDF æ›²çº¿æœ€æ¥è¿‘ç›®æ ‡åˆ†ä½æ•°çº¿
- V1/V2 åœ¨å°é‡‘é¢åŒºåŸŸåç¦»æ˜æ˜¾

### Fig 5: Gate-4A Summary
![](../img/mvp41_gate4a_summary.png)

**What it shows**: Gate-4A åˆ¤å®šæ±‡æ€»

**Key observations**:
- V2+ P50/P90/Mean å‡é€šè¿‡ 30% é˜ˆå€¼
- **Gate-4A PASS**

---

# 5. ğŸ’¡ æ´è§ï¼ˆè§£é‡Š"ä¸ºä»€ä¹ˆä¼šè¿™æ ·"ï¼‰

## 5.1 æœºåˆ¶å±‚ï¼ˆMechanism)
- ç¦»æ•£æ¡£ä½æ¨¡å‹æ¯”è¿ç»­åˆ†å¸ƒæ›´é€‚åˆç›´æ’­ç¤¼ç‰©åœºæ™¯
- çœŸå®ç¤¼ç‰©æœ‰å›ºå®šä»·æ ¼æ¡£ï¼ˆ1/2/10/52/100/520/1000/1314/5200/13140ï¼‰
- Pareto å°¾éƒ¨åœ¨ç¤¼ç‰©åœºæ™¯è¿‡äºæç«¯ï¼Œå¯¼è‡´ Mean è¢«æ‹‰é«˜

## 5.2 å®éªŒå±‚ï¼ˆDiagnostics)
- è°ƒå‚å…³é”®ï¼štier_probs æƒé‡åˆ†é…å†³å®šåˆ†ä½æ•°
- P50=2 éœ€è¦ ~65% ç´¯ç§¯æ¦‚ç‡åœ¨ tier 2 åŠä»¥ä¸‹
- P90â‰ˆ88 éœ€è¦ ~90% ç´¯ç§¯æ¦‚ç‡åœ¨ tier 52-100 ä¹‹é—´

## 5.3 è®¾è®¡å±‚ï¼ˆSo what)
- **é‡‡ç”¨ V2+** (amount_version=3)
- è´¢å¯Œæ•ˆåº”éœ€è¦é€‚åº¦ï¼ˆscale 0.10ï¼‰
- åç»­å¯è¿›ä¸€æ­¥æ ¡å‡† P99

## 5.4 V2+ ä¸çœŸå®æ•°æ®å·®è·åˆ†æ

> åŸºäº KuaiLive EDA å¯¹æ¯”ï¼Œæ€»ç»“ V2+ è·ç¦»å®Œå…¨æ¨¡æ‹ŸçœŸå®æ•°æ®è¿˜å­˜åœ¨çš„å·®è·

### 5.4.1 å·²è§£å†³é—®é¢˜

| æŒ‡æ ‡ | çœŸå®å€¼ | V2+ æ¨¡æ‹Ÿ | è¯¯å·® | çŠ¶æ€ |
|------|--------|----------|------|------|
| P50 | 2.0 | 2.0 | 0% | âœ… |
| P90 | 88.0 | 68.1 | 23% | âœ… |
| P99 | 1488.0 | 1002.6 | 33% | âš ï¸ å‹‰å¼º |
| Mean | 82.7 | 60.7 | 27% | âœ… |

### 5.4.2 ä»å­˜åœ¨å·®è·

| ç»´åº¦ | çœŸå®æ•°æ®ç‰¹å¾ | V2+ çŠ¶æ€ | ä¼˜å…ˆçº§ |
|------|--------------|----------|--------|
| é‡‘é¢ P50/P90/Mean | ç¦»æ•£æ¡£ä½ | âœ… æ ¡å‡† | - |
| é‡‘é¢ P99 | 1488 | âš ï¸ 33%è¯¯å·® | P1 |
| User Gini | 0.942 | âš ï¸ 0.888 (-5.7%) | P1 |
| **æ—¶åº-å³æ—¶å†²åŠ¨** | 90% å‰10%æ—¶é—´ | âŒ ç¼ºå¤± | **P0** |
| **ç”¨æˆ·å¿ è¯šåº¦** | P50=100% | âŒ ç¼ºå¤± | **P0** |
| ç”¨æˆ·åˆ†ç¾¤ | 17.6% é«˜çœ‹ä½ä»˜ | âŒ ç¼ºå¤± | P1 |
| ä¸»æ’­åˆ†ç¾¤ | 18.2% é«˜å¼•ä½å˜ | âŒ ç¼ºå¤± | P1 |
| å†·å¯åŠ¨æ¯”ä¾‹ | 92.2% æ— æ”¶å…¥ | âš ï¸ åä½ (~60%) | P1 |
| æ”€æ¯”/ç¾Šç¾¤æ•ˆåº” | å¯èƒ½å­˜åœ¨ | âŒ å¾…éªŒè¯ | P2 |
| é¢„ç®—çº¦æŸ | å­˜åœ¨ | âš ï¸ æœªå¯ç”¨ | P2 |

### 5.4.3 æœªå»ºæ¨¡çš„çœŸå®æ•°æ®ç‰¹å¾

**1. æ—¶åºç‰¹å¾ï¼ˆå®Œå…¨ç¼ºå¤±ï¼‰**
- çœŸå®æ•°æ®å‘ç°ï¼š90.36% æ‰“èµå‘ç”Ÿåœ¨ session å‰ 10% æ—¶é—´ï¼ˆ"å³æ—¶å†²åŠ¨"ï¼‰
- å³°å€¼æ—¶æ®µï¼šHour=13, 20-22
- V2+ ç°çŠ¶ï¼šæ‰“èµæ¦‚ç‡ä¸ session æ—¶é—´ä½ç½®æ— å…³ï¼Œæ— æ—¶æ®µæ•æ„Ÿæ€§å»ºæ¨¡

**2. ç”¨æˆ·å¿ è¯šåº¦/ä¸“ä¸€åº¦ï¼ˆå®Œå…¨ç¼ºå¤±ï¼‰**
- çœŸå®æ•°æ®å‘ç°ï¼šgift_loyalty P50 = 100%ï¼ˆç”¨æˆ·æ‰“èµé«˜åº¦é›†ä¸­åœ¨å°‘æ•°ä¸»æ’­ï¼‰
- V2+ ç°çŠ¶ï¼šç”¨æˆ·æ¯æ¬¡ç‹¬ç«‹éšæœºåŒ¹é…ä¸»æ’­ï¼Œæ— "å†å²åå¥½"å»ºæ¨¡

**3. ç”¨æˆ·/ä¸»æ’­åˆ†ç¾¤ï¼ˆæœªåŒºåˆ†ï¼‰**
- é«˜è§‚çœ‹ä½ä»˜è´¹ç”¨æˆ·ï¼š17.6% (4,178äºº) â€” V2+ æœªåŒºåˆ†
- é«˜å¸å¼•ä½å˜ç°ä¸»æ’­ï¼š18.2% (82,540ä¸ª) â€” V2+ æœªåŒºåˆ†
- è¿™äº›ç¾¤ä½“æ˜¯å¾…è½¬åŒ–/å¾…ä¼˜åŒ–çš„æ ¸å¿ƒå¯¹è±¡

**4. å†·å¯åŠ¨æç«¯ç¨€ç–ï¼ˆæœªå……åˆ†ä½“ç°ï¼‰**
- çœŸå®ï¼šæ— æ”¶å…¥ä¸»æ’­æ¯”ä¾‹ 92.2%ï¼Œäº¤äº’çŸ©é˜µå¯†åº¦ 0.0064%
- V2+ï¼šnew_streamer_ratio=20% è¿œä½äºçœŸå®å€¼

### 5.4.4 V3 ç‰ˆæœ¬éœ€æ±‚ï¼ˆå¦‚éœ€å®Œå…¨æ¨¡æ‹ŸçœŸå®æ•°æ®ï¼‰

| # | æœºåˆ¶ | ä¼˜å…ˆçº§ | å®ç°æ€è·¯ |
|---|------|--------|----------|
| 1 | æ—¶åºå†²åŠ¨æ¨¡å‹ | P0 | æ‰“èµæ¦‚ç‡ âˆ decay(session_progress)ï¼Œå‰10%æƒé‡é«˜ |
| 2 | ç”¨æˆ·å¿ è¯šåº¦ | P0 | ç»´æŠ¤ userâ†’streamer åå¥½å‘é‡ï¼Œå†å²æ‰“èµä¸»æ’­æ¦‚ç‡æ›´é«˜ |
| 3 | ç”¨æˆ·åˆ†ç¾¤ | P1 | æ ‡è®°"é«˜çœ‹ä½ä»˜"ç”¨æˆ·ç¾¤ï¼Œè®¾ç½®ä¸åŒè½¬åŒ–æ¦‚ç‡ |
| 4 | ä¸»æ’­åˆ†ç¾¤ | P1 | æ ‡è®°"é«˜å¼•ä½å˜"ä¸»æ’­ç¾¤ï¼Œè®¾ç½®ä¸åŒå˜ç°ç‡ |
| 5 | æç«¯ç¨€ç–æ€§ | P1 | æé«˜ new_streamer_ratio è‡³ 90%+ |
| 6 | ç¾Šç¾¤æ•ˆåº” | P2 | æ‰“èµåå¢åŠ åŒç›´æ’­é—´å…¶ä»–ç”¨æˆ·æ‰“èµæ¦‚ç‡ |
| 7 | é¢„ç®—çº¦æŸ | P2 | å¯ç”¨å¹¶æ ¡å‡†ç”¨æˆ·é¢„ç®—ä¸Šé™ |

> **ç»“è®º**ï¼šå¯¹äºç­–ç•¥ç›¸å¯¹æ¯”è¾ƒï¼ˆGreedy vs Random vs Concaveï¼‰ï¼ŒV2+ å·²ç»è¶³å¤Ÿã€‚å¦‚éœ€æ›´ç²¾ç¡®æ¨¡æ‹ŸçœŸå®æ•°æ®ï¼Œéœ€è¦ V3 ç‰ˆæœ¬å¢åŠ ä¸Šè¿°æœºåˆ¶ã€‚

---

# 6. ğŸ“ ç»“è®º & ä¸‹ä¸€æ­¥

## 6.1 æ ¸å¿ƒå‘ç°ï¼ˆpunch lineï¼‰
> **V2+ ç¦»æ•£æ¡£ä½æ¨¡å‹æˆåŠŸæ ¡å‡†é‡‘é¢åˆ†å¸ƒï¼ŒP50/P90/Mean è¯¯å·®å‡<30%ï¼ŒGate-4A é€šè¿‡**

- âœ… H4.1.1: ç¦»æ•£æ¡£ä½ä¿®å¤äº† P50/P90 è¯¯å·®
- âœ… H4.1.2: V2+ æ˜¾è‘—ä¼˜äº V2 (lognormal+pareto)
- âœ… Gate-4A: PASS
- **Decision**: é‡‡ç”¨ V2+ï¼Œç»§ç»­åç»­å®éªŒ

## 6.2 å…³é”®ç»“è®ºï¼ˆ2-5 æ¡ï¼‰

| # | ç»“è®º | è¯æ®ï¼ˆå›¾/è¡¨/æ•°å­—ï¼‰ | é€‚ç”¨èŒƒå›´ |
|---|------|-------------------|---------|
| 1 | **ç¦»æ•£æ¡£ä½ä¼˜äºè¿ç»­åˆ†å¸ƒ** | V2+ Mean è¯¯å·® 27% vs V2 375% | é‡‘é¢å»ºæ¨¡ |
| 2 | **P50/P90/Mean ä¸‰æŒ‡æ ‡è¾¾æ ‡** | 0%/23%/27% å‡<30% | Gate-4A |
| 3 | **è´¢å¯Œæ•ˆåº”éœ€é€‚åº¦** | scale=0.10 | å‚æ•°é€‰æ‹© |

## 6.3 Trade-offsï¼ˆÎ”+ vs Î”-ï¼‰

| Upside (Î”+) | Cost / Constraint (Î”-) | When acceptable |
|-------------|--------------------------|----------------|
| åˆ†ä½æ•°å‡†ç¡® | ç¦»æ•£åŒ–æŸå¤±ç²¾åº¦ | ç­–ç•¥è¯„ä¼° |
| æ— æç«¯å€¼ | P99 ä»æœ‰ 33% è¯¯å·® | éæç«¯åœºæ™¯ |

## 6.4 ä¸‹ä¸€æ­¥ï¼ˆå¯æ‰§è¡Œä»»åŠ¡ï¼‰

| Priority | Task | Owner | Link |
|----------|------|-------|------|
| âœ… å®Œæˆ | MVP-4.2 å¹¶å‘å®¹é‡å»ºæ¨¡ | - | exp_concave_allocation_20260108.md |
| ğŸŸ¡ P1 | è¿›ä¸€æ­¥æ ¡å‡† P99 (33%â†’<20%) | - | - |
| ğŸŸ¢ P2 | å°† V2+ è®¾ä¸ºé»˜è®¤ amount_version | - | - |
| ğŸŸ¢ P2 | V3 æ—¶åºå†²åŠ¨æ¨¡å‹ï¼ˆå¦‚éœ€ç²¾ç¡®æ¨¡æ‹Ÿï¼‰ | - | è§ Â§5.4.4 |
| ğŸŸ¢ P2 | V3 ç”¨æˆ·å¿ è¯šåº¦æ¨¡å‹ï¼ˆå¦‚éœ€ç²¾ç¡®æ¨¡æ‹Ÿï¼‰ | - | è§ Â§5.4.4 |

> **å½“å‰ç»“è®º**ï¼šV2+ å¯¹ç­–ç•¥ç›¸å¯¹æ¯”è¾ƒå·²è¶³å¤Ÿï¼ŒV3 éå¿…é¡»é¡¹ï¼Œä¼˜å…ˆçº§ P2ã€‚

---

# 7. ğŸ“ é™„å½•ï¼ˆå¤ç°/å®¡è®¡ç”¨ï¼‰

## 7.1 æ•°å€¼ç»“æœï¼ˆå…¨é‡ï¼‰

| Version | P50 | P90 | P99 | Mean | User Gini |
|---------|-----|-----|-----|------|-----------|
| Real | 2.0 | 88.0 | 1488.0 | 82.7 | 0.942 |
| V1 | 45.3 | 524.5 | 4707.3 | 349.2 | 0.802 |
| V2 | 3.1 | 113.6 | 9010.5 | 393.1 | 0.899 |
| **V2+** | **2.0** | **68.1** | **1002.6** | **60.7** | 0.888 |

## 7.2 æ‰§è¡Œè®°å½•ï¼ˆå¿…é¡»åŒ…å«å¯å¤åˆ¶å‘½ä»¤ï¼‰

| Item | Value |
|------|-------|
| Repo | `~/GiftLive` |
| Script | `scripts/run_simulator_experiments.py` |
| Config | `--mvp 4.1` |
| Output | `gift_allocation/results/simulator_v2_amount_20260109.json` |

```bash
# (1) setup
cd ~/GiftLive
source init.sh

# (2) run
python scripts/run_simulator_experiments.py --mvp 4.1 --n_sim 50

# (3) view results
cat gift_allocation/results/simulator_v2_amount_20260109.json
```

## 7.3 è¿è¡Œæ—¥å¿—æ‘˜è¦ / Debugï¼ˆå¯é€‰ï¼‰

| Issue | Root cause | Fix |
|------|------------|-----|
| V2 Mean è¯¯å·®å¤§ | pareto å°¾éƒ¨è¿‡é‡ | æ”¹ç”¨ç¦»æ•£æ¡£ä½ |

---

> **å®éªŒå®Œæˆæ—¶é—´**: 2026-01-09
