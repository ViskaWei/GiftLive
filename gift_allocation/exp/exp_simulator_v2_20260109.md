# ğŸƒ Simulator V2 - å¢å¼ºå‹æ‰“èµæ¨¡æ‹Ÿå™¨
> **Name:** Simulator V2 Enhanced  
> **ID:** `EXP-20260109-gift_allocation-14`  
> **Topic:** `gift_allocation` | **MVP:** MVP-4.1+  
> **Author:** Viska Wei | **Date:** 2026-01-09 | **Status:** ğŸ”„

> ğŸ¯ **Target:** è§£å†³ V1 é‡‘é¢åˆ†å¸ƒå¤±çœŸé—®é¢˜ï¼Œå¼•å…¥ç¦»æ•£é‡‘é¢æ¡£ä½ã€ç”¨æˆ·é¢„ç®—çº¦æŸã€ç¤¾äº¤æ•ˆåº”å’Œæ—¶åºå»ºæ¨¡  
> ğŸš€ **Next:** æ ¡å‡†æˆåŠŸ â†’ åˆ†é…ç­–ç•¥ç»“è®ºå¯ä¿¡ â†’ ç»§ç»­ MVP 4.4/4.5

## âš¡ æ ¸å¿ƒç»“è®ºé€Ÿè§ˆ

> **ä¸€å¥è¯**: TODO (å®éªŒå®Œæˆåå¡«å†™)

| éªŒè¯é—®é¢˜ | ç»“æœ | ç»“è®º |
|---------|------|------|
| H4.1.1: ç¦»æ•£é‡‘é¢æ¡£ä½èƒ½å¦ä¿®å¤ P50/P90 è¯¯å·®ï¼Ÿ | â³ | TODO |
| H4.1.2: ç”¨æˆ·é¢„ç®—çº¦æŸèƒ½å¦æ ¡å‡† Top-1% Shareï¼Ÿ | â³ | TODO |
| H4.1.3: ç¤¾äº¤æ•ˆåº”èƒ½å¦å¤ç°çœŸå®æ‰“èµæ¨¡å¼ï¼Ÿ | â³ | TODO |

| æŒ‡æ ‡ | V1 è¯¯å·® | V2 ç›®æ ‡ | V2 å®é™… |
|------|---------|---------|---------|
| Amount P50 | 285% | <30% | TODO |
| Amount P90 | 122% | <30% | TODO |
| Amount Mean | 111% | <30% | TODO |
| Top 1% User Share | 62% | <15% | TODO |
| Gift Rate | 40% | <20% | TODO |

| Type | Link |
|------|------|
| ğŸ§  Hub | `gift_allocation/gift_allocation_hub.md` Â§ Q3.2 |
| ğŸ—ºï¸ Roadmap | `gift_allocation/gift_allocation_roadmap.md` Â§ MVP-4.1 |
| ğŸ“‹ Charter | `gift_allocation/gift_allocation_phase4_charter.md` |

---
# 1. ğŸ¯ ç›®æ ‡

**é—®é¢˜**: V1 æ¨¡æ‹Ÿå™¨é‡‘é¢åˆ†å¸ƒä¸¥é‡å¤±çœŸ

| æŒ‡æ ‡ | çœŸå®å€¼ | V1 æ¨¡æ‹Ÿå€¼ | è¯¯å·® |
|------|--------|----------|------|
| Gift Rate | 1.48% | 2.08% | 40% |
| Amount P50 | 2.0 | 7.7 | **285%** |
| Amount Mean | 82.7 | 174.2 | **111%** |
| Top 1% User Share | 59.9% | 96.9% | **62%** |

**æ ¹å› åˆ†æ** (æ¥è‡ª new.md):

| V1 ç¼ºé™· | çœŸå®åœºæ™¯ | å½±å“ |
|---------|---------|------|
| **è¿ç»­é‡‘é¢åˆ†å¸ƒ** | ç¤¼ç‰©æœ‰å›ºå®šä»·æ ¼æ¡£ï¼ˆ1/10/100/...ï¼‰ | é‡‘é¢åˆ†å¸ƒå¤±çœŸ |
| **æ— é¢„ç®—çº¦æŸ** | ç”¨æˆ·æœ‰æ—¥/å‘¨é¢„ç®—ä¸Šé™ | Top-1% Share è¿‡é«˜ |
| **ç”¨æˆ·ç‹¬ç«‹** | ç¤¾äº¤æ•ˆåº”ï¼šè·Ÿé£/æ”€æ¯”/æŒ¤å‡º | æ‰“èµæ¨¡å¼ä¸çœŸå® |
| **å•æ¬¡äº¤äº’** | åŒä¸€ session å¤šæ¬¡æ‰“èµ | Gift Rate åå·® |
| **é™æ€ä¸»æ’­** | ä¸»æ’­äº’åŠ¨è´¨é‡å½±å“æ‰“èµ | æ— æ³•æ¨¡æ‹Ÿä¸»æ’­å·®å¼‚ |

**éªŒè¯**: H4.1.1, H4.1.2, H4.1.3

| é¢„æœŸ | åˆ¤æ–­æ ‡å‡† |
|------|---------|
| P50/P90/Mean è¯¯å·®<30% | é€šè¿‡ â†’ æ ¡å‡†æˆåŠŸï¼Œç»§ç»­ 4.4/4.5 |
| Top-1% Share è¯¯å·®<15% | é€šè¿‡ â†’ å¤§å“¥è¡Œä¸ºåˆ»ç”»å‡†ç¡® |
| è¯¯å·®ä»>30% | éœ€è¿›ä¸€æ­¥è°ƒå‚æˆ–å¼•å…¥æ–°æœºåˆ¶ |

---

# 2. ğŸ¦¾ ç®—æ³•

## 2.1 V2 æ ¸å¿ƒæ”¹è¿›

```python
class GiftSimulatorV2:
    """å¢å¼ºå‹æ‰“èµæ¨¡æ‹Ÿå™¨"""
    
    def __init__(self):
        # 1. ç¦»æ•£é‡‘é¢æ¡£ä½ï¼ˆæ¨¡æ‹ŸçœŸå®ç¤¼ç‰©å®šä»·ï¼‰
        self.gift_tiers = [1, 10, 52, 100, 520, 1000, 1314, 5200, 13140]
        
        # 2. ç”¨æˆ·é¢„ç®—æ¨¡å‹
        self.user_daily_budget: Dict[int, float]
        self.user_remaining_budget: Dict[int, float]
        
        # 3. ç¤¾äº¤æ•ˆåº”å‚æ•°
        self.herd_effect_alpha = 0.1  # ç¾Šç¾¤æ•ˆåº”ï¼šçœ‹åˆ°ç¤¼ç‰©åæ‰“èµæ¦‚ç‡æå‡
        self.competition_beta = 0.05  # æŒ¤å‡ºæ•ˆåº”ï¼šå¤§å“¥è¿‡å¤šæ—¶çš„æŒ¤å‡º
        
        # 4. æ—¶åºçŠ¶æ€
        self.session_length: Dict[int, float]  # è§‚çœ‹æ—¶é•¿
        self.gift_sequence: Dict[int, List]    # æ‰“èµåºåˆ—
```

## 2.2 å››å¤§æ ¸å¿ƒæœºåˆ¶

### æœºåˆ¶ 1: ç¦»æ•£é‡‘é¢æ¡£ä½

$$
\text{tier} \sim \text{Categorical}(\pi_1, \pi_2, ..., \pi_K)
$$

å…¶ä¸­ $\pi_k = \text{softmax}(\log(\text{tier}_k) \cdot \text{wealth} + \text{match\_score})$

**æ¡£ä½è®¾è®¡** (åŸºäº KuaiLive æ•°æ®):

| æ¡£ä½ | é‡‘é¢ | å®é™…å æ¯” | å¤‡æ³¨ |
|------|------|---------|------|
| 1 | 1 | ~40% | æœ€å°ç¤¼ç‰© |
| 2 | 10 | ~25% | å¸¸è§å°é¢ |
| 3 | 52 | ~15% | 520å¯“æ„ |
| 4 | 100 | ~10% | æ•´æ•°å…³å£ |
| 5 | 520 | ~5% | æˆ‘çˆ±ä½  |
| 6 | 1000 | ~3% | åƒå…ƒç¤¼ |
| 7 | 1314 | ~1% | ä¸€ç”Ÿä¸€ä¸– |
| 8 | 5200 | ~0.5% | è¶…çº§ç¤¼ç‰© |
| 9 | 13140 | ~0.2% | é¡¶çº§ç¤¼ç‰© |

### æœºåˆ¶ 2: ç”¨æˆ·é¢„ç®—çº¦æŸ

$$
\text{budget}_u^{(t)} = \text{budget}_u^{(t-1)} - \sum_{s} \text{gift}_{us}^{(t-1)}
$$

**é¢„ç®—åˆ†å¸ƒ**:
- P50 ç”¨æˆ·: 50/å¤©
- P90 ç”¨æˆ·: 500/å¤©
- P99 ç”¨æˆ·: 5000/å¤©

### æœºåˆ¶ 3: ç¤¾äº¤æ•ˆåº”

**ç¾Šç¾¤æ•ˆåº”**: 
$$
p_{\text{gift}}^{\text{post}} = p_{\text{gift}}^{\text{base}} \cdot (1 + \alpha \cdot \text{recent\_gifts}_s)
$$

**æŒ¤å‡ºæ•ˆåº”**:
$$
p_{\text{gift}}^{\text{final}} = p_{\text{gift}}^{\text{post}} \cdot (1 - \beta \cdot \text{whale\_count}_s)
$$

### æœºåˆ¶ 4: Session æ—¶åºå»ºæ¨¡

```python
def simulate_session(self, user, streamer):
    """æ¨¡æ‹Ÿå®Œæ•´ sessionï¼Œè€Œéå•æ¬¡äº¤äº’"""
    # 1. å†³å®šè§‚çœ‹æ—¶é•¿ (æŒ‡æ•°åˆ†å¸ƒ)
    watch_time = np.random.exponential(self.avg_watch_time)
    
    # 2. åœ¨è§‚çœ‹æœŸé—´å¯èƒ½å¤šæ¬¡æ‰“èµ
    gifts = []
    elapsed = 0
    while elapsed < watch_time:
        # æ‰“èµæ¦‚ç‡éšæ—¶é—´å¢åŠ 
        p_gift = self.compute_gift_prob(user, streamer, elapsed)
        
        if np.random.random() < p_gift:
            tier = self.sample_gift_tier(user, streamer)
            gifts.append(tier)
            self.trigger_herd_effect(streamer)
        
        elapsed += self.time_step
    
    return gifts
```

---

# 3. ğŸ§ª å®éªŒè®¾è®¡

## 3.1 æ•°æ®

| é¡¹ | å€¼ |
|----|-----|
| æ¥æº | KuaiLive (EDA ç»Ÿè®¡ä½œä¸ºæ ¡å‡†ç›®æ ‡) |
| è·¯å¾„ | `data/KuaiLive/` |
| æ ¡å‡†ç›®æ ‡ | Gift Rate=1.48%, P50=2, P90=88, Gini=0.94 |

## 3.2 æ¨¡å‹é…ç½®

| å‚æ•° | V1 | V2 | è¯´æ˜ |
|------|----|----|------|
| é‡‘é¢åˆ†å¸ƒ | Lognormal (è¿ç»­) | ç¦»æ•£æ¡£ä½ (9çº§) | æ ¸å¿ƒæ”¹è¿› |
| ç”¨æˆ·é¢„ç®— | æ—  | æœ‰ (æ—¥é¢„ç®—) | æ§åˆ¶ Top-1% Share |
| ç¤¾äº¤æ•ˆåº” | æ—  | ç¾Šç¾¤+æŒ¤å‡º | æé«˜çœŸå®æ€§ |
| æ—¶åº | å•æ¬¡ | Session | å¤šæ¬¡æ‰“èµ |

## 3.3 è®­ç»ƒ/æ ¡å‡†

| å‚æ•° | å€¼ |
|------|-----|
| æ–¹æ³• | å‚æ•°æœç´¢ + åˆ†ä½æ•°åŒ¹é… |
| ç›®æ ‡å‡½æ•° | $\sum_q w_q \cdot |P_q^{sim} - P_q^{real}|^2$ |
| åˆ†ä½æ•° | P50, P75, P90, P95, P99 |
| è¿­ä»£ | ç½‘æ ¼æœç´¢ + Bayesian Optimization |

## 3.4 æ‰«æå‚æ•°

| æ‰«æ | èŒƒå›´ | è¯´æ˜ |
|------|------|------|
| æ¡£ä½æ¦‚ç‡åˆ†å¸ƒå‚æ•° | Dirichlet prior | åŒ¹é…çœŸå®åˆ†å¸ƒ |
| é¢„ç®—åˆ†å¸ƒå‚æ•° | Lognormal(Î¼, Ïƒ) | åŒ¹é… Top-1% Share |
| ç¾Šç¾¤æ•ˆåº” Î± | [0, 0.05, 0.1, 0.2] | æ§åˆ¶ç¤¾äº¤å½±å“ |
| æŒ¤å‡ºæ•ˆåº” Î² | [0, 0.05, 0.1] | æ§åˆ¶é²¸é±¼äº’æ–¥ |

---

# 4. ğŸ“Š å›¾è¡¨

> âš ï¸ å›¾è¡¨æ–‡å­—å¿…é¡»å…¨è‹±æ–‡ï¼

### Fig 1: Amount Distribution Comparison (V1 vs V2 vs Real)
TODO: `./img/mvp41_amount_distribution.png`

**é¢„æœŸè§‚å¯Ÿ**:
- V1 å³åä¸¥é‡
- V2 åº”è¯¥æ›´æ¥è¿‘çœŸå®åˆ†å¸ƒï¼ˆé˜¶æ¢¯çŠ¶ï¼‰

### Fig 2: Quantile Calibration Plot
TODO: `./img/mvp41_quantile_calibration.png`

**é¢„æœŸè§‚å¯Ÿ**:
- V2 å„åˆ†ä½æ•°è¯¯å·®<30%
- V1 åœ¨ P50-P90 è¯¯å·®æœ€å¤§

### Fig 3: Top-1% User Share Calibration
TODO: `./img/mvp41_top1_share.png`

**é¢„æœŸè§‚å¯Ÿ**:
- V1: 97% (è¿‡é«˜)
- V2: ~60% (æ¥è¿‘çœŸå® 59.9%)

### Fig 4: Social Effect Sweep
TODO: `./img/mvp41_social_effect.png`

**é¢„æœŸè§‚å¯Ÿ**:
- ç¾Šç¾¤æ•ˆåº”å¢åŠ  Gift Rate
- æŒ¤å‡ºæ•ˆåº”åˆ†æ•£é²¸é±¼

---

# 5. ğŸ’¡ æ´è§

## 5.1 å®è§‚ (å¾…å®éªŒåå¡«å†™)
- TODO

## 5.2 æ¨¡å‹å±‚ (å¾…å®éªŒåå¡«å†™)
- TODO

## 5.3 ç»†èŠ‚ (å¾…å®éªŒåå¡«å†™)
- TODO

---

# 6. ğŸ“ ç»“è®º (å¾…å®éªŒåå¡«å†™)

## 6.1 æ ¸å¿ƒå‘ç°
> **TODO**

## 6.2 å…³é”®ç»“è®º

| # | ç»“è®º | è¯æ® |
|---|------|------|
| 1 | TODO | TODO |

## 6.3 è®¾è®¡å¯ç¤º

| åŸåˆ™ | å»ºè®® |
|------|------|
| TODO | TODO |

## 6.4 å…³é”®æ•°å­—

| æŒ‡æ ‡ | V1 | V2 | æ”¹å–„ |
|------|----|----|------|
| P50 è¯¯å·® | 285% | TODO | TODO |
| P90 è¯¯å·® | 122% | TODO | TODO |
| Top-1% Share è¯¯å·® | 62% | TODO | TODO |

## 6.5 ä¸‹ä¸€æ­¥

| æ–¹å‘ | ä»»åŠ¡ | ä¼˜å…ˆçº§ |
|------|------|--------|
| Gate-4A é€šè¿‡ | ç»§ç»­ MVP-4.4 ä¾›éœ€åŒ¹é… | ğŸ”´ |
| Gate-4A æœªé€šè¿‡ | è°ƒå‚æˆ–ç®€åŒ–æœºåˆ¶ | ğŸŸ¡ |

---

# 7. ğŸ“ é™„å½•

## 7.1 V1 é—®é¢˜è¯Šæ–­

| é—®é¢˜ | V1 è¡¨ç° | V2 è§£å†³æ–¹æ¡ˆ |
|------|---------|-------------|
| é‡‘é¢åˆ†å¸ƒè¯¯å·®å¤§ | P50: 2â†’7.7 (285%) | ç¦»æ•£æ¡£ä½ |
| Top-1% Share åé«˜ | 60%â†’97% | ç”¨æˆ·é¢„ç®—çº¦æŸ |
| æ‰“èµç‡åé«˜ | 1.48%â†’2.08% | Session å»ºæ¨¡ |
| æ— ç¤¾äº¤æ•ˆåº” | ç”¨æˆ·ç‹¬ç«‹ | ç¾Šç¾¤+æŒ¤å‡º |

## 7.2 æ‰§è¡Œè®°å½•

| é¡¹ | å€¼ |
|----|-----|
| è„šæœ¬ | `scripts/simulator/simulator_v2.py` (å¾…åˆ›å»º) |
| å‚è€ƒä»£ç  | `scripts/simulator/` (V1 å®ç°) |
| Output | `gift_allocation/results/simulator_v2_20260109.json` |

```bash
# è¿è¡Œ V2 æ ¡å‡†å®éªŒ
source init.sh
nohup python scripts/simulator_v2_calibration.py > logs/simulator_v2_20260109.log 2>&1 &
```

## 7.3 ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | ç”¨é€” |
|------|------|
| [new.md](../../new.md) | é—®é¢˜åˆ†æä¸ V2 è®¾è®¡è‰æ¡ˆ |
| [Simulator V1](./exp_simulator_v1_20260108.md) | V1 æ ¡å‡†ç»“æœ |
| [Phase 4 Charter](../gift_allocation_phase4_charter.md) | ç«‹é¡¹ä¹¦ |

---

> **å®éªŒç«‹é¡¹æ—¶é—´**: 2026-01-09
