# ğŸƒ Simulator V2 - å¢å¼ºå‹æ‰“èµæ¨¡æ‹Ÿå™¨
> **Name:** Simulator V2 Enhanced  
> **ID:** `EXP-20260109-gift_allocation-14`  
> **Topic:** `gift_allocation` | **MVP:** MVP-4.1+  
> **Author:** Viska Wei | **Date:** 2026-01-09 | **Status:** âœ…

> ğŸ¯ **Target:** è§£å†³ V1 é‡‘é¢åˆ†å¸ƒå¤±çœŸé—®é¢˜ï¼Œå¼•å…¥ç¦»æ•£é‡‘é¢æ¡£ä½æ ¡å‡†  
> ğŸš€ **Next:** Gate-4A PASS â†’ ç»§ç»­ MVP 4.2 (å¹¶å‘å®¹é‡å»ºæ¨¡)

## âš¡ æ ¸å¿ƒç»“è®ºé€Ÿè§ˆ

> **ä¸€å¥è¯**: V2+ ç¦»æ•£æ¡£ä½æ¨¡å‹æˆåŠŸæ ¡å‡†é‡‘é¢åˆ†å¸ƒï¼ŒP50/P90/Mean è¯¯å·®å‡<30%ï¼ŒGate-4A é€šè¿‡

| éªŒè¯é—®é¢˜ | ç»“æœ | ç»“è®º |
|---------|------|------|
| H4.1.1: ç¦»æ•£é‡‘é¢æ¡£ä½èƒ½å¦ä¿®å¤ P50/P90 è¯¯å·®ï¼Ÿ | âœ… | P50=0%, P90=22.6%, Mean=26.7% |
| H4.1.2: V2+ æ˜¯å¦ä¼˜äº V2 (lognormal+pareto)ï¼Ÿ | âœ… | V2+ Meanè¯¯å·®27% vs V2 375% |
| H4.1.3: æ ¡å‡†åæ¨¡æ‹Ÿå™¨æ˜¯å¦å¯ç”¨äºç­–ç•¥éªŒè¯ï¼Ÿ | âœ… | Gate-4A PASSï¼Œç»§ç»­åç»­å®éªŒ |

| æŒ‡æ ‡ | V1 è¯¯å·® | V2 è¯¯å·® | V2+ è¯¯å·® | ç›®æ ‡ |
|------|---------|---------|----------|------|
| Amount P50 | 2163% | 55% | **0%** âœ“ | <30% |
| Amount P90 | 496% | 29% âœ“ | **23%** âœ“ | <30% |
| Amount P99 | 216% | 506% | 33% | <50% |
| Amount Mean | 322% | 375% | **27%** âœ“ | <30% |

| Type | Link |
|------|------|
| ğŸ§  Hub | `gift_allocation/gift_allocation_hub.md` Â§ Q3.2 |
| ğŸ—ºï¸ Roadmap | `gift_allocation/gift_allocation_roadmap.md` Â§ MVP-4.1 |
| ğŸ“‹ Charter | `gift_allocation/gift_allocation_phase4_charter.md` |

---
# 1. ğŸ¯ ç›®æ ‡

**é—®é¢˜**: V1 æ¨¡æ‹Ÿå™¨é‡‘é¢åˆ†å¸ƒä¸¥é‡å¤±çœŸ

| æŒ‡æ ‡ | çœŸå®å€¼ | V1 æ¨¡æ‹Ÿå€¼ | è¯¯å·® |
|------|--------|----------|------|
| Gift Rate | 1.48% | 2.08% | 40% |
| Amount P50 | 2.0 | 7.7 | **285%** |
| Amount Mean | 82.7 | 174.2 | **111%** |
| Top 1% User Share | 59.9% | 96.9% | **62%** |

**æ ¹å› åˆ†æ** (æ¥è‡ª new.md):

| V1 ç¼ºé™· | çœŸå®åœºæ™¯ | å½±å“ |
|---------|---------|------|
| **è¿ç»­é‡‘é¢åˆ†å¸ƒ** | ç¤¼ç‰©æœ‰å›ºå®šä»·æ ¼æ¡£ï¼ˆ1/10/100/...ï¼‰ | é‡‘é¢åˆ†å¸ƒå¤±çœŸ |
| **æ— é¢„ç®—çº¦æŸ** | ç”¨æˆ·æœ‰æ—¥/å‘¨é¢„ç®—ä¸Šé™ | Top-1% Share è¿‡é«˜ |
| **ç”¨æˆ·ç‹¬ç«‹** | ç¤¾äº¤æ•ˆåº”ï¼šè·Ÿé£/æ”€æ¯”/æŒ¤å‡º | æ‰“èµæ¨¡å¼ä¸çœŸå® |
| **å•æ¬¡äº¤äº’** | åŒä¸€ session å¤šæ¬¡æ‰“èµ | Gift Rate åå·® |
| **é™æ€ä¸»æ’­** | ä¸»æ’­äº’åŠ¨è´¨é‡å½±å“æ‰“èµ | æ— æ³•æ¨¡æ‹Ÿä¸»æ’­å·®å¼‚ |

**éªŒè¯**: H4.1.1, H4.1.2, H4.1.3

| é¢„æœŸ | åˆ¤æ–­æ ‡å‡† |
|------|---------|
| P50/P90/Mean è¯¯å·®<30% | é€šè¿‡ â†’ æ ¡å‡†æˆåŠŸï¼Œç»§ç»­ 4.4/4.5 |
| Top-1% Share è¯¯å·®<15% | é€šè¿‡ â†’ å¤§å“¥è¡Œä¸ºåˆ»ç”»å‡†ç¡® |
| è¯¯å·®ä»>30% | éœ€è¿›ä¸€æ­¥è°ƒå‚æˆ–å¼•å…¥æ–°æœºåˆ¶ |

---

# 2. ğŸ¦¾ ç®—æ³•

## 2.1 V2 æ ¸å¿ƒæ”¹è¿›

```python
class GiftSimulatorV2:
    """å¢å¼ºå‹æ‰“èµæ¨¡æ‹Ÿå™¨"""
    
    def __init__(self):
        # 1. ç¦»æ•£é‡‘é¢æ¡£ä½ï¼ˆæ¨¡æ‹ŸçœŸå®ç¤¼ç‰©å®šä»·ï¼‰
        self.gift_tiers = [1, 10, 52, 100, 520, 1000, 1314, 5200, 13140]
        
        # 2. ç”¨æˆ·é¢„ç®—æ¨¡å‹
        self.user_daily_budget: Dict[int, float]
        self.user_remaining_budget: Dict[int, float]
        
        # 3. ç¤¾äº¤æ•ˆåº”å‚æ•°
        self.herd_effect_alpha = 0.1  # ç¾Šç¾¤æ•ˆåº”ï¼šçœ‹åˆ°ç¤¼ç‰©åæ‰“èµæ¦‚ç‡æå‡
        self.competition_beta = 0.05  # æŒ¤å‡ºæ•ˆåº”ï¼šå¤§å“¥è¿‡å¤šæ—¶çš„æŒ¤å‡º
        
        # 4. æ—¶åºçŠ¶æ€
        self.session_length: Dict[int, float]  # è§‚çœ‹æ—¶é•¿
        self.gift_sequence: Dict[int, List]    # æ‰“èµåºåˆ—
```

## 2.2 å››å¤§æ ¸å¿ƒæœºåˆ¶

### æœºåˆ¶ 1: ç¦»æ•£é‡‘é¢æ¡£ä½

$$
\text{tier} \sim \text{Categorical}(\pi_1, \pi_2, ..., \pi_K)
$$

å…¶ä¸­ $\pi_k = \text{softmax}(\log(\text{tier}_k) \cdot \text{wealth} + \text{match\_score})$

**æ¡£ä½è®¾è®¡** (åŸºäº KuaiLive æ•°æ®):

| æ¡£ä½ | é‡‘é¢ | å®é™…å æ¯” | å¤‡æ³¨ |
|------|------|---------|------|
| 1 | 1 | ~40% | æœ€å°ç¤¼ç‰© |
| 2 | 10 | ~25% | å¸¸è§å°é¢ |
| 3 | 52 | ~15% | 520å¯“æ„ |
| 4 | 100 | ~10% | æ•´æ•°å…³å£ |
| 5 | 520 | ~5% | æˆ‘çˆ±ä½  |
| 6 | 1000 | ~3% | åƒå…ƒç¤¼ |
| 7 | 1314 | ~1% | ä¸€ç”Ÿä¸€ä¸– |
| 8 | 5200 | ~0.5% | è¶…çº§ç¤¼ç‰© |
| 9 | 13140 | ~0.2% | é¡¶çº§ç¤¼ç‰© |

### æœºåˆ¶ 2: ç”¨æˆ·é¢„ç®—çº¦æŸ

$$
\text{budget}_u^{(t)} = \text{budget}_u^{(t-1)} - \sum_{s} \text{gift}_{us}^{(t-1)}
$$

**é¢„ç®—åˆ†å¸ƒ**:
- P50 ç”¨æˆ·: 50/å¤©
- P90 ç”¨æˆ·: 500/å¤©
- P99 ç”¨æˆ·: 5000/å¤©

### æœºåˆ¶ 3: ç¤¾äº¤æ•ˆåº”

**ç¾Šç¾¤æ•ˆåº”**: 
$$
p_{\text{gift}}^{\text{post}} = p_{\text{gift}}^{\text{base}} \cdot (1 + \alpha \cdot \text{recent\_gifts}_s)
$$

**æŒ¤å‡ºæ•ˆåº”**:
$$
p_{\text{gift}}^{\text{final}} = p_{\text{gift}}^{\text{post}} \cdot (1 - \beta \cdot \text{whale\_count}_s)
$$

### æœºåˆ¶ 4: Session æ—¶åºå»ºæ¨¡

```python
def simulate_session(self, user, streamer):
    """æ¨¡æ‹Ÿå®Œæ•´ sessionï¼Œè€Œéå•æ¬¡äº¤äº’"""
    # 1. å†³å®šè§‚çœ‹æ—¶é•¿ (æŒ‡æ•°åˆ†å¸ƒ)
    watch_time = np.random.exponential(self.avg_watch_time)
    
    # 2. åœ¨è§‚çœ‹æœŸé—´å¯èƒ½å¤šæ¬¡æ‰“èµ
    gifts = []
    elapsed = 0
    while elapsed < watch_time:
        # æ‰“èµæ¦‚ç‡éšæ—¶é—´å¢åŠ 
        p_gift = self.compute_gift_prob(user, streamer, elapsed)
        
        if np.random.random() < p_gift:
            tier = self.sample_gift_tier(user, streamer)
            gifts.append(tier)
            self.trigger_herd_effect(streamer)
        
        elapsed += self.time_step
    
    return gifts
```

---

# 3. ğŸ§ª å®éªŒè®¾è®¡

## 3.1 æ•°æ®

| é¡¹ | å€¼ |
|----|-----|
| æ¥æº | KuaiLive (EDA ç»Ÿè®¡ä½œä¸ºæ ¡å‡†ç›®æ ‡) |
| è·¯å¾„ | `data/KuaiLive/` |
| æ ¡å‡†ç›®æ ‡ | Gift Rate=1.48%, P50=2, P90=88, Gini=0.94 |

## 3.2 æ¨¡å‹é…ç½®

| å‚æ•° | V1 | V2 | è¯´æ˜ |
|------|----|----|------|
| é‡‘é¢åˆ†å¸ƒ | Lognormal (è¿ç»­) | ç¦»æ•£æ¡£ä½ (9çº§) | æ ¸å¿ƒæ”¹è¿› |
| ç”¨æˆ·é¢„ç®— | æ—  | æœ‰ (æ—¥é¢„ç®—) | æ§åˆ¶ Top-1% Share |
| ç¤¾äº¤æ•ˆåº” | æ—  | ç¾Šç¾¤+æŒ¤å‡º | æé«˜çœŸå®æ€§ |
| æ—¶åº | å•æ¬¡ | Session | å¤šæ¬¡æ‰“èµ |

## 3.3 è®­ç»ƒ/æ ¡å‡†

| å‚æ•° | å€¼ |
|------|-----|
| æ–¹æ³• | å‚æ•°æœç´¢ + åˆ†ä½æ•°åŒ¹é… |
| ç›®æ ‡å‡½æ•° | $\sum_q w_q \cdot |P_q^{sim} - P_q^{real}|^2$ |
| åˆ†ä½æ•° | P50, P75, P90, P95, P99 |
| è¿­ä»£ | ç½‘æ ¼æœç´¢ + Bayesian Optimization |

## 3.4 æ‰«æå‚æ•°

| æ‰«æ | èŒƒå›´ | è¯´æ˜ |
|------|------|------|
| æ¡£ä½æ¦‚ç‡åˆ†å¸ƒå‚æ•° | Dirichlet prior | åŒ¹é…çœŸå®åˆ†å¸ƒ |
| é¢„ç®—åˆ†å¸ƒå‚æ•° | Lognormal(Î¼, Ïƒ) | åŒ¹é… Top-1% Share |
| ç¾Šç¾¤æ•ˆåº” Î± | [0, 0.05, 0.1, 0.2] | æ§åˆ¶ç¤¾äº¤å½±å“ |
| æŒ¤å‡ºæ•ˆåº” Î² | [0, 0.05, 0.1] | æ§åˆ¶é²¸é±¼äº’æ–¥ |

---

# 4. ğŸ“Š å›¾è¡¨

> âš ï¸ å›¾è¡¨æ–‡å­—å¿…é¡»å…¨è‹±æ–‡ï¼

### Fig 1: Quantile Comparison (V1 vs V2 vs V2+ vs Real)
![](../img/mvp41_quantile_comparison.png)

**è§‚å¯Ÿ**:
- V1 æ‰€æœ‰åˆ†ä½æ•°éƒ½è¿œé«˜äºçœŸå®å€¼
- V2 (lognormal+pareto) P50/P90 æ¥è¿‘ï¼Œä½† P99 æç«¯åé«˜
- **V2+ ç¦»æ•£æ¡£ä½æ¨¡å‹å„åˆ†ä½æ•°æœ€æ¥è¿‘çœŸå®å€¼**

### Fig 2: Calibration Error Comparison
![](../img/mvp41_error_comparison.png)

**è§‚å¯Ÿ**:
- V2+ ä¸‰ä¸ªå…³é”®æŒ‡æ ‡ï¼ˆP50/P90/Meanï¼‰è¯¯å·®å‡<30%
- V2 çš„ Mean è¯¯å·®æå¤§ï¼ˆ375%ï¼‰ï¼Œå› ä¸º pareto å°¾éƒ¨è¿‡é‡
- **V2+ å…¨é¢ä¼˜äº V1 å’Œ V2**

### Fig 3: Amount Distribution (Histogram)
![](../img/mvp41_amount_distribution.png)

**è§‚å¯Ÿ**:
- V1 åˆ†å¸ƒå³åä¸¥é‡ï¼Œä¼—æ•°è¿œé«˜äº 2
- V2 å°è¯•ç”¨ lognormal+pareto ä½†æç«¯å€¼è¿‡å¤š
- **V2+ å‘ˆç°é˜¶æ¢¯çŠ¶åˆ†å¸ƒï¼Œç¬¦åˆç¦»æ•£æ¡£ä½ç‰¹å¾**

### Fig 4: CDF Comparison
![](../img/mvp41_cdf_comparison.png)

**è§‚å¯Ÿ**:
- V2+ çš„ CDF æ›²çº¿æœ€æ¥è¿‘ç›®æ ‡åˆ†ä½æ•°çº¿
- V1/V2 åœ¨å°é‡‘é¢åŒºåŸŸåç¦»æ˜æ˜¾

### Fig 5: Gate-4A Summary
![](../img/mvp41_gate4a_summary.png)

**è§‚å¯Ÿ**:
- V2+ P50/P90/Mean å‡é€šè¿‡ 30% é˜ˆå€¼
- **Gate-4A PASS**

---

# 5. ğŸ’¡ æ´è§

## 5.1 å®è§‚
- ç¦»æ•£æ¡£ä½æ¨¡å‹æ¯”è¿ç»­åˆ†å¸ƒæ›´é€‚åˆç›´æ’­ç¤¼ç‰©åœºæ™¯
- çœŸå®ç¤¼ç‰©æœ‰å›ºå®šä»·æ ¼æ¡£ï¼ˆ1/2/10/52/100/520/1000/1314/5200/13140ï¼‰
- Pareto å°¾éƒ¨åœ¨ç¤¼ç‰©åœºæ™¯è¿‡äºæç«¯ï¼Œå¯¼è‡´ Mean è¢«æ‹‰é«˜

## 5.2 æ¨¡å‹å±‚
- è°ƒå‚å…³é”®ï¼štier_probs æƒé‡åˆ†é…å†³å®šåˆ†ä½æ•°
- P50=2 éœ€è¦ ~65% ç´¯ç§¯æ¦‚ç‡åœ¨ tier 2 åŠä»¥ä¸‹
- P90â‰ˆ88 éœ€è¦ ~90% ç´¯ç§¯æ¦‚ç‡åœ¨ tier 52-100 ä¹‹é—´
- è´¢å¯Œ/åŒ¹é…æ•ˆåº”éœ€è¦é€‚åº¦ï¼ˆscale 0.10ï¼‰

## 5.3 ç»†èŠ‚
- V2 çš„ pareto å°¾éƒ¨è¿‡é‡ï¼Œå¯¼è‡´ Mean è¢«æç«¯å€¼æ‹‰é«˜ï¼ˆ375% è¯¯å·®ï¼‰
- V2+ é€šè¿‡ç¦»æ•£æ¡£ä½é™åˆ¶äº†æœ€å¤§é‡‘é¢ï¼Œé¿å…æç«¯å€¼é—®é¢˜
- æœ€ç»ˆ tier_probs = (0.38, 0.32, 0.15, 0.08, 0.035, 0.022, 0.008, 0.003, 0.0015, 0.0005)

---

# 6. ğŸ“ ç»“è®º

## 6.1 æ ¸å¿ƒå‘ç°
> **V2+ ç¦»æ•£æ¡£ä½æ¨¡å‹æˆåŠŸæ ¡å‡†é‡‘é¢åˆ†å¸ƒï¼ŒP50/P90/Mean è¯¯å·®å‡<30%ï¼ŒGate-4A é€šè¿‡**

- âœ… H4.1.1: ç¦»æ•£æ¡£ä½ä¿®å¤äº† P50/P90 è¯¯å·®
- âœ… H4.1.2: V2+ æ˜¾è‘—ä¼˜äº V2 (lognormal+pareto)
- âœ… Gate-4A: PASS â†’ ç»§ç»­åç»­å®éªŒ

## 6.2 å…³é”®ç»“è®º

| # | ç»“è®º | è¯æ® |
|---|------|------|
| 1 | **ç¦»æ•£æ¡£ä½ä¼˜äºè¿ç»­åˆ†å¸ƒ** | V2+ Meanè¯¯å·®27% vs V2 375% |
| 2 | **P50/P90/Mean ä¸‰æŒ‡æ ‡è¾¾æ ‡** | 0%/23%/27% å‡<30% |
| 3 | **æ¨¡æ‹Ÿå™¨å¯ç”¨äºç­–ç•¥éªŒè¯** | Gate-4A PASS |
| 4 | **è´¢å¯Œæ•ˆåº”éœ€é€‚åº¦** | scale=0.10 é¿å…åˆ†å¸ƒåç§» |

## 6.3 è®¾è®¡å¯ç¤º

| åŸåˆ™ | å»ºè®® |
|------|------|
| é‡‘é¢å»ºæ¨¡ç”¨ç¦»æ•£æ¡£ä½ | âœ… é‡‡ç”¨ V2+ (amount_version=3) |
| è´¢å¯Œæ•ˆåº”é€‚åº¦ | scale â‰ˆ 0.10 |
| é¿å… pareto é‡å°¾ | æç«¯å€¼ä¼šä¸¥é‡æ‹‰é«˜ Mean |
| åˆ†ä½æ•°åŒ¹é…ä¼˜å…ˆ | è°ƒå‚æ—¶ P50/P90 æ˜¯å…³é”®é”šç‚¹ |

| âš ï¸ é™·é˜± | åŸå›  |
|---------|------|
| pareto å°¾éƒ¨è¿‡é‡ | Mean è¯¯å·® 375%ï¼Œæç«¯å€¼é¢‘ç¹ |
| è¿ç»­åˆ†å¸ƒç¼ºä¹ç¦»æ•£ç‰¹å¾ | çœŸå®ç¤¼ç‰©æ˜¯å›ºå®šä»·æ ¼æ¡£ |

## 6.4 å…³é”®æ•°å­—

| æŒ‡æ ‡ | çœŸå®å€¼ | V1 (Sim) | V2 (Sim) | V2+ (Sim) | V2+ è¯¯å·® |
|------|--------|----------|----------|-----------|----------|
| P50 | 2.0 | 45.3 | 3.1 | **2.0** | **0%** âœ“ |
| P90 | 88.0 | 524.5 | 113.6 | **68.1** | **23%** âœ“ |
| P99 | 1488.0 | 4707.3 | 9010.5 | **1002.6** | 33% |
| Mean | 82.7 | 349.2 | 393.1 | **60.7** | **27%** âœ“ |

## 6.5 ä¸‹ä¸€æ­¥

| æ–¹å‘ | ä»»åŠ¡ | ä¼˜å…ˆçº§ |
|------|------|--------|
| Gate-4A PASS âœ… | ç»§ç»­ MVP-4.2 å¹¶å‘å®¹é‡å»ºæ¨¡ | ğŸ”´ |
| å¯é€‰ä¼˜åŒ– | è¿›ä¸€æ­¥æ ¡å‡† P99 (å½“å‰ 33%) | ğŸŸ¡ |
| ä»£ç å›ºåŒ– | å°† V2+ è®¾ä¸ºé»˜è®¤ amount_version | ğŸŸ¢ |

---

# 7. ğŸ“ é™„å½•

## 7.1 æ•°å€¼ç»“æœ (50 simulations)

| Version | P50 | P90 | P99 | Mean | User Gini |
|---------|-----|-----|-----|------|-----------|
| Real | 2.0 | 88.0 | 1488.0 | 82.7 | 0.942 |
| V1 | 45.3 | 524.5 | 4707.3 | 349.2 | 0.802 |
| V2 | 3.1 | 113.6 | 9010.5 | 393.1 | 0.899 |
| **V2+** | **2.0** | **68.1** | **1002.6** | **60.7** | 0.888 |

## 7.2 æ‰§è¡Œè®°å½•

| é¡¹ | å€¼ |
|----|-----|
| è„šæœ¬ | `scripts/run_simulator_experiments.py --mvp 4.1` |
| ä»£ç ä¿®æ”¹ | `scripts/simulator/simulator.py` (æ·»åŠ  V2+ amount_version=3) |
| Output | `gift_allocation/results/simulator_v2_amount_20260109.json` |
| Log | `logs/mvp41_simulator_v2_20260109.log` |
| è¿è¡Œæ—¶é—´ | ~60s (50 simulations Ã— 3 versions) |

```bash
# è¿è¡Œ MVP-4.1 æ ¡å‡†å®éªŒ
source init.sh
python scripts/run_simulator_experiments.py --mvp 4.1 --n_sim 50
```

## 7.3 V2+ é…ç½®å‚æ•°

```python
# SimConfig V2+ å‚æ•° (amount_version=3)
v2plus_tiers = (1, 2, 10, 52, 100, 520, 1000, 1314, 5200, 13140)
v2plus_tier_probs = (0.38, 0.32, 0.15, 0.08, 0.035, 0.022, 0.008, 0.003, 0.0015, 0.0005)
v2plus_wealth_scale = 0.10
v2plus_match_scale = 0.05
```

## 7.4 ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | ç”¨é€” |
|------|------|
| [new.md](../../new.md) | é—®é¢˜åˆ†æä¸ V2 è®¾è®¡è‰æ¡ˆ |
| [Simulator V1](./exp_simulator_v1_20260108.md) | V1 æ ¡å‡†ç»“æœ |
| [Phase 4 Charter](../gift_allocation_phase4_charter.md) | ç«‹é¡¹ä¹¦ |
| [results JSON](../results/simulator_v2_amount_20260109.json) | å®Œæ•´æ•°å€¼ç»“æœ |

---

> **å®éªŒå®Œæˆæ—¶é—´**: 2026-01-09
