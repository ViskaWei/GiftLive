# 🧠 GiftLive Main Hub

> **Project:** GiftLive - 直播打赏推荐系统 | **Status:** 🔄 重构中 | **Date:** 2026-01-19

---

## 🎯 项目目标

**核心问题**：如何在直播场景下最大化全局打赏收益，同时维护生态健康？

**三层架构**：
```
┌─────────────────────────────────────────────────────────────┐
│                      main (本文件)                          │
│              顶层综合：问题定义 + 全局洞见                    │
└─────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        ▼                     ▼                     ▼
┌───────────────┐   ┌─────────────────┐   ┌─────────────────┐
│   KuaiLive    │   │   gift_EVpred   │   │ gift_allocation │
│   数据层       │   │   估计层         │   │   分配层         │
│               │   │                 │   │                 │
│ • 数据 EDA    │   │ • EV 预测       │   │ • 分配策略       │
│ • 数据特性    │   │ • 模型对比      │   │ • 约束优化       │
│ • 数据质量    │   │ • 特征工程      │   │ • Simulator     │
│               │   │                 │   │ • OPE 评估      │
└───────────────┘   └─────────────────┘   └─────────────────┘
```

---

## 🔗 子节点导航

| 节点 | Hub | 职责 | 状态 |
|------|-----|------|------|
| **KuaiLive** | [kuailive_hub.md](../KuaiLive/kuailive_hub.md) | 数据理解、EDA、数据质量 | ✅ |
| **gift_EVpred** | [gift_EVpred_hub.md](../gift_EVpred/gift_EVpred_hub.md) | EV 预测、模型选择、特征工程 | ✅ 收敛 |
| **gift_allocation** | [gift_allocation_hub.md](../gift_allocation/gift_allocation_hub.md) | 分配策略、约束优化、评估 | 🔄 重构中 |

---

## 📊 全局权威数字

### 数据层 (KuaiLive)

| 指标 | 值 | 来源 |
|------|-----|------|
| 打赏率 (per-click) | **1.48%** | EDA |
| 金额 P50/P90/P99 | 2/88/1,488 | EDA |
| User Gini | **0.942** | EDA |
| Streamer Gini | **0.930** | EDA |
| Top 1% User 贡献 | **59.9%** | EDA |
| Cold Start Streamer | **92.2%** | EDA |
| 延迟特性 | **86.3% delay=0** | 延迟审计 |

### 估计层 (gift_EVpred)

| 指标 | 值 | 来源 |
|------|-----|------|
| **RevCap@1%** | **51.4%** | Final Baseline v1.0 |
| CV (稳定性) | **9.4%** | Final Baseline v1.0 |
| 95% CI | [47.2%, 54.4%] | Bootstrap |
| 模型 | Ridge (alpha=1.0) | - |
| 特征数 | 20 (Strict Mode) | - |
| 标签窗口 | 1 分钟 | - |
| 归因方式 | Last-Touch + gift_id 去重 | - |

### 分配层 (gift_allocation)

| 指标 | 值 | 来源 |
|------|-----|------|
| Greedy/Random 收益比 | **2.94x** | Simulator |
| 软约束冷启动提升 | **+32% 收益** | MVP-2.2 |
| 冷启动成功率提升 | **+263%** | MVP-2.2 |
| 推荐策略 | Greedy + 软约束 (λ=0.5) | Gate-2 |
| OPE 方法 | SNIPS (RelErr<10%) | MVP-3.1 |

---

## 🔑 全局核心结论

### 已确认 (跨层共识)

| # | 结论 | 层 | 决策 |
|---|------|-----|------|
| **G1** | **分配策略是最大杠杆** | 分配 | 优化分配层 > 优化估计层 |
| **G2** | **估计层已够用** | 估计 | RevCap@1%=51.4% 作为 baseline |
| **G3** | **历史打赏是最强信号** | 估计 | pair_hist > user/streamer 全局 |
| **G4** | **软约束 > 硬约束** | 分配 | λ=0.5 平衡探索与收益 |
| **G5** | **延迟不是问题** | 数据 | 86.3% 礼物 delay=0 |
| **G6** | **简单规则 > 复杂框架** | 分配 | Greedy+Rules > Shadow Price |

### ⚠️ 需要注意

| # | 问题 | 影响 | 当前状态 |
|---|------|------|---------|
| **W1** | 首次打赏预测弱 | 56% 收入来自无历史 pair，RevCap 仅 29.6% | ⏳ 待优化 |
| **W2** | 冷启动主播多 | 92.2% 主播无历史 | 软约束部分解决 |
| **W3** | 用户分布极端集中 | Top 1% 贡献 60% 收入 | Whale 识别关键 |

---

## 🌲 全局问题树

```
🌲 核心: 如何最大化全局打赏收益 + 维护生态健康？
│
├── Q1: 数据层 - 数据特性如何影响建模？ [KuaiLive]
│   ├── ✅ 极稀疏 (1.48% 打赏率)
│   ├── ✅ 重尾 (Gini > 0.94)
│   ├── ✅ 延迟不是问题 (86.3% 立即发生)
│   └── ⚠️ 冷启动严重 (92.2% 新主播)
│
├── Q2: 估计层 - 如何预测 EV？ [gift_EVpred]
│   ├── ✅ Direct + raw Y 最优 (RevCap=51.4%)
│   ├── ✅ 时间窗纪律 (无泄漏)
│   ├── ❌ Tree 不适合稀疏 (LightGBM 失败)
│   └── ⚠️ 首次打赏预测弱 (待优化)
│
└── Q3: 分配层 - 如何分配高价值用户？ [gift_allocation]
    ├── ✅ Greedy + 软约束最优
    ├── ✅ SNIPS OPE 可用
    ├── ❌ Shadow Price 不如简单规则
    └── ⏳ Whale 分散 / 风险控制待验证
```

---

## 📐 设计原则 (全局)

| # | 原则 | 适用层 | 证据 |
|---|------|--------|------|
| P1 | **用 RevCap@K 评估，不用 MAE** | 估计 | RevCap 对齐业务目标 |
| P2 | **用 raw Y 预测，不用 log Y** | 估计 | log 压缩 whale 信号 |
| P3 | **用 Day-Frozen 特征** | 估计 | 无泄漏保证 |
| P4 | **用 Greedy + 软约束** | 分配 | 简单有效 |
| P5 | **用 SNIPS 做 OPE** | 分配 | RelErr < 10% |
| P6 | **用 Simulator 做策略对比** | 分配 | Gini 误差 < 5% |

---

## 🚀 当前进度

| 层 | Phase | 状态 | 下一步 |
|----|-------|------|--------|
| 数据层 | EDA 完成 | ✅ | - |
| 估计层 | Baseline 收敛 | ✅ | 切片评估 / 首次打赏优化 |
| 分配层 | Phase 5 规划中 | 🔄 | Whale 分散 / 风险控制 |

---

## 📋 节点职责边界

### KuaiLive (数据层)
- ✅ 做：数据 EDA、数据特性分析、数据质量评估、延迟特性分析
- ❌ 不做：模型训练、分配策略

### gift_EVpred (估计层)
- ✅ 做：EV 预测模型、特征工程、模型对比、预测评估指标
- ❌ 不做：分配策略、Simulator、OPE

### gift_allocation (分配层)
- ✅ 做：分配策略、约束优化、Simulator、OPE 评估、生态指标
- ❌ 不做：EV 预测模型训练、数据 EDA

---

## 🔄 重构待办

> 以下是从 gift_allocation 拆分出的内容

### 已迁移到 KuaiLive

| MVP | 内容 | 状态 |
|-----|------|------|
| MVP-0.1 EDA | 基础数据分析 | ✅ 已迁移 |
| MVP-0.1-Enhanced | 全方位 EDA | ✅ 已迁移 |
| 延迟审计 | 86.3% delay=0 结论 | ⏳ 保留引用 |

### 已迁移到 gift_EVpred

| MVP | 内容 | 状态 |
|-----|------|------|
| MVP-0.2 Baseline | 基础 EV 模型 | ⚠️ 需重新验证 (有泄漏) |
| MVP-1.1 两段式对比 | Direct vs Two-Stage | ⚠️ 需重新验证 |
| MVP-1.3 多任务 | Multi-Task 学习 | ⚠️ 需重新验证 |
| MVP-1.4 Oracle | Oracle 分析 | ⚠️ 需重新验证 |

### 保留在 gift_allocation

| MVP | 内容 | 状态 |
|-----|------|------|
| MVP-2.x 分配策略 | Greedy/凹收益/冷启动 | ✅ 方法论可用 |
| MVP-3.x OPE | SNIPS 评估 | ✅ |
| MVP-4.x Simulator | V1/V2 模拟器 | ✅ |
| MVP-5.x 分配优化 | 影子价格/Whale 分散 | 🔄 |

---

## 📎 附录

### 更新日志

| 日期 | 变更 |
|------|------|
| 2026-01-19 | 创建 main_hub.md，定义三层架构 |
| 2026-01-19 | EVpred 数据泄漏修复完成，Baseline v1.0 发布 |
| 2026-01-19 | 开始 allocation 重构，明确职责边界 |
