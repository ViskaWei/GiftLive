# ğŸ¯ Fast Baseline é…ç½®æ€»ç»“

> **Date:** 2026-01-18  
> **Author:** Viska Wei  
> **Script:** `scripts/train_baseline_fast.py`

---

## 1. LightGBM (GBDT) æ¨¡å‹å‚æ•°

### æ ‡å‡†å‚æ•°é…ç½®

```python
{
    'objective': 'regression',      # å›å½’ä»»åŠ¡
    'metric': 'mae',                # è¯„ä¼°æŒ‡æ ‡ï¼šå¹³å‡ç»å¯¹è¯¯å·®
    'num_leaves': 31,               # æ ‘çš„æœ€å¤§å¶å­æ•°
    'learning_rate': 0.1,            # å­¦ä¹ ç‡ï¼ˆå¿«é€Ÿç‰ˆï¼š0.1ï¼Œæ ‡å‡†ç‰ˆï¼š0.05ï¼‰
    'feature_fraction': 0.8,        # ç‰¹å¾é‡‡æ ·æ¯”ä¾‹ï¼ˆæ¯æ£µæ ‘ä½¿ç”¨ 80% ç‰¹å¾ï¼‰
    'bagging_fraction': 0.8,        # æ ·æœ¬é‡‡æ ·æ¯”ä¾‹ï¼ˆæ¯æ£µæ ‘ä½¿ç”¨ 80% æ ·æœ¬ï¼‰
    'bagging_freq': 5,               # æ¯ 5 è½®è¿›è¡Œä¸€æ¬¡ bagging
    'num_boost_round': 200,         # æœ€å¤§è¿­ä»£è½®æ•°ï¼ˆå¿«é€Ÿç‰ˆï¼š200ï¼Œæ ‡å‡†ç‰ˆï¼š500ï¼‰
    'early_stopping_rounds': 20,     # æ—©åœè½®æ•°ï¼ˆå¿«é€Ÿç‰ˆï¼š20ï¼Œæ ‡å‡†ç‰ˆï¼š50ï¼‰
    'verbose': -1,                  # ä¸è¾“å‡ºè®­ç»ƒæ—¥å¿—
    'seed': 42,                     # éšæœºç§å­
    'n_jobs': -1                    # ä½¿ç”¨æ‰€æœ‰ CPU æ ¸å¿ƒ
}
```

### å‚æ•°è¯´æ˜

| å‚æ•° | ä½œç”¨ | å¿«é€Ÿç‰ˆ | æ ‡å‡†ç‰ˆ |
|------|------|--------|--------|
| `learning_rate` | æ§åˆ¶æ¯æ£µæ ‘çš„è´¡çŒ® | 0.1ï¼ˆå¿«ï¼‰ | 0.05ï¼ˆç¨³ï¼‰ |
| `num_boost_round` | æœ€å¤§è¿­ä»£æ¬¡æ•° | 200 | 500 |
| `early_stopping_rounds` | éªŒè¯é›†æ— æ”¹å–„æ—¶åœæ­¢ | 20 | 50 |
| `num_leaves` | æ ‘å¤æ‚åº¦ | 31ï¼ˆé€‚ä¸­ï¼‰ | 31 |
| `feature_fraction` | ç‰¹å¾é‡‡æ ·ï¼ˆé˜²è¿‡æ‹Ÿåˆï¼‰ | 0.8 | 0.8 |
| `bagging_fraction` | æ ·æœ¬é‡‡æ ·ï¼ˆé˜²è¿‡æ‹Ÿåˆï¼‰ | 0.8 | 0.8 |

**ä¸ºä»€ä¹ˆé€‰æ‹© LightGBM (GBDT)ï¼Ÿ**
- âœ… Tree-based æ¨¡å‹ï¼Œèƒ½æ•æ‰éçº¿æ€§å…³ç³»å’Œç‰¹å¾äº¤äº’
- âœ… è‡ªåŠ¨å¤„ç†ç¼ºå¤±å€¼
- âœ… æä¾›ç‰¹å¾é‡è¦æ€§åˆ†æ
- âœ… è®­ç»ƒé€Ÿåº¦å¿«ï¼Œé€‚åˆå¿«é€Ÿè¿­ä»£
- âœ… ä¸é¡¹ç›®å†å²å®éªŒä¿æŒä¸€è‡´

---

## 2. Frozen ç‰¹å¾å·¥ç¨‹ï¼ˆä¼˜åŒ–ç‰ˆï¼‰

### 2.1 ä¼˜åŒ–ç­–ç•¥

**åŸå§‹ç‰ˆæœ¬é—®é¢˜**ï¼š
- ä½¿ç”¨ `iterrows()` é€è¡Œå¤„ç†ï¼Œå¯¹ 490 ä¸‡æ¡è®°å½•éœ€è¦æ•°å°æ—¶

**ä¼˜åŒ–ç‰ˆæœ¬æ”¹è¿›**ï¼š
1. **ä½¿ç”¨ `merge()` ä»£æ›¿ `iterrows()`**ï¼šPair å’Œ Streamer ç‰¹å¾ä½¿ç”¨ DataFrame merge
2. **å‘é‡åŒ–æ—¶é—´é—´éš”è®¡ç®—**ï¼šä½¿ç”¨ pandas å‘é‡åŒ–æ“ä½œ
3. **Lookup è¡¨ç¼“å­˜**ï¼šæ”¯æŒä¿å­˜/åŠ è½½ï¼Œé¿å…é‡å¤è®¡ç®—

### 2.2 æ€§èƒ½å¯¹æ¯”

| ç‰ˆæœ¬ | 100K æ ·æœ¬æ—¶é—´ | 490 ä¸‡æ ·æœ¬é¢„ä¼° | é€Ÿåº¦æå‡ |
|------|--------------|---------------|---------|
| åŸå§‹ç‰ˆæœ¬ | 7.29s | ~6 å°æ—¶ | - |
| ä¼˜åŒ–ç‰ˆæœ¬ | 0.07s | ~3.5 åˆ†é’Ÿ | **107x** |

### 2.3 å®ç°ç»†èŠ‚

**å…³é”®å‡½æ•°**ï¼š
- `apply_frozen_features_optimized()`ï¼šä¼˜åŒ–ç‰ˆæœ¬ï¼ˆä½¿ç”¨ mergeï¼‰
- `save_frozen_lookups()`ï¼šä¿å­˜ lookup è¡¨åˆ°ç£ç›˜
- `load_frozen_lookups()`ï¼šä»ç£ç›˜åŠ è½½ lookup è¡¨

**ç¼“å­˜ä½ç½®**ï¼š
- `gift_EVpred/features_cache/frozen_lookups_{train_min_ts}_{train_max_ts}.pkl`

**ä½¿ç”¨æ–¹å¼**ï¼š
```python
# åˆ›å»ºæˆ–åŠ è½½ lookups
if cache_path.exists():
    lookups, metadata = load_frozen_lookups(cache_path)
else:
    lookups, min_ts, max_ts = create_frozen_features(gift, click, train_df)
    save_frozen_lookups(lookups, min_ts, max_ts, cache_path)

# åº”ç”¨ç‰¹å¾ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
df = apply_frozen_features_optimized(df, lookups)
```

---

## 3. å®éªŒé…ç½®

### 3.1 æ•°æ®é…ç½®

| é…ç½®é¡¹ | å€¼ | è¯´æ˜ |
|--------|-----|------|
| **çª—å£æ—¶é—´** | **15min** (0.25h) | ä» 1h ç¼©çŸ­åˆ° 15minï¼Œå‡å°‘ 75% æ•°æ®é‡ |
| **æ•°æ®åˆ‡åˆ†** | 70/15/15 | Train/Val/Test æ—¶é—´åˆ‡åˆ† |
| **ç‰¹å¾ç‰ˆæœ¬** | **Frozen** | ä¸¥æ ¼æ— æ³„æ¼ï¼Œåªç”¨ train çª—å£ç»Ÿè®¡ |
| **ä½¿ç”¨ä¼˜åŒ–ç‰ˆ** | âœ… | ä½¿ç”¨ `apply_frozen_features_optimized()` |
| **ç¼“å­˜ Lookups** | âœ… | ä¿å­˜/åŠ è½½ lookup è¡¨ |

### 3.2 è®­ç»ƒé…ç½®

| é…ç½®é¡¹ | å¿«é€Ÿç‰ˆ | æ ‡å‡†ç‰ˆ |
|--------|--------|--------|
| `learning_rate` | 0.1 | 0.05 |
| `num_boost_round` | 200 | 500 |
| `early_stopping_rounds` | 20 | 50 |

### 3.3 é¢„æœŸæ€§èƒ½

| æŒ‡æ ‡ | é¢„æœŸå€¼ | è¯´æ˜ |
|------|--------|------|
| **æ•°æ®é‡** | ~1.2M samples | 15min çª—å£ï¼Œå‡å°‘ 75% |
| **ç‰¹å¾å·¥ç¨‹æ—¶é—´** | ~3-5min | ä¼˜åŒ–ç‰ˆæœ¬ï¼Œå‡å°‘ 70% |
| **è®­ç»ƒæ—¶é—´** | ~60-80s | å¿«é€Ÿé…ç½®ï¼Œå‡å°‘ 60% |
| **æ€»å®éªŒå‘¨æœŸ** | ~8-10min | å‡å°‘ 50% |
| **æ€§èƒ½å½±å“** | AUC ä¸‹é™ < 0.02 | å¯æ¥å— |

---

## 4. ä»£ç é€»è¾‘æ£€æŸ¥æ¸…å•

### âœ… å·²ç¡®è®¤

- [x] **å¯¼å…¥ä¼˜åŒ–å‡½æ•°**ï¼šæ­£ç¡®å¯¼å…¥ `apply_frozen_features_optimized`
- [x] **ä½¿ç”¨ä¼˜åŒ–ç‰ˆæœ¬**ï¼š`CONFIG['use_optimized'] = True`
- [x] **ç¼“å­˜ Lookups**ï¼šæ”¯æŒä¿å­˜/åŠ è½½ï¼Œé¿å…é‡å¤è®¡ç®—
- [x] **15min çª—å£**ï¼š`label_window_hours = 0.25`
- [x] **å¿«é€Ÿè®­ç»ƒå‚æ•°**ï¼š`learning_rate=0.1`, `max_rounds=200`
- [x] **ç‰¹å¾ç‰ˆæœ¬**ï¼šä½¿ç”¨ Frozenï¼ˆä¸¥æ ¼æ— æ³„æ¼ï¼‰
- [x] **è¯„ä¼°æŒ‡æ ‡**ï¼šSpearman, Top-1% Capture, Revenue Capture@1%, AUC

### ğŸ“‹ è¿è¡Œå‰æ£€æŸ¥

- [x] è¯­æ³•æ£€æŸ¥é€šè¿‡
- [x] å¯¼å…¥è·¯å¾„æ­£ç¡®
- [x] é…ç½®æ–‡ä»¶å®Œæ•´
- [x] è¾“å‡ºç›®å½•å­˜åœ¨

---

## 5. å¯åŠ¨å‘½ä»¤

```bash
cd /home/swei20/GiftLive
source init.sh
nohup python scripts/train_baseline_fast.py > logs/baseline_fast_$(date +%Y%m%d).log 2>&1 &
echo $! > logs/baseline_fast.pid
```

**æŸ¥çœ‹æ—¥å¿—**ï¼š
```bash
tail -f logs/baseline_fast_$(date +%Y%m%d).log
```

---

## 6. è¾“å‡ºæ–‡ä»¶

| ç±»å‹ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| **ç»“æœ JSON** | `gift_EVpred/results/baseline_fast_YYYYMMDD.json` | è¯„ä¼°æŒ‡æ ‡ |
| **æ¨¡å‹æ–‡ä»¶** | `gift_EVpred/models/baseline_fast_YYYYMMDD.pkl` | è®­ç»ƒå¥½çš„æ¨¡å‹ |
| **Lookup ç¼“å­˜** | `gift_EVpred/features_cache/frozen_lookups_*.pkl` | Frozen lookup è¡¨ |
| **è®­ç»ƒæ—¥å¿—** | `logs/baseline_fast_YYYYMMDD.log` | è®­ç»ƒè¿‡ç¨‹æ—¥å¿— |

---

> **çŠ¶æ€**: âœ… å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥å¯åŠ¨  
> **æœ€åæ›´æ–°**: 2026-01-18
