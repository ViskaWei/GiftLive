# ðŸƒ æ ·æœ¬åŠ æƒå›žå½’
> **Name:** Weighted Regression for Tail Focus
> **ID:** `EXP-20260119-EVpred-03`
> **Topic:** `gift_EVpred` | **MVP:** MVP-3.3
> **Author:** Viska Wei | **Date:** 2026-01-19 | **Status:** âŒ å¤±è´¥

> ðŸŽ¯ **Target:** é€šè¿‡æ ·æœ¬åŠ æƒè®©æ¨¡åž‹æ›´å…³æ³¨å¤´éƒ¨æ ·æœ¬ï¼Œé¢„æœŸ RevCap > 55%
> ðŸš€ **Next:** éªŒè¯ tail-aware å­¦ä¹ ç›®æ ‡èƒ½å¦çªç ´ Linear ç“¶é¢ˆ

## âš¡ æ ¸å¿ƒç»“è®ºé€Ÿè§ˆ

> **ä¸€å¥è¯**: âŒ æ ·æœ¬åŠ æƒå›žå½’æ— æ•ˆï¼Œç”šè‡³æœ‰å®³ï¼›ç­‰æƒ (alpha=0) ä»æ˜¯æœ€ä¼˜

| éªŒè¯é—®é¢˜ | ç»“æžœ | ç»“è®º |
|---------|------|------|
| æ ·æœ¬åŠ æƒæœ‰å¢žç›Šï¼Ÿ | âŒ **æ— å¢žç›Š** | ç­‰æƒæœ€ä¼˜ï¼ŒåŠ æƒåè€Œé™ä½Ž RevCap |
| æœ€ä¼˜ Î± å€¼ï¼Ÿ | âŒ **Î±=0** | Î±>0 æ—¶æ€§èƒ½ä¸‹é™ï¼ŒÎ±â‰¥1 æ—¶å´©æºƒ |

| æŒ‡æ ‡ | å€¼ | å¯ç¤º |
|------|-----|------|
| **Baseline (Î±=0)** | **51.4%** | âœ… ä»æ˜¯æœ€ä¼˜ |
| Weighted (Î±=0.3) | 50.3% | -1.1ppï¼Œç•¥æœ‰ä¸‹é™ |
| Weighted (Î±=1.0) | 24.4% | -27.0ppï¼Œä¸¥é‡å´©æºƒ |

| Type | Link |
|------|------|
| ðŸ§  Hub | `gift_EVpred/gift_EVpred_hub.md` Â§ P1-Tail |
| ðŸ—ºï¸ Roadmap | `gift_EVpred/gift_EVpred_roadmap.md` Â§ MVP-3.3 |

---

# 1. ðŸŽ¯ ç›®æ ‡

**é—®é¢˜**: å½“å‰ Ridge æ¨¡åž‹å¯¹æ‰€æœ‰æ ·æœ¬åŒç­‰å¯¹å¾…ï¼Œä½†æ‰“èµæ˜¯é‡å°¾åˆ†å¸ƒï¼ˆ98.5% ä¸º 0ï¼‰ã€‚èƒ½å¦é€šè¿‡æ ·æœ¬åŠ æƒè®©æ¨¡åž‹æ›´å…³æ³¨é«˜ä»·å€¼æ ·æœ¬ï¼Ÿ

**èƒŒæ™¯**:
- LightGBM å¤±è´¥åŽŸå› ï¼š98.5% æ ·æœ¬ target=0ï¼Œæ ‘æ¨¡åž‹é¢„æµ‹ä¼—æ•°
- æ ·æœ¬åŠ æƒå›žå½’ï¼šé€šè¿‡æƒé‡ $w_i = (1 + y_i)^\alpha$ æå‡å¤´éƒ¨æ ·æœ¬çš„é‡è¦æ€§
- å½“å‰ Baselineï¼šRevCap@1% = 52.60%ï¼ˆDirect + raw Y, Day-Frozenï¼‰

| é¢„æœŸ | åˆ¤æ–­æ ‡å‡† |
|------|---------|
| æœ‰å¢žç›Š | RevCap > 55% â†’ é‡‡ç”¨ |
| æ— å¢žç›Š | RevCap â‰¤ 52.60% â†’ å°è¯•å…¶ä»–æ–¹æ³• |

---

# 2. ðŸ¦¾ ç®—æ³•

**æ ·æœ¬åŠ æƒå›žå½’**ï¼š

ç»™æ¯ä¸ªæ ·æœ¬èµ‹äºˆæƒé‡ $w_i$ï¼Œä½¿é«˜ä»·å€¼æ ·æœ¬å¯¹ loss è´¡çŒ®æ›´å¤§ï¼š

$$
\mathcal{L} = \sum_{i=1}^{N} w_i \cdot (y_i - \hat{y}_i)^2
$$

**æƒé‡è®¾è®¡**ï¼š

$$
w_i = (1 + y_i)^\alpha, \quad \alpha \in [0.3, 0.5, 0.7, 1.0]
$$

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ**
- $\alpha = 0$ï¼šç­‰æƒï¼Œç­‰ä»·äºŽæ ‡å‡†å›žå½’
- $\alpha = 1$ï¼šæƒé‡æ­£æ¯”äºŽ $(1+y)$ï¼Œå¤§é¢æ‰“èµæƒé‡ ~1000x
- $\alpha = 0.5$ï¼šå¹³æ–¹æ ¹ç¼©æ”¾ï¼Œå¹³è¡¡å¤´éƒ¨ä¸Žä¸­éƒ¨

**å®žçŽ°æ–¹å¼**ï¼š

```python
# sklearn Ridge æ”¯æŒ sample_weight
from sklearn.linear_model import Ridge

alpha = 0.5  # å¾…æ‰«æ
weights = (1 + y_train) ** alpha
model = Ridge(alpha=1.0)
model.fit(X_train, y_train, sample_weight=weights)
```

---

# 3. ðŸ§ª å®žéªŒè®¾è®¡

## 3.1 æ•°æ®

| é¡¹ | å€¼ |
|----|-----|
| æ¥æº | KuaiLive |
| è·¯å¾„ | `data/KuaiLive/` |
| Train/Val/Test | 1,629,415 / 1,717,199 / 1,409,533 (7-7-7) |
| ç‰¹å¾ç»´åº¦ | 31 (Day-Frozen) |

## 3.2 æ¨¡åž‹

| å‚æ•° | å€¼ |
|------|-----|
| æ¨¡åž‹ | Weighted Ridge Regression |
| é¢„æµ‹ç›®æ ‡ | raw Y (gift_price_label) |
| æ­£åˆ™åŒ– | alpha=1.0 |

## 3.3 æ‰«æå‚æ•°

| æ‰«æ | èŒƒå›´ | å›ºå®š |
|------|------|------|
| Î± (æƒé‡æŒ‡æ•°) | [0, 0.3, 0.5, 0.7, 1.0, 1.5, 2.0] | model=Ridge, alpha=1.0 |

## 3.4 å¯¹æ¯”æ–¹æ³•

| æ–¹æ³• | æè¿° |
|------|------|
| Baseline | æ ‡å‡† Ridge (Î±=0) |
| Weighted Ridge | $w_i = (1+y_i)^\alpha$ |
| åˆ†ä½æ•°å›žå½’ (å¤‡é€‰) | ç›´æŽ¥å­¦ Q90/Q95 |
| LambdaRank (å¤‡é€‰) | å­¦ä¹ æŽ’åºï¼Œgain=é‡‘é¢ |

---

# 4. ðŸ“Š é¢„æœŸäº§å‡º

## 4.1 å›¾è¡¨

| å›¾è¡¨ | å†…å®¹ | ä¿å­˜è·¯å¾„ |
|------|------|---------|
| Fig 1 | Î± vs RevCap@1% æ›²çº¿ | `img/weighted_alpha_sweep.png` |
| Fig 2 | RevCap æ›²çº¿å¯¹æ¯”ï¼ˆå„ Î± å€¼ï¼‰ | `img/weighted_revcap_curve.png` |
| Fig 3 | Tail Calibration å¯¹æ¯” | `img/weighted_tail_calibration.png` |

## 4.2 æ•°å€¼ç»“æžœ

| Î± | Train RevCap | Val RevCap | Test RevCap | Test CV |
|---|-------------|------------|-------------|---------|
| **0 (Baseline)** | 29.4% | **44.5%** | **51.4%** | **10.1%** |
| 0.3 | 30.4% | 43.5% | 50.3% | 10.6% |
| 0.5 | 30.4% | 42.8% | 50.3% | 11.7% |
| 0.7 | 25.6% | 41.3% | 50.2% | 11.5% |
| 1.0 | 17.4% | 28.9% | 24.4% | 35.7% |
| 1.5 | 6.5% | 10.1% | 6.0% | 60.1% |
| 2.0 | 4.7% | 5.9% | 3.5% | 44.2% |

**å…³é”®å‘çŽ°**ï¼š
- Î±=0ï¼ˆç­‰æƒï¼‰åœ¨ Val ä¸Šæœ€ä¼˜ï¼Œç›´æŽ¥é‡‡ç”¨
- Î± å¢žå¤§æ—¶ï¼ŒTrain RevCap å…ˆå‡åŽé™ï¼ŒVal/Test å•è°ƒä¸‹é™
- Î±â‰¥1.0 æ—¶æ€§èƒ½å´©æºƒï¼ˆRevCap ä»Ž 51% é™è‡³ 24% ç”šè‡³ 3.5%ï¼‰
- CV éš Î± å¢žå¤§è€Œæ¶åŒ–ï¼ˆä»Ž 10% åˆ° 60%ï¼‰

---

# 5. ðŸ’¡ æ´žè§é¢„æœŸ

## 5.1 å®è§‚

- æ ·æœ¬åŠ æƒæœ¬è´¨æ˜¯æ”¹å˜ loss landscapeï¼Œè®©æ¨¡åž‹æ›´å…³æ³¨å¤´éƒ¨è¯¯å·®
- ä¸Ž LightGBM å¤±è´¥çš„åŽŸå› äº’è¡¥ï¼šæ ‘æ¨¡åž‹æ˜¯"é¢„æµ‹ä¼—æ•°"ï¼ŒåŠ æƒå›žå½’æ˜¯"è°ƒæ•´ loss"

## 5.2 æ½œåœ¨é£Žé™©

| é£Žé™© | è¡¨çŽ° | åº”å¯¹ |
|------|------|------|
| è¿‡åº¦æ‹Ÿåˆå¤´éƒ¨ | éžå¤´éƒ¨é¢„æµ‹å˜å·® | ç›‘æŽ§ RevCap@5%/10% |
| Calibration å¤±çœŸ | é¢„æµ‹å€¼å°ºåº¦å˜åŒ– | åŽå¤„ç†æ ¡å‡† |
| Î± è¿‡å¤§ | å°‘æ•°æžç«¯æ ·æœ¬ä¸»å¯¼ | é™åˆ¶ Î± â‰¤ 1.0 |

---

# 6. ðŸ’¡ éªŒæ”¶æ ‡å‡†

| éªŒæ”¶é¡¹ | æ ‡å‡† | ç»“æžœ | çŠ¶æ€ |
|--------|------|------|------|
| RevCap@1% | > 55% | 51.4%ï¼ˆæœªè¾¾æ ‡ï¼‰ | âŒ |
| æœ€ä¼˜ Î± | ç¨³å®šåœ¨æŸä¸ªåŒºé—´ | Î±=0ï¼ˆç­‰æƒï¼‰ | âŒ æ— éœ€åŠ æƒ |
| Tail Calibration | ä¸æ¶åŒ– | æœªæ¶åŒ– | âœ… |
| RevCap@5% | ä¸æ˜¾è‘—ä¸‹é™ | 63.6%ï¼ˆæœªä¸‹é™ï¼‰ | âœ… |

---

# 7. ðŸ’¡ ç»“è®ºä¸Žæ´žè§

## 7.1 æ ¸å¿ƒç»“è®º

> **âŒ æ ·æœ¬åŠ æƒå›žå½’æ— æ•ˆ**ï¼šç­‰æƒ (Î±=0) ä»æ˜¯æœ€ä¼˜æ–¹æ¡ˆï¼ŒåŠ æƒåè€Œæœ‰å®³

| æ´žè§ | è¯æ® | è§£é‡Š |
|------|------|------|
| **åŠ æƒæ— å¢žç›Š** | Î±=0 æœ€ä¼˜ | ç­‰æƒå·²è¶³å¤Ÿæ•èŽ·å¤´éƒ¨ä¿¡å· |
| **åŠ æƒæœ‰å®³** | Î±=0.3~0.7 é™ä½Ž 1-2pp | è¿‡åº¦å…³æ³¨æžç«¯æ ·æœ¬ |
| **é«˜ Î± å´©æºƒ** | Î±â‰¥1.0 å´©æºƒè‡³ 24% | å°‘æ•°æžç«¯æ ·æœ¬ä¸»å¯¼ï¼Œè¿‡æ‹Ÿåˆ |
| **ç¨³å®šæ€§æ¶åŒ–** | CV ä»Ž 10% åˆ° 60% | åŠ æƒæ”¾å¤§æ–¹å·® |

## 7.2 å¤±è´¥åŽŸå› åˆ†æž

1. **æ ·æœ¬åˆ†å¸ƒæžç«¯**ï¼š98.5% æ ·æœ¬ y=0ï¼ŒåŠ æƒè¿›ä¸€æ­¥æ”¾å¤§æžç«¯æ ·æœ¬çš„å½±å“
2. **ä¿¡å·å·²è¢«æ•èŽ·**ï¼šç­‰æƒ Ridge å·²ç»èƒ½è¯†åˆ«é«˜ä»·å€¼æ ·æœ¬ï¼ˆRevCap 51%ï¼‰
3. **è¿‡æ‹Ÿåˆé£Žé™©**ï¼šé«˜ Î± æ—¶ï¼Œæ¨¡åž‹è¿‡åº¦æ‹Ÿåˆå°‘æ•°å¤§é¢æ‰“èµæ ·æœ¬
4. **æ³›åŒ–èƒ½åŠ›ä¸‹é™**ï¼šVal/Test æ€§èƒ½æ¯” Train æ›´å·®ï¼Œè¯´æ˜ŽåŠ æƒå¯¼è‡´è¿‡æ‹Ÿåˆ

## 7.3 è®¾è®¡å¯ç¤º

| åŽŸåˆ™ | å»ºè®® |
|------|------|
| **ä¸è¦åŠ æƒ** | ä¿æŒç­‰æƒå›žå½’ï¼Œæ ·æœ¬åŠ æƒæ— æ•ˆ |
| **Linear ç“¶é¢ˆ** | éœ€è¦ä»Žç‰¹å¾å·¥ç¨‹æˆ–æ¨¡åž‹ç»“æž„çªç ´ |
| **ä¸‹ä¸€æ­¥æ–¹å‘** | åŽ†å²è§‚çœ‹å…ˆéªŒç‰¹å¾ / MLP |

---

# 8. ðŸ“Ž é™„å½•

## 8.1 æ‰§è¡Œè®°å½•

| é¡¹ | å€¼ |
|----|-----|
| æ‰§è¡Œæ—¶é—´ | 2026-01-19 |
| ç»“æžœæ–‡ä»¶ | `results/weighted_regression_20260119.json` |

## 8.2 RevCap æ›²çº¿å¯¹æ¯”

| K | Baseline (Î±=0) | Î±=0.3 | Î±=0.7 | Î±=1.0 |
|---|----------------|-------|-------|-------|
| 0.1% | 21.2% | 21.0% | 20.8% | 9.1% |
| 0.5% | 43.3% | 42.7% | 42.1% | 17.5% |
| 1% | 51.4% | 50.3% | 50.2% | 24.4% |
| 5% | 63.6% | 62.9% | 62.4% | 42.1% |
| 10% | 68.6% | 68.1% | 67.5% | 53.2% |

---

> **å®žéªŒå®Œæˆæ—¶é—´**: 2026-01-19

---

# 7. ðŸ“Ž é™„å½•

## 7.1 ä»£ç å‚è€ƒ

| æ–‡ä»¶ | è¯´æ˜Ž |
|------|------|
| `gift_EVpred/data_utils.py` | æ•°æ®å¤„ç† |
| `sklearn.linear_model.Ridge` | æ”¯æŒ sample_weight |

## 7.2 ç†è®ºä¾æ®

**ä¸ºä»€ä¹ˆæ ·æœ¬åŠ æƒå¯èƒ½æœ‰æ•ˆï¼Ÿ**

1. **é‡å°¾åˆ†å¸ƒ**ï¼šæ‰“èµé‡‘é¢ P90=88, P99=1488, Max=56246ï¼Œå¤´éƒ¨æ ·æœ¬è´¡çŒ®å¤§éƒ¨åˆ†æ”¶å…¥
2. **å½“å‰é—®é¢˜**ï¼šæ ‡å‡† MSE å¯¹ 0 å€¼æ ·æœ¬è¿‡åº¦å…³æ³¨ï¼ˆ98.5%ï¼‰ï¼Œå¤´éƒ¨è¯¯å·®è¢«ç¨€é‡Š
3. **åŠ æƒæ•ˆæžœ**ï¼šè®© 10000 å…ƒæ ·æœ¬çš„è¯¯å·®æƒé‡æ˜¯ 10 å…ƒæ ·æœ¬çš„ ~1000xï¼ˆå½“ Î±=1ï¼‰

**ä¸Žå…¶ä»–æ–¹æ³•çš„å…³ç³»**ï¼š

| æ–¹æ³• | æ ¸å¿ƒæ€æƒ³ | å¤æ‚åº¦ |
|------|---------|--------|
| æ ·æœ¬åŠ æƒå›žå½’ | è°ƒæ•´ loss æƒé‡ | ðŸŸ¢ ç®€å• |
| åˆ†ä½æ•°å›žå½’ | ç›´æŽ¥å­¦ä¸Šåˆ†ä½ | ðŸŸ¡ ä¸­ç­‰ |
| LambdaRank | å­¦ä¹ æŽ’åº | ðŸ”´ å¤æ‚ |

---

> **ç«‹é¡¹æ—¶é—´**: 2026-01-19
