# 🍃 预测目标扩展：从 Gift 到行动后果
> **Name:** Prediction Target Expansion
> **ID:** `EXP-20260119-EVpred-05`
> **Topic:** `gift_EVpred` | **MVP:** MVP-4.0
> **Author:** Viska Wei | **Date:** 2026-01-19 | **Status:** ✅ 完成

> 🎯 **Target:** 从"预测 gift"扩展到"预测行动的后果"，建立多目标预测框架
> 🚀 **Next:** 留存难以预测 → 放弃作为预测目标，改为观测指标

## ⚡ 核心结论速览

> **一句话**: 留存预测 AUC=0.57（接近随机），难以用当前特征预测；但发现**打赏用户留存率更低**（78.9% vs 89.2%），短期收益与留存存在权衡

| 验证问题 | 结果 | 结论 |
|---------|------|------|
| Q2.4.1: 用户留存可预测？ | ❌ AUC=0.57 | 难以预测，接近随机 |
| Q2.4.2: 短期收益 vs 留存权衡？ | ✅ 发现负相关 | 打赏用户留存率低 10.3pp |
| Q2.4.3: 生态约束如何建模？ | ✅ 收入 Gini=0.93 | 极度集中，需约束 |

| 指标 | 值 | 启示 |
|------|-----|------|
| **留存 AUC** | **0.5722** | 接近随机，难以预测 |
| **RevCap@1% (对照)** | **51.4%** | 与 baseline 一致 |
| **打赏用户留存率** | **78.9%** | 比未打赏低 10.3pp |
| **收入 Gini** | **0.926** | 极度集中 |

| Type | Link |
|------|------|
| 🧠 Hub | `gift_EVpred_hub.md` § Q2.4 |
| 🗺️ Roadmap | `gift_EVpred_roadmap.md` § MVP-4.0 |

---

# 1. 🎯 目标

## 1.1 问题

**核心问题**：当前预测的是"这条样本会送多少礼"，但长期目标是预测"给了这个行动（分配），会发生什么"。

**预测目标分解**：
| 维度 | 符号 | 定义 | 状态 |
|------|------|------|------|
| **短期收益** | $r^{rev}_t$ | E[gift_amount] | ✅ 已有 (51.4%) |
| **用户留存** | $r^{usr}_t$ | E[return_1d] | ❌ 难以预测 |
| **生态健康** | $r^{eco}_t$ | -Gini(revenue) | ✅ 已测量 |

## 1.2 验证假设

**H2.4**：多目标预测框架可以：
1. ❌ 提供用户留存预测信号 → **失败**，AUC=0.57
2. ✅ 发现短期收益与留存的权衡 → **成功**
3. ✅ 建立生态基线指标 → **成功**

---

# 2. 🧪 实验设计

## 2.1 数据

| 项 | 值 |
|----|-----|
| 来源 | KuaiLive (`data/KuaiLive/`) |
| 基础数据 | `data_utils.prepare_dataset()` |
| Train/Val/Test | 1.6M / 1.7M / 1.4M (7-7-7) |
| 日期范围 | 2025-05-04 ~ 2025-05-24 |

## 2.2 新增标签

| 标签 | 定义 | 构建方式 |
|------|------|---------|
| `return_1d` | 次日是否有 click | user-day 活跃表查询 |
| `return_7d` | 7 天内是否有 click | 同上 |

## 2.3 模型

| 模型 | 目标 | 算法 |
|------|------|------|
| 留存预测 | return_1d | Logistic Regression |
| 短期收益 (对照) | target_raw | Ridge Regression |

---

# 3. 📊 实验结果

## 3.1 留存率 EDA

### 整体留存率

| 数据集 | 留存率 (return_1d) |
|--------|-------------------|
| Train | 91.4% |
| Val | 90.9% |
| Test | 89.0% |

**发现**：整体留存率非常高 (~90%)，说明 KuaiLive 用户粘性很强

### 🔥 关键发现：打赏用户留存率更低！

| 用户类型 | Train | Val | Test |
|---------|-------|-----|------|
| **打赏用户** | 82.1% | 80.1% | **78.9%** |
| **未打赏用户** | 91.5% | 91.1% | **89.2%** |
| **差值** | -9.4pp | -11.0pp | **-10.3pp** |

**解读**：
- 打赏用户的次日留存率比未打赏用户**低 10%**
- 这可能是"满足后离开"效应：打赏→满足感→离开
- 也可能是大额打赏用户是偶发性访问

### 按历史打赏次数分组

| user_gift_cnt_hist | 留存率 | 样本数 |
|--------------------|--------|--------|
| 0 | 89.2% | 194K |
| 1 | 86.5% | 502K |
| 2-5 | 89.3% | 477K |
| 6-10 | 91.8% | 121K |
| 11-100 | 95.6% | 113K |
| >100 | 94.9% | 2K |

**解读**：历史打赏越多，留存越高（忠实用户）；但**当次打赏**与留存负相关

## 3.2 留存预测模型

### 模型性能

| 指标 | Train | Val | Test |
|------|-------|-----|------|
| **AUC** | 0.5725 | 0.5700 | **0.5722** |

**结论**：AUC 接近 0.5（随机），**留存难以用当前特征预测**

### 特征重要性 (Top 10)

| 特征 | 系数 | 方向 |
|------|------|------|
| user_gift_cnt_hist | +0.5388 | ↑留存 |
| is_live_streamer | +0.0931 | ↑留存 |
| day_of_week | -0.0563 | ↓流失 |
| is_photo_author | +0.0507 | ↑留存 |
| pair_gift_cnt_hist | -0.0476 | ↓流失 |

**解读**：历史打赏次数是最强信号（忠实用户更可能留存），但整体预测能力很弱

## 3.3 短期收益 vs 留存 关系

### 预测相关性

| 指标 | 值 |
|------|-----|
| 收益预测 vs 留存预测 相关性 | 0.0337 |

**几乎不相关**：两个预测目标独立

### Top 1% 收益用户分析

| 用户群体 | 留存率 |
|----------|--------|
| Top 1% 收益预测 | 93.5% |
| 其他 99% | 89.0% |
| **差值** | +4.6pp |

**解读**：
- 模型**预测**会打赏的用户 → 留存率高（忠实用户）
- 但**实际**打赏的用户 → 留存率低（满足后离开）

## 3.4 生态基线指标

### Gini 系数

| 指标 | 平均值 | 标准差 |
|------|--------|--------|
| **曝光 Gini** | **0.5626** | 0.0145 |
| **收入 Gini** | **0.9260** | 0.0073 |

**解读**：
- 曝光分布相对均匀 (Gini=0.56)
- 收入分布**极度集中** (Gini=0.93)

### 头部集中度

| 主播比例 | 占总曝光 | 占总收入 |
|----------|----------|----------|
| Top 1% | 32.5% | **93.7%** |
| Top 10% | 68.8% | **100.0%** |

**解读**：Top 1% 主播拿走了 93.7% 的收入！

### Tail Coverage

| 指标 | 值 |
|------|-----|
| 平均每日活跃主播占比 | 15.78% |
| 约活跃主播数 | ~72,000 / 452,621 |

---

# 4. 📊 图表

### Fig 1: 留存率按天分布
![](../img/retention_rate_by_day.png)

**观察**：
- 留存率稳定在 85%-92% 之间
- 打赏用户留存率始终低于未打赏用户

### Fig 2: 留存预测 ROC 曲线
![](../img/retention_roc_curve.png)

**观察**：
- ROC 曲线接近对角线，AUC=0.57
- 留存/流失的预测分布高度重叠

### Fig 3: 生态 Gini 系数
![](../img/gini_exposure_by_day.png)

**观察**：
- 曝光 Gini (~0.56) 远低于收入 Gini (~0.93)
- 收入极度集中在头部主播

---

# 5. 💡 洞见

## 5.1 核心洞见

| # | 洞见 | 证据 | 决策影响 |
|---|------|------|---------|
| **I1** | **留存难以预测** | AUC=0.57 | 放弃作为预测目标 |
| **I2** | **打赏与留存负相关** | -10.3pp | 短期收益≠长期价值 |
| **I3** | **收入极度集中** | Gini=0.93, Top 1%=93.7% | 需要生态约束 |
| **I4** | **预测打赏 ≠ 实际打赏** | 预测 Top 1% 留存高，实际打赏留存低 | 模型识别的是"潜力"不是"行为" |

## 5.2 对长期目标的启示

| 目标 | 可行性 | 建议 |
|------|--------|------|
| 短期收益 $r^{rev}$ | ✅ 可预测 | 继续优化 RevCap |
| 用户留存 $r^{usr}$ | ❌ 难预测 | 改为观测指标，不作为预测目标 |
| 生态健康 $r^{eco}$ | ✅ 可测量 | 作为分配层约束，非预测目标 |

---

# 6. 📝 结论

## 6.1 核心发现

> **留存预测失败 (AUC=0.57)**，但发现**打赏与留存负相关**的重要洞见

- ❌ Q2.4.1: 用户留存**不可预测**（AUC 接近随机）
- ✅ Q2.4.2: 短期收益与留存**存在权衡**（打赏用户留存率低 10%）
- ✅ Q2.4.3: 生态约束**可测量**（收入 Gini=0.93，极度集中）

## 6.2 关键数字

| 指标 | 值 | 结论 |
|------|-----|------|
| 留存 AUC | 0.5722 | ❌ 难以预测 |
| RevCap@1% | 51.4% | ✅ 与 baseline 一致 |
| 打赏用户留存率 | 78.9% | vs 未打赏 89.2% |
| 收入 Gini | 0.926 | 极度集中 |
| Top 1% 主播收入占比 | 93.7% | 需要约束 |

## 6.3 设计启示

| 原则 | 建议 |
|------|------|
| **留存不可预测** | 放弃作为预测目标，改为观测 |
| **打赏损害留存** | 分配策略需平衡短期收益与长期用户价值 |
| **收入过度集中** | 分配层需添加生态约束（如凹收益函数） |

## 6.4 下一步

| 方向 | 任务 | 优先级 |
|------|------|--------|
| 放弃留存预测 | 不作为独立预测目标 | - |
| 添加留存观测 | 分配评估时监控留存变化 | 🟡 P1 |
| 生态约束设计 | 凹收益函数 / Gini 惩罚 | 🔴 P0 |
| 分配 MVP | 贪心 vs 凹收益贪心 | 🔴 P0 |

---

# 7. 📎 附录

## 7.1 数值结果

**留存预测**:
```json
{
  "train_auc": 0.5725,
  "val_auc": 0.5700,
  "test_auc": 0.5722,
  "train_retention_rate": 0.914,
  "test_retention_rate": 0.890
}
```

**生态指标**:
```json
{
  "exposure_gini_mean": 0.5626,
  "revenue_gini_mean": 0.9260,
  "tail_coverage_mean": 0.1578,
  "top_1pct_revenue": 0.937
}
```

## 7.2 执行记录

| 项 | 值 |
|----|-----|
| 留存结果 | `results/retention_model_20260119.json` |
| 生态结果 | `results/eco_baseline_20260119.json` |
| 图表 | `img/retention_*.png`, `img/gini_*.png` |

## 7.3 潜在问题与改进

| 问题 | 影响 | 改进方向 |
|------|------|---------|
| 留存率极高 (90%) | 正负样本不平衡 | 尝试预测"流失" (10%) |
| 当前特征不含用户偏好 | 留存信号弱 | 添加 user-streamer 匹配特征 |
| 打赏-留存负相关因果不明 | 无法确定是"满足离开"还是偶发访问 | 需要因果分析 |

---

> **实验完成时间**: 2026-01-19
