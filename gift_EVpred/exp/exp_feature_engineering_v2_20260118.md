# ğŸƒ Feature Engineering V2: New Signal Source Exploration
> **Name:** Feature Engineering V2
> **ID:** `EXP-20260118-gift_EVpred-04`
> **Topic:** `gift_EVpred` | **MVP:** MVP-1.2
> **Author:** Viska Wei | **Date:** 2026-01-18 | **Status:** âš ï¸ æœ‰æ³„æ¼é—®é¢˜

> ğŸ¯ **Target:** æ¢ç´¢æ–°ç‰¹å¾ä¿¡å·æºï¼ˆåºåˆ—ç‰¹å¾ã€å®æ—¶ç‰¹å¾ã€å†…å®¹åŒ¹é…åº¦ã€å†·å¯åŠ¨æ³›åŒ–ï¼‰ï¼Œæå‡æ— æ³„æ¼ baseline çš„é¢„æµ‹èƒ½åŠ›
> ğŸš€ **Next:** ~~å®æ—¶ä¸Šä¸‹æ–‡ç‰¹å¾ï¼ˆwatch_timeï¼‰æ˜¯æœ€é‡è¦çš„ä¿¡å·æº~~ â†’ **å‘ç°ä¸¥é‡æ•°æ®æ³„æ¼ï¼Œç»“æœä¸å¯ä¿¡ï¼Œéœ€é‡æ–°å®éªŒ**

---

## ğŸ”´ é‡è¦æ›´æ–°ï¼šå‘ç°æ•°æ®æ³„æ¼é—®é¢˜ï¼ˆ2026-01-18ï¼‰

> **âš ï¸ æœ¬å®éªŒå­˜åœ¨å¤šå¤„æ•°æ®æ³„æ¼ï¼Œæ‰€æœ‰ç»“è®ºéœ€è¦é‡æ–°éªŒè¯ï¼**

| æ³„æ¼ç‰¹å¾ | æ³„æ¼ç±»å‹ | ä¸¥é‡æ€§ | è¯æ® |
|---------|---------|--------|------|
| `watch_live_time` | **ç»“æœæ³„æ¼** | ğŸ”´ ä¸¥é‡ | åŒ…å«æ‰“èµåçš„è§‚çœ‹æ—¶é•¿ |
| `pair_gift_mean` | **æœªæ¥æ³„æ¼** | ğŸ”´ ä¸¥é‡ | Feature Importance = 1.4Mï¼ˆæœ€é«˜ï¼‰ |
| `pair_seq_3_mean` | **æœªæ¥æ³„æ¼** | ğŸ”´ ä¸¥é‡ | Feature Importance = 0.8Mï¼ˆç¬¬äºŒï¼‰ |

**åŸç»“è®º vs å®é™…**ï¼š
| åŸç»“è®º | å®é™…æƒ…å†µ |
|--------|----------|
| watch_time æ˜¯æœ€å¼ºä¿¡å· | âŒ **é”™è¯¯**ï¼Œpair_gift_mean æ‰æ˜¯æœ€å¼ºï¼ˆ1.4M gainï¼‰ |
| baseline+rt æå‡ +9.6% | âš ï¸ **è™šå‡æå‡**ï¼Œä¸»è¦é æ³„æ¼çš„ baseline ç‰¹å¾ |
| Spearman=0.405 è¾¾æ ‡ | âš ï¸ **ä¸å¯ä¿¡**ï¼Œæœ‰å¤šä¸ªæ³„æ¼ç‰¹å¾ |

---

## âš¡ æ ¸å¿ƒç»“è®ºé€Ÿè§ˆï¼ˆä¿®æ­£ç‰ˆï¼‰

> **ä¸€å¥è¯**: å®éªŒå­˜åœ¨ä¸¥é‡æ•°æ®æ³„æ¼ï¼ˆpair_gift_meanã€watch_timeï¼‰ï¼Œæ‰€æœ‰æ€§èƒ½æŒ‡æ ‡ä¸å¯ä¿¡ï¼Œéœ€ä¿®å¤åé‡è·‘

| éªŒè¯é—®é¢˜ | åŸç»“æœ | ä¿®æ­£çŠ¶æ€ |
|---------|--------|----------|
| H2.1: åºåˆ—ç‰¹å¾èƒ½æå‡é¢„æµ‹åŠ›? | âœ… +6.7% | âš ï¸ **éœ€é‡éªŒ**ï¼ˆpair_seq_3_mean æœ‰æ³„æ¼ï¼‰ |
| H2.2: å®æ—¶ä¸Šä¸‹æ–‡èƒ½æå‡é¢„æµ‹åŠ›? | âœ… +9.6% | âŒ **æ— æ•ˆ**ï¼ˆwatch_time æœ‰æ³„æ¼ï¼‰ |
| H2.3: å†…å®¹åŒ¹é…åº¦èƒ½æå‡é¢„æµ‹åŠ›? | âŒ -1.0% | âœ… **å¯ä¿¡**ï¼ˆæ— æ³„æ¼ï¼Œç¡®å®æ— æ•ˆï¼‰ |
| H2.4: ç»„åˆç‰¹å¾æœ‰å åŠ æ•ˆæœ? | âš ï¸ éƒ¨åˆ† | âš ï¸ **éœ€é‡éªŒ** |

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å®éªŒå€¼ | çŠ¶æ€ |
|------|--------|--------|------|
| Top-1% Capture | **> 30%** | 19.8% (rt) | âš ï¸ **ä¸å¯ä¿¡ï¼ˆæ³„æ¼ï¼‰** |
| Revenue Capture@1% | **> 40%** | 17.4% (all) | âš ï¸ **ä¸å¯ä¿¡ï¼ˆæ³„æ¼ï¼‰** |
| Spearman | **> 0.3** | 0.4059 (all) | âš ï¸ **ä¸å¯ä¿¡ï¼ˆæ³„æ¼ï¼‰** |

| Type | Link |
|------|------|
| ğŸ§  Hub | `../gift_EVpred_hub.md` Â§ H2.1-H2.4 |
| ğŸ—ºï¸ Roadmap | `../gift_EVpred_roadmap.md` Â§ MVP-1.2 |
| ğŸ“‹ ä¸Šæ¸¸å®éªŒ | `exp_leakage_free_baseline_20260118.md` |

---

# 1. ğŸ¯ ç›®æ ‡

**é—®é¢˜**: æ— æ³„æ¼ baseline (Top-1%=10.2%) é¢„æµ‹åŠ›ä¸è¶³ï¼Œéœ€è¦æ¢ç´¢æ–°çš„ç‰¹å¾ä¿¡å·æº

**éªŒè¯**: H2.1, H2.2, H2.3, H2.4

| é¢„æœŸ | åˆ¤æ–­æ ‡å‡† |
|------|---------|
| Top-1% > 30% | é€šè¿‡ â†’ ç‰¹å¾æ–¹å‘æœ‰æ•ˆï¼Œç»§ç»­æ·±åŒ– |
| 20% < Top-1% < 30% | ç‰¹å¾æœ‰è¾¹é™…è´¡çŒ®ï¼Œéœ€ç»§ç»­æ¢ç´¢ |
| Top-1% < 20% | ä¿¡å·ä¸è¶³ï¼Œè€ƒè™‘ä»»åŠ¡é™çº§ |

**ç»“æœ**: âš ï¸ å®éªŒå­˜åœ¨æ³„æ¼ï¼Œæ— æ³•å¾—å‡ºå¯é ç»“è®º

---

# 2. ğŸ¦¾ ç‰¹å¾è®¾è®¡

## 2.1 ç‰¹å¾ç»„æ¦‚è§ˆ

| ç‰¹å¾ç»„ | æ•°é‡ | æ ¸å¿ƒç‰¹å¾ | æ³„æ¼çŠ¶æ€ |
|--------|------|---------|----------|
| **Baseline** | 23 | pair_gift_mean/sum, user/streamer ç»Ÿè®¡ | ğŸ”´ **æœ‰æ³„æ¼** |
| **Sequence** | 9 | user_seq_N_mean/std/max, interval_mean | ğŸ”´ **æœ‰æ³„æ¼** |
| **Realtime** | 6 | watch_time_log, watch_time_ratio, is_peak_hour | ğŸ”´ **æœ‰æ³„æ¼** |
| **Content** | 4 | category_match, user_top_category | âœ… æ— æ³„æ¼ |
| **Coldstart** | 9 | user_tier, streamer_tier, tier_interaction | âœ… æ— æ³„æ¼ |
| **Static** | 21 | ç”¨æˆ·/ä¸»æ’­ profile ç‰¹å¾ | âœ… æ— æ³„æ¼ |

## 2.2 æ³„æ¼ç‰¹å¾è¯¦ç»†åˆ†æ

### ğŸ”´ æ³„æ¼ 1: watch_live_timeï¼ˆç»“æœæ³„æ¼ï¼‰

**æ•°æ®æ¥æº**ï¼š`click.csv`
```
user_id,live_id,streamer_id,timestamp,watch_live_time
8505,9342705,392199,1746374400022,2852
```

**é—®é¢˜**ï¼š`watch_live_time` æ˜¯è¯¥ session çš„**æ€»è§‚çœ‹æ—¶é•¿**ï¼ˆæ¯«ç§’ï¼‰ï¼ŒåŒ…æ‹¬ï¼š
- ç”¨æˆ·è¿›å…¥ç›´æ’­é—´åçš„æ‰€æœ‰æ—¶é—´
- å¦‚æœç”¨æˆ·çœ‹äº† 5 åˆ†é’Ÿåæ‰“èµï¼Œwatch_live_time åŒ…å«æ‰“èµåçš„æ—¶é—´
- è¿™æ˜¯**ç»“æœæ³„æ¼**ï¼šé•¿ watch_time â†’ ç”¨æˆ·åœç•™ä¹… â†’ å¤§æ¦‚ç‡ä¼šæ‰“èµ

**æ­£ç¡®åšæ³•**ï¼š
- åªèƒ½ç”¨ **æˆªæ–­åˆ°é¢„æµ‹æ—¶åˆ»ä¹‹å‰çš„è§‚çœ‹æ—¶é•¿**
- æˆ– **ç›´æ¥ç§»é™¤** watch_time ç›¸å…³ç‰¹å¾

### ğŸ”´ æ³„æ¼ 2: pair_gift_meanï¼ˆæœªæ¥æ³„æ¼ï¼‰

**ä»£ç é—®é¢˜**ï¼ˆ`train_feature_v2.py:110-122`ï¼‰ï¼š
```python
# ç”¨ train æ—¶é—´èŒƒå›´å†…çš„ ALL gifts è®¡ç®—ç»Ÿè®¡é‡
gift_train = gift[
    (gift['timestamp'] >= train_min_ts) &
    (gift['timestamp'] <= train_max_ts)
].copy()

pair_stats = gift_train.groupby(['user_id', 'streamer_id']).agg({
    'gift_price': ['count', 'sum', 'mean', 'std', 'max'],
    ...
})
```

**é—®é¢˜**ï¼šå¯¹äº train_df ä¸­æ—¶é—´ä¸º T çš„æ ·æœ¬ï¼Œpair_gift_mean åŒ…å«äº†ï¼š
1. T ä¹‹å‰çš„å†å²ç¤¼ç‰© âœ… åˆæ³•
2. **T æ—¶åˆ»çš„å½“å‰ç¤¼ç‰©ï¼ˆå¦‚æœæ˜¯æ­£æ ·æœ¬ï¼‰âŒ æ³„æ¼ï¼**
3. **T ä¹‹åã€train_max_ts ä¹‹å‰çš„æœªæ¥ç¤¼ç‰© âŒ æ³„æ¼ï¼**

**è¯æ®**ï¼šFeature Importance = 1.4Mï¼ˆæœ€é«˜ï¼‰ï¼Œè¿œè¶…å…¶ä»–ç‰¹å¾

**æ­£ç¡®åšæ³•**ï¼š
- ä½¿ç”¨ `cumsum() + shift(1)` å®ç°ä¸¥æ ¼ past-only
- æˆ–ä½¿ç”¨ frozen ç‰ˆæœ¬ï¼ˆåªç”¨ train ä¹‹å‰çš„å†å²ï¼‰

### ğŸ”´ æ³„æ¼ 3: pair_seq_3_meanï¼ˆæœªæ¥æ³„æ¼ï¼‰

**ä»£ç é—®é¢˜**ï¼ˆ`train_feature_v2.py:237-239`ï¼‰ï¼š
```python
pair_seq = gift_train.groupby(['user_id', 'streamer_id']).agg({
    'gift_price': lambda x: np.mean(x.values[-3:])  # æœ€å 3 æ¬¡çš„å‡å€¼
})
```

**é—®é¢˜**ï¼šåŒæ ·ä½¿ç”¨äº† train æ—¶é—´èŒƒå›´å†…çš„å…¨éƒ¨ giftsï¼ŒåŒ…å«æœªæ¥æ•°æ®

## 2.3 æ— æ³„æ¼ç‰¹å¾è¯´æ˜

### âœ… å†…å®¹åŒ¹é…ç‰¹å¾ï¼ˆContentï¼‰

```python
# ç”¨æˆ·åå¥½ç±»ç›® = å†å²æ‰“èµé‡‘é¢æœ€é«˜çš„ live_content_category
user_top_cat = user_cat_pref.loc[
    user_cat_pref.groupby('user_id')['gift_price'].idxmax()
]

# ä¸»æ’­ç±»ç›® = è¯¥ä¸»æ’­ç›´æ’­é—´æœ€å¸¸è§çš„ category
room_streamer_cat = room.groupby('streamer_id')['live_content_category'].agg(
    lambda x: x.mode()[0]
)

# åŒ¹é…åº¦ = ç®€å•çš„ç±»ç›®æ˜¯å¦ç›¸åŒ
category_match = (user_top_category == live_content_category)  # 0/1
```

**æ³¨æ„**ï¼šæ²¡æœ‰ç”¨ title embeddingsï¼Œåªç”¨äº† category åŒ¹é…ï¼ˆå¾ˆç²—ç³™ï¼‰

### âœ… å†·å¯åŠ¨ç‰¹å¾ï¼ˆColdstartï¼‰

```python
# ç”¨æˆ·æ¡£æ¬¡ = åŸºäº train æ•°æ®çš„æ¶ˆè´¹åˆ†ä½æ•°
user_spend['user_tier'] = pd.qcut(
    user_spend['user_total_spend'].rank(method='first'),
    q=4, labels=[0, 1, 2, 3]  # å››åˆ†ä½ï¼šlow/mid/high/whale
)

# ä¸»æ’­æ¡£æ¬¡ = åŸºäº train æ•°æ®çš„æ”¶å…¥åˆ†ä½æ•°
streamer_recv['streamer_tier'] = pd.qcut(
    streamer_recv['streamer_total_recv'].rank(method='first'),
    q=4, labels=[0, 1, 2, 3]
)
```

**æ³¨æ„**ï¼šuser_tier å’Œ streamer_tier æ˜¯**è‡ªå®šä¹‰çš„**ï¼ˆåŸºäºåˆ†ä½æ•°ï¼‰ï¼Œä¸æ˜¯åŸæ•°æ®å­—æ®µ

---

# 3. ğŸ§ª å®éªŒè®¾è®¡

## 3.1 æ•°æ®

| é¡¹ | å€¼ |
|----|-----|
| æ¥æº | KuaiLive (å¿«æ‰‹ç›´æ’­æ‰“èµæ•°æ®) |
| è·¯å¾„ | `data/KuaiLive/` |
| Full Train/Val/Test | 3,436,660 / 736,427 / 736,428 |
| Sampled Train/Val/Test | 500,000 / 100,000 / 100,000 |
| é‡‡æ ·ç­–ç•¥ | ä¿ç•™å…¨éƒ¨ gift è®°å½• + éšæœºé‡‡æ · non-gift |
| Gift Rate (sampled) | 12.61% / 16.38% / 15.44% |

## 3.2 æ¨¡å‹

| å‚æ•° | å€¼ |
|------|-----|
| æ¨¡å‹ | LightGBM (Direct Regression) |
| num_leaves | 31 |
| learning_rate | 0.05 |
| feature_fraction | 0.8 |
| bagging_fraction | 0.8 |
| num_boost_round | 500 (max) |
| early_stopping_rounds | 50 |

**å®é™…æ ‘æ•°**ï¼ˆä»æ—¥å¿—ï¼‰ï¼š
| å®éªŒ | best_iteration |
|------|----------------|
| baseline | 132 |
| baseline+seq | 129 |
| baseline+rt | 170 |
| baseline+content | 150 |
| baseline+cold | 146 |
| all | 159 |

## 3.3 è¯„ä¼°æŒ‡æ ‡å®šä¹‰

### Top-1% Captureï¼ˆé›†åˆé‡å ï¼‰

$$\text{Top-1\% Capture} = \frac{|\text{TopK}(\hat{y}) \cap \text{TopK}(y)|}{|\text{TopK}(y)|}$$

å…¶ä¸­ï¼š
- $K = \lfloor 0.01 \times N \rfloor$ï¼ˆå– 1% çš„æ ·æœ¬æ•°ï¼‰
- $\text{TopK}(\hat{y})$ï¼šé¢„æµ‹å€¼æœ€é«˜çš„ K ä¸ªæ ·æœ¬ç´¢å¼•é›†åˆ
- $\text{TopK}(y)$ï¼šçœŸå®å€¼æœ€é«˜çš„ K ä¸ªæ ·æœ¬ç´¢å¼•é›†åˆ
- åˆ†å­ï¼šä¸¤ä¸ªé›†åˆçš„äº¤é›†å¤§å°
- åˆ†æ¯ï¼šçœŸå® Top-K é›†åˆå¤§å°

**ç›´è§‰**ï¼šæ¨¡å‹é¢„æµ‹çš„ Top 1% ä¸çœŸå®çš„ Top 1% æœ‰å¤šå°‘é‡å ï¼Ÿ

### Revenue Capture@1%ï¼ˆæ”¶å…¥å æ¯”ï¼‰

$$\text{RevCap@1\%} = \frac{\sum_{i \in \text{TopK}(\hat{y})} y_i}{\sum_{i=1}^{N} y_i}$$

å…¶ä¸­ï¼š
- $K = \lfloor 0.01 \times N \rfloor$
- åˆ†å­ï¼šæ¨¡å‹é¢„æµ‹çš„ Top K æ ·æœ¬çš„çœŸå®æ”¶å…¥æ€»å’Œ
- åˆ†æ¯ï¼šå…¨éƒ¨æ ·æœ¬çš„çœŸå®æ”¶å…¥æ€»å’Œ

**ç›´è§‰**ï¼šå¦‚æœåªé€‰æ¨¡å‹é¢„æµ‹æœ€é«˜çš„ 1%ï¼Œèƒ½æ•è·å¤šå°‘å®é™…æ”¶å…¥ï¼Ÿ

## 3.4 å®éªŒçŸ©é˜µ

| å®éªŒ | ç‰¹å¾ç»„åˆ | Features |
|------|---------|----------|
| baseline | baseline + static | 44 |
| baseline+seq | baseline + seq + static | 53 |
| baseline+rt | baseline + rt + static | 50 |
| baseline+content | baseline + content + static | 48 |
| baseline+cold | baseline + cold + static | 53 |
| all | å…¨éƒ¨ç‰¹å¾ | 72 |

---

# 4. ğŸ“Š å›¾è¡¨

### Fig 1: Feature Ablation - Top-1% Capture
![](../img/feature_v2_ablation.png)

**è§‚å¯Ÿ**:
- baseline+rt (19.8%) æ˜¯å•ç»„æœ€ä½³ï¼Œä¼˜äº all (16.7%)
- baseline+cold (18.7%) å’Œ baseline+seq (16.9%) ä¹Ÿæœ‰æ˜¾è‘—æå‡
- baseline+content (9.2%) åè€Œæ¯” baseline (10.2%) å·®

### Fig 2: Feature Ablation - Revenue Capture@1%
![](../img/feature_v2_revenue.png)

**è§‚å¯Ÿ**:
- æ”¶å…¥æ•è·è¶‹åŠ¿ä¸ Top-1% ä¸€è‡´
- all (17.4%) ç•¥ä¼˜äº baseline+rt (17.3%)

### Fig 3: Feature Importance (All Features) - âš ï¸ å…³é”®å‘ç°
![](../img/feature_v2_importance.png)

**âš ï¸ ä¿®æ­£è§‚å¯Ÿ**ï¼ˆä¸åŸæŠ¥å‘Šä¸åŒï¼ï¼‰:
- **pair_gift_mean = 1.4M gainï¼ˆæœ€é«˜ï¼‰** â† æ³„æ¼ç‰¹å¾ï¼
- **pair_seq_3_mean = 0.8M gainï¼ˆç¬¬äºŒï¼‰** â† æ³„æ¼ç‰¹å¾ï¼
- pair_last_gift_gapï¼ˆç¬¬ä¸‰ï¼‰
- pair_gift_sumï¼ˆç¬¬å››ï¼‰
- **watch_time_ratio å’Œ watch_time_log æ’åå¾ˆä½**

**ç»“è®º**ï¼šåŸæŠ¥å‘Šç§° "watch_time æ˜¯æœ€å¼ºä¿¡å·" æ˜¯**é”™è¯¯çš„**ï¼å®é™…æ˜¯æ³„æ¼çš„ pair_gift_* ç‰¹å¾ä¸»å¯¼ã€‚

### Fig 4: Cold-start Slice Analysis
![](../img/feature_v2_coldstart.png)

**è§‚å¯Ÿ**:
- Warm-pair è¡¨ç°ä¼˜äº All å’Œ Cold-pair
- Cold-pair æ€§èƒ½æ˜¾è‘—ä¸‹é™ï¼Œæ³›åŒ–èƒ½åŠ›æœ‰é™

### Fig 5: Learning Curve
![](../img/feature_v2_learning_curve.png)

**è§‚å¯Ÿ**:
- æ€§èƒ½éšç‰¹å¾ç»„å åŠ å‘ˆéå•è°ƒå˜åŒ–
- baseline+rt è¾¾åˆ°å³°å€¼åï¼Œæ·»åŠ æ›´å¤šç‰¹å¾åè€Œä¸‹é™

---

# 5. ğŸ’¡ æ´è§

## 5.1 æ•°æ®æ³„æ¼ç›¸å…³

- **pair_gift_mean æ˜¯æœ€å¤§çš„æ³„æ¼æº**ï¼šFeature Importance = 1.4Mï¼Œè¿œè¶…å…¶ä»–ç‰¹å¾
- **watch_time æ³„æ¼è¢«æ©ç›–**ï¼šå› ä¸º pair_gift_mean æ›´å¼ºï¼Œwatch_time çš„æ³„æ¼æ•ˆæœè¢«æ©ç›–
- **æ³„æ¼ç‰¹å¾ä¸»å¯¼ä¸€åˆ‡**ï¼šåŠ æ›´å¤šç‰¹å¾åªæ˜¯åŠ å™ªå£°

## 5.2 ä¸ºä»€ä¹ˆ 72 features æ¯” 50 features å·®ï¼Ÿ

1. **æ³„æ¼ç‰¹å¾ä¸»å¯¼**ï¼špair_gift_mean å·²ç»"çŸ¥é“ç­”æ¡ˆ"ï¼ŒåŠ å…¶ä»–ç‰¹å¾æ˜¯å™ªå£°
2. **ç‰¹å¾å†—ä½™**ï¼šseq/cold/content ä¸ baseline æœ‰ç›¸å…³æ€§
3. **è¿‡æ‹Ÿåˆé£é™©**ï¼šæ›´å¤šç‰¹å¾ä½†æœ‰æ•ˆä¿¡å·æœ‰é™

## 5.3 å†…å®¹åŒ¹é…ä¸ºä»€ä¹ˆæ— æ•ˆï¼Ÿ

- åªç”¨äº† **category åŒ¹é…**ï¼ˆæ˜¯å¦åŒä¸€ç±»ç›®ï¼‰ï¼Œæ²¡æœ‰è¯­ä¹‰ä¿¡æ¯
- æ²¡æœ‰ç”¨ title embeddings æˆ–å…¶ä»–å†…å®¹ç‰¹å¾
- ç”¨æˆ·æ‰“èµå¯èƒ½æ›´ä¾èµ–ä¸»æ’­ä¸ªäººé­…åŠ›ï¼Œè€Œéå†…å®¹ç±»ç›®

## 5.4 åºåˆ—ç‰¹å¾å®šä¹‰

- `user_seq_3_mean`ï¼šç”¨æˆ·æœ€è¿‘ 3 æ¬¡æ‰“èµé‡‘é¢çš„å‡å€¼
- `user_seq_5_mean`ï¼šç”¨æˆ·æœ€è¿‘ 5 æ¬¡æ‰“èµé‡‘é¢çš„å‡å€¼
- `user_seq_3_interval_mean`ï¼šç”¨æˆ·æœ€è¿‘ 3 æ¬¡æ‰“èµçš„å¹³å‡æ—¶é—´é—´éš”ï¼ˆå°æ—¶ï¼‰
- `pair_seq_3_mean`ï¼šè¯¥ user-streamer pair æœ€è¿‘ 3 æ¬¡æ‰“èµé‡‘é¢çš„å‡å€¼

**"é—´éš”æœ‰æ•ˆ"** æŒ‡ï¼šæ‰“èµé—´éš”çŸ­ â†’ ç”¨æˆ·æ´»è·ƒæœŸ â†’ æ›´å¯èƒ½ç»§ç»­æ‰“èµ

---

# 6. ğŸ“ ç»“è®º

## 6.1 æ ¸å¿ƒå‘ç°ï¼ˆä¿®æ­£ç‰ˆï¼‰
> âš ï¸ **å®éªŒå­˜åœ¨ä¸¥é‡æ•°æ®æ³„æ¼ï¼ŒåŸç»“è®ºæ— æ•ˆï¼Œéœ€ä¿®å¤åé‡æ–°å®éªŒ**

- âŒ ~~H2.1: åºåˆ—ç‰¹å¾æœ‰æ•ˆï¼Œ+6.7% Top-1%~~ â†’ éœ€é‡éªŒï¼ˆpair_seq æœ‰æ³„æ¼ï¼‰
- âŒ ~~H2.2: å®æ—¶ç‰¹å¾æœ€æœ‰æ•ˆï¼Œ+9.6% Top-1%~~ â†’ **æ— æ•ˆ**ï¼ˆwatch_time æœ‰æ³„æ¼ï¼‰
- âœ… H2.3: å†…å®¹åŒ¹é…åº¦æ— æ•ˆï¼Œ-1.0% Top-1% â†’ **å¯ä¿¡**
- âš ï¸ H2.4: ç»„åˆç‰¹å¾ä¸å¦‚å•ç»„æœ€ä½³ â†’ éœ€é‡éªŒ

## 6.2 å…³é”®ç»“è®ºï¼ˆä¿®æ­£ç‰ˆï¼‰

| # | ç»“è®º | è¯æ® |
|---|------|------|
| 1 | âŒ ~~watch_time æ˜¯æœ€å¼ºç‰¹å¾~~ | **é”™è¯¯**ï¼špair_gift_mean æ‰æ˜¯æœ€å¼ºï¼ˆ1.4M vs å¾ˆå°ï¼‰ |
| 2 | **pair_gift_mean å­˜åœ¨ä¸¥é‡æ³„æ¼** | Feature importance å¼‚å¸¸é«˜ï¼ˆ1.4Mï¼‰ |
| 3 | **watch_time å­˜åœ¨ç»“æœæ³„æ¼** | åŒ…å«æ‰“èµåçš„è§‚çœ‹æ—¶é•¿ |
| 4 | **å†…å®¹åŒ¹é…ç¡®å®æ— æ•ˆ** | æ— æ³„æ¼ç‰¹å¾ï¼Œ-1.0% å¯ä¿¡ |
| 5 | **æ‰€æœ‰æ€§èƒ½æŒ‡æ ‡ä¸å¯ä¿¡** | ç”±æ³„æ¼ç‰¹å¾ä¸»å¯¼ |

## 6.3 è®¾è®¡å¯ç¤ºï¼ˆä¿®æ­£ç‰ˆï¼‰

| åŸåˆ™ | å»ºè®® |
|------|------|
| âŒ ~~ä¼˜å…ˆå®æ—¶ä¿¡å·~~ | watch_time æœ‰æ³„æ¼ï¼Œä¸èƒ½ç›´æ¥ç”¨ |
| âœ… ä¸¥æ ¼ past-only | pair_* ç‰¹å¾å¿…é¡»ç”¨ cumsum+shift |
| âœ… æ”¾å¼ƒå†…å®¹åŒ¹é… | ç¡®å®æ— æ•ˆ |

| âš ï¸ é™·é˜± | åŸå›  |
|---------|------|
| **watch_time æ³„æ¼** | åŒ…å«æ‰“èµåçš„æ—¶é—´ï¼Œæ˜¯ç»“æœè€ŒéåŸå›  |
| **pair èšåˆæ³„æ¼** | groupby åŒ…å«å½“å‰å’Œæœªæ¥æ ·æœ¬ |
| **Feature importance å¼‚å¸¸** | é«˜ importance å¯èƒ½æ˜¯æ³„æ¼ä¿¡å· |

## 6.4 å…³é”®æ•°å­—ï¼ˆä¸å¯ä¿¡ï¼‰

| æŒ‡æ ‡ | å€¼ | æ¡ä»¶ | çŠ¶æ€ |
|------|-----|------|------|
| Best Top-1% | 19.8% | baseline+rt | âš ï¸ ä¸å¯ä¿¡ |
| Best RevCap@1% | 17.4% | all | âš ï¸ ä¸å¯ä¿¡ |
| Best Spearman | 0.4059 | all | âš ï¸ ä¸å¯ä¿¡ |

## 6.5 ä¸‹ä¸€æ­¥ï¼ˆä¿®æ­£ç‰ˆï¼‰

| æ–¹å‘ | ä»»åŠ¡ | ä¼˜å…ˆçº§ |
|------|------|--------|
| **ä¿®å¤æ³„æ¼** | pair_* æ”¹ä¸º cumsum+shift | ğŸ”´ æœ€é«˜ |
| **ç§»é™¤ watch_time** | æˆ–ç”¨æˆªæ–­ç‰ˆæœ¬ | ğŸ”´ æœ€é«˜ |
| **é‡è·‘å®éªŒ** | åœ¨æ— æ³„æ¼ç‰ˆæœ¬ä¸ŠéªŒè¯ | ğŸ”´ æœ€é«˜ |
| å†·å¯åŠ¨ä¸“é¡¹ | é’ˆå¯¹ cold-pair åœºæ™¯ä¼˜åŒ– | ğŸŸ¡ |

---

# 7. ğŸ“ é™„å½•

## 7.1 æ•°å€¼ç»“æœï¼ˆä¸å¯ä¿¡ï¼‰

| é…ç½® | Features | Top-1% | RevCap@1% | Spearman | Train Time |
|------|----------|--------|-----------|----------|------------|
| baseline | 44 | 10.2% | 7.3% | 0.1145 | 492s |
| baseline+seq | 53 | 16.9% | 13.9% | 0.2734 | 508s |
| **baseline+rt** | 50 | **19.8%** | 17.3% | 0.4051 | 543s |
| baseline+content | 48 | 9.2% | 9.9% | 0.0771 | 517s |
| baseline+cold | 53 | 18.7% | 15.6% | 0.1114 | 503s |
| all | 72 | 16.7% | **17.4%** | **0.4059** | 320s |

## 7.2 æ‰§è¡Œè®°å½•

| é¡¹ | å€¼ |
|----|-----|
| è„šæœ¬ | `scripts/train_feature_v2.py` |
| Config | å†…åµŒ |
| Output | `gift_EVpred/results/feature_v2_eval_20260118.json` |
| Figures | `gift_EVpred/img/feature_v2_*.png` |
| Log | `logs/feature_v2_20260118_142707.log` |

```bash
# è®­ç»ƒ
source init.sh && python scripts/train_feature_v2.py
```

## 7.3 è°ƒè¯•

| é—®é¢˜ | è§£å†³ |
|------|------|
| LightGBM object dtype error | åŠ¨æ€æ£€æµ‹å¹¶ç¼–ç æ‰€æœ‰ object åˆ— |
| è®­ç»ƒæ—¶é—´è¿‡é•¿ (4.9M records) | é‡‡æ ·è‡³ 500K train / 100K val/test |
| é‡‡æ ·å gift rate åç§» | ä¿ç•™å…¨éƒ¨ gift è®°å½•çš„åˆ†å±‚é‡‡æ · |

## 7.4 æ³„æ¼é—®é¢˜è¯¦ç»†è¯´æ˜

### watch_live_time æ³„æ¼

**click.csv ç»“æ„**ï¼š
```
user_id,live_id,streamer_id,timestamp,watch_live_time
8505,9342705,392199,1746374400022,2852
```

- `watch_live_time = 2852` è¡¨ç¤ºç”¨æˆ·è§‚çœ‹äº† 2852 æ¯«ç§’
- è¿™æ˜¯ **session æ€»æ—¶é•¿**ï¼ŒåŒ…å«ç”¨æˆ·è¿›å…¥ç›´æ’­é—´åçš„æ‰€æœ‰æ—¶é—´
- å¦‚æœç”¨æˆ·åœ¨è§‚çœ‹è¿‡ç¨‹ä¸­æ‰“èµï¼Œwatch_live_time åŒ…å«æ‰“èµå‰åçš„å…¨éƒ¨æ—¶é—´
- æ¨¡å‹å¯ä»¥ä»é•¿ watch_time æ¨æ–­ï¼šåœç•™ä¹… â†’ å¤§æ¦‚ç‡æ‰“èµ

**æ­£ç¡®åšæ³•**ï¼š
- ä½¿ç”¨ **æˆªæ–­è§‚çœ‹æ—¶é•¿**ï¼šåªç»Ÿè®¡åˆ°é¢„æµ‹æ—¶åˆ»ä¹‹å‰
- æˆ– **å®Œå…¨ç§»é™¤** watch_time ç›¸å…³ç‰¹å¾

### pair_gift_mean æ³„æ¼

**ä»£ç é—®é¢˜**ï¼š
```python
# ä½¿ç”¨ train æ—¶é—´èŒƒå›´å†…çš„ ALL gifts
gift_train = gift[
    (gift['timestamp'] >= train_min_ts) &
    (gift['timestamp'] <= train_max_ts)
]

# è®¡ç®— pair ç»Ÿè®¡é‡ï¼ˆåŒ…å«å½“å‰å’Œæœªæ¥æ ·æœ¬ï¼‰
pair_stats = gift_train.groupby(['user_id', 'streamer_id']).agg({
    'gift_price': ['mean', 'sum', 'count']
})
```

**æ­£ç¡®åšæ³•**ï¼š
```python
# ä¸¥æ ¼ past-onlyï¼šåªç”¨ t < t_current çš„å†å²
gift_sorted = gift.sort_values(['user_id', 'streamer_id', 'timestamp'])
gift_sorted['pair_gift_cumsum'] = gift_sorted.groupby(
    ['user_id', 'streamer_id']
)['gift_price'].cumsum()
gift_sorted['pair_gift_mean_past'] = (
    gift_sorted['pair_gift_cumsum'].shift(1) /
    gift_sorted.groupby(['user_id', 'streamer_id']).cumcount()
)
```

---

> **å®éªŒå®Œæˆæ—¶é—´**: 2026-01-18
> **æ³„æ¼é—®é¢˜å‘ç°æ—¶é—´**: 2026-01-18
