# GiftLive - 项目规则

## ⚠️ 环境初始化（必须）

**运行任何代码前，必须先初始化环境：**
```bash
source init.sh
```

> 这会激活 conda 环境、设置 PYTHONPATH 等。忘记初始化可能导致 import 失败或环境不一致。

---

## 📁 项目结构

### 报告输出位置
默认保存位置：`/home/swei20/GiftLive/experiments/`

专题例外（已迁移）：
- `gift_allocation` → `~/GiftLive/gift_allocation/`（结构与 experiments/[topic] 一致：含 `exp/`, `img/`, `prompts/`, `results/`, `models/`）

### 目录结构
```
experiments/
├── [topic]/                    # 各主题实验目录
│   ├── [topic]_hub.md          # 智库导航（问题树、假设、洞见、设计原则）
│   ├── [topic]_roadmap.md      # 实验追踪（MVP 列表、进度、数值结果）
│   ├── exp/                    # 子实验报告目录
│   │   └── exp_*.md            # 子实验报告
│   ├── card_*.md               # 知识卡片
│   ├── sessions/               # GPT 会话归档
│   ├── prompts/                # Coding Prompt 文件
│   └── img/                    # 图表

status/
├── next_steps.md               # 下一步计划
├── archive_queue.md            # 归档队列
└── kanban.md                   # 看板

_backend/template/
├── hub.md                      # 智库导航模板
├── roadmap.md                  # 实验追踪模板
├── exp.md                      # 子实验报告模板
├── slide.md                    # Slides 输出模板
├── prompt_coding.md            # 实验 Coding Prompt 模板
├── prompt/
│   ├── prompt_exp.md           # 生成 exp 报告的指令模板
│   └── prompt_slides.md        # 生成 slides 的指令模板
├── session.md                  # GPT 会话归档模板
└── card.md                     # 知识卡片模板
```

```
gift_allocation/                 # 专题 gift_allocation（顶层目录）
├── gift_allocation_hub.md
├── gift_allocation_roadmap.md
├── exp/
│   └── exp_*.md
├── prompts/
├── img/
├── results/
└── models/
```

### 文件命名规范
- **Hub 文件**: `[topic]_hub.md`
- **Roadmap 文件**: `[topic]_roadmap.md`
- **实验报告**: `exp_[name]_[YYYYMMDD].md`
- **图表文件**: `[描述性名称].png` 保存在对应的 `img/` 子文件夹

### 模板使用（⚠️ 必须）

#### 🧠 智库导航（Hub）
**模板文件**: `_backend/template/hub.md`

**必需章节**：
1. Header: Topic、Author、Status、Date
2. 🌲 问题树: 核心问题 + 问题分解
3. 🎯 答案 + 战略路线: 战略推荐 + 按分支回答
4. 💡 洞见汇合: 汇合索引 + 详情
5. 📐 设计原则: 已确认原则 + 关键数字
6. 📎 附录: 假设存档、更新日志

**职责边界**：
- ✅ 做：问题梳理、回答问题、洞见汇合、战略导航、设计原则
- ❌ 不做：实验执行追踪（→ roadmap.md）

#### 🗺️ 实验追踪（Roadmap）
**模板文件**: `_backend/template/roadmap.md`

**必需章节**：
1. Header: 主题名称、作者、当前 Phase
2. 🔗 相关文件: 链接到 hub、exp
3. 🎯 Phase 总览: Phase 列表、依赖图
4. 📋 MVP 实验列表: 总览表、配置速查
5. 🔧 MVP 详细设计: 每个 MVP 的规格
6. 📊 进度追踪: 核心结论快照、时间线
7. 📎 附录: 数值结果汇总、文件索引

**职责边界**：
- ✅ 做：MVP 规格、执行追踪、进度看板、数值结果
- ❌ 不做：假设管理（→ hub.md）、洞见汇合（→ hub.md）

#### 📗 子实验报告（Exp）
**模板文件**: `_backend/template/exp.md`
**指令文件**: `_backend/template/prompt/prompt_exp.md`

**🎯 设计目标**：前 30 行读者不仅知道结论，还要知道「实验在做什么 + 如何复现」

**必需章节**：
1. **Header**: 实验名称、ID、Topic、MVP、Project、作者、日期、状态、Target、Decision/Next
2. **⚡ 核心结论速览（§0，≤30行，必含 I/O + Pipeline TL;DR）**:
   - §0.1 公式段 `X := ...`：用公式描述实验是什么（🐻是什么 + 🍎核心机制 + ⭐目标 + 🩸痛点 + 💧难点）
   - I/O 表：Input/Output/Baseline 🍁/Metric Δ
   - §0.2 Pipeline TL;DR：5-10 行极简伪代码（大量中文），一眼看懂在跑什么；复现命令放 §7.2
   - §0.3 假设验证表
   - §0.4 关键数字（3-5个）
   - §0.5 Links
3. **🎯 目标（§1）**: 核心问题、对应 Q/H/Gate、成功标准（✅通过/❌否决/⚠️异常）
4. **🦾 方法（§2）**:
   - §2.1 算法（可选）
   - §2.2 I/O Schema（必填）：比 §0.1 更细
   - §2.3 实现要点（file:function）
   - §2.4 实验流程（**必填**）：模块拆解表 + Code Pointer + **核心循环展开** + 复现清单
5. **🧪 实验设计（§3）**: 数据/环境、Baselines、训练配置、扫描参数、评价指标
6. **📊 图表 & 结果（§4）**: 每张图配有标题、What it shows、Key observations
7. **💡 洞见（§5）**: 机制层（Mechanism）、实验层（Diagnostics）、设计层（So what）
8. **📝 结论 & 下一步（§6）**: Punch line、关键结论表、Trade-offs、下一步任务
9. **📎 附录（§7）**:
   - §7.1 数值结果（全量）
   - §7.2 执行记录（**必填**：复现命令 repo/entry/config/seed + bash block）
   - §7.3 运行日志/Debug

**⚠️ 强制检查项**：
- ❌ 如果读者看完前 30 行仍不知道实验在跑什么 → 失败（§0.2 必须有 5-10 行极简伪代码）
- ❌ 如果读者看完方法仍不知道 I/O → 失败（I/O 必须出现在 §0.1 和 §2.2）
- ❌ 如果 §2.4 只写了 sim.run() 没展开核心循环 → 失败（必须展开核心逻辑）
- ❌ 缺少可复制命令 → 失败（§7.2 必须有 bash block）

**📤 输出规范**：
- 同时输出 `exp_[short_name]_YYYYMMDD.md` + `slides_[topic].md`（≤3页）
- Header 用英文，正文中文，图表文字全英文
- 缺失信息写 `TBD` / `Unknown`，不编造数字

#### 🤖 实验 Coding Prompt
**模板文件**: `_backend/template/prompt_coding.md`

**输出位置**: 
- 通用：`experiments/[topic]/prompts/coding_prompt_[name]_YYYYMMDD.md`
- gift_allocation 专题：`gift_allocation/prompts/coding_prompt_[name]_YYYYMMDD.md`

**必需内容**：
1. 实验 ID 与元数据
2. 实验设定: 数据、模型、训练配置
3. 要画的图: 图表类型、坐标轴、保存路径
4. 最终交付物: exp.md（按模板）+ 图表文件
5. 报告抄送位置: roadmap.md、hub.md（如有重要发现）

**⚠️ 代码生成规则（强制）**：
- ❌ **绝对禁止**：在 Coding Prompt 中写任何代码块
- ✅ **必须**：只提供参考代码路径，让 Agent 自己阅读已有代码
- 💡 **原因**：写代码骨架容易与已有代码不一致

#### 💬 GPT 会话归档（Session）
**模板文件**: `_backend/template/session.md`

**必需章节**：
1. Header: 会话 ID、日期、参与者
2. 起点: 问题 & 动机、GPT 对话摘录
3. MVP 候选列表: 从对话中结构化出的实验候选
4. 选择要执行的实验: 决策 + experiment_id 分配
5. Prompt 草稿区: 用于让 Cursor/GPT 跑实验的 prompt

#### 📇 知识卡片（Card）
**模板文件**: `_backend/template/card.md`

**定义**：可复用的阶段性知识，跨多个实验的结构性认知
- ✅ 做：理论依据、可指导决策的结论、关键证据
- ❌ 不做：指导下一步实验（这是 hub 的职责）

**位置规则**：
- 单主题 → `experiments/[topic]/card/`（gift_allocation 专题：`gift_allocation/card/`）
- 跨主题 → `experiments/card/`

### 格式要求
- 使用 LaTeX 语法：`$x^2$`, `$\alpha$`
- ⚠️ **块公式必须单行**：`$$公式$$`（同一行），不要分成多行（兼容性差）
- 表格使用标准 Markdown 格式
- 缺失信息标记为 `TODO`
- 使用 ❌/✅ 标记假设验证结果

### 作者
- 默认作者: Viska Wei

## 🔬 项目背景

本项目聚焦：
- [TODO: 填写项目核心目标]
- [TODO: 填写技术方向]

### 常用指标
- [TODO: 填写项目常用评估指标]

### 典型实验变量
- [TODO: 填写常见实验参数]

## 📝 写作风格
- 专业学术写作
- 简洁且量化
- 使用 ❌/✅ 标记假设验证

## 🚀 程序运行规则

### 所有程序必须用 nohup 后台运行
```bash
# ✅ 正确方式
nohup python script.py > logs/exp_id.log 2>&1 &
echo $! > logs/exp_id.pid

# ❌ 禁止：直接前台运行长时间任务
```

### 超过 20 分钟的任务不持续追踪
**规则**：
1. 启动任务后，立即输出 tail 命令给用户
2. **不要等待任务完成**，结束当前对话轮次
3. 用户通知任务完成后，再继续后续步骤

**标准输出格式**：
```
✅ 任务已启动 (PID: xxx)
📋 查看日志: tail -f logs/[exp_id].log
⏱️ 预计运行时间: [估计时间]
💡 任务完成后请告诉我，我继续后续步骤
```

## ❓ 进度查看

### 触发词
- `?` / `？` / `status` / `进度` / `状态`

### 执行内容
1. 📋 待办任务（`status/next_steps.md`）
2. 📦 归档队列（`status/archive_queue.md`）
3. 📝 最近更新（`experiments/`）
4. 📦 自动 Git Commit + Push

## 🚀 快速归档系统

### 触发词
- `a` / `A` / `归档` / `archive`
- `a 1` - 归档第 N 个
- `a all` - 全部归档

### 归档流程
1. 检查归档队列（`status/archive_queue.md`）
2. 撰写实验报告：按 `exp.md` 模板重写（**前 30 行是核心信息 + Run TL;DR**）
3. 同时生成 `slides_[topic].md`（≤3页）
4. 更新 roadmap.md 和 hub.md
5. 归档后检查：信息完整性检查清单
6. 移动原始文件到 processed 目录

### 关键提取项
- 核心结论一句话 → §0 核心结论速览
- 公式段 X := ... → §0.1（描述实验是什么 + I/O）
- Run TL;DR → §0.2（Repo/Entry/Config/Command/Seed/Outputs）
- 假设验证结果 → §0.3 假设验证表
- 关键数字（3-5个） → §0.4
- 实验流程 → §2.4（模块拆解表 + 伪代码 + 复现清单）
- 完整数值结果 → §7.1 数值结果表
- 可复制命令 → §7.2 执行记录（bash block）
- 关键图表 → §4（每图配 What it shows + Key observations）
- 洞见 → §5（机制层/实验层/设计层）
- 下一步任务 → §6.4

## 🆕 新建实验计划 / 立项

### 触发词
- `n` / `N` / `new` / `新建` / `立项`

### 工作流程
1. **解析用户输入**：提取实验主题、研究问题、验证假设、实验设计思路
2. **创建/更新 hub.md**（如果涉及新问题/假设）
   - 新研究问题 → 添加到 hub.md §1 核心问题树
   - 新假设 → 添加到 hub.md §2 假设
3. **创建 exp.md**（只填写实验前部分，按新模板）
   - Header（ID、Topic、MVP、Project、Target、Decision/Next）
   - §0 核心结论速览骨架（公式段 X:=、I/O 表、Run TL;DR 表 - 待填）
   - §1 目标 + 成功标准
   - §2 方法骨架（I/O Schema、实验流程模块拆解 - 待填）
   - §3 实验设计（数据/环境、Baselines、配置）
4. **更新 roadmap.md**
   - §2.1 实验总览添加条目
   - §3 MVP 详细设计（如需要）

### ⚠️ 立项注意事项
- ❌ 不生成任何代码
- ❌ 不执行实验
- ✅ 只创建/更新文档文件（.md）
- ✅ 使用 `_backend/template/exp.md` 模板
- ✅ 参考 `_backend/template/prompt/prompt_exp.md` 指令规范

## 📝 更新文档

### 触发词
- `u` / `U` / `update` / `更新`
- `u [experiment_id]` - 完整更新指定实验（补全+同步hub/roadmap+git push）
- `u hub [topic]` - 根据 prompt 模板重写/优化 Hub
- `u [关键词/描述]` - 智能匹配并追加内容

### 模式 1: `u [experiment_id]` — 完整实验更新流程

**工作流程**：
1. 定位实验报告
2. 审查实验报告完整性
3. 补全遗漏内容（实验流程/代码、数值结果）
4. 提炼假设与洞见 → 同步到 hub.md
5. 同步数值结果 → roadmap.md
6. 自动 Git Commit + Push

**hub.md 同步内容映射**：
- 新共识 → §0 共识表 (K1-Kn)
- 假设验证结果 → §1 假设树状态更新
- 关键数字 → §0 权威数字
- 设计启示 → §6.1 已确认原则
- 失败结论 → §6.4 已关闭方向

**roadmap.md 同步内容映射**：
- Header 状态 → §2.1 实验总览（状态列）
- 一句话总结 → §4.3 结论快照
- 关键数字 → §6.1 数值汇总表

### 模式 2: `u [关键词/描述]` — 智能追加内容

**内容类型 → 目标位置**：
- 新发现/洞见 → hub.md §4 洞见汇合
- 设计建议 → hub.md §6 设计原则
- 数值结果 → roadmap.md §6.1 数值结果表
- 假设验证 → hub.md §1 假设树
- 战略方向 → hub.md §3 战略推荐

## 📐 设计原则

### 触发词
- `design` / `设计原则` / `原则`

### 工作流程
1. 扫描所有 hub 文件，检查距离上次更新后新增的设计原则
2. 提取新增的设计原则（从 `§5` 或 `§6 设计原则` 章节）
3. 追加到 `design/principles.md`
4. 更新最后同步时间标记

### 文件位置
- **设计原则汇总**: `design/principles.md`

## 📇 知识卡片

### 触发词
- `card` / `卡片` / `kc`

### 工作流程
1. 确定 Card 位置（单主题/跨主题）
2. 检索所有相关实验
3. 按 card.md 模板生成卡片
4. 保存 + Git Commit

## 📌 下一步计划

### 触发词
- `next` / `下一步` / `计划`
- `next add P0/P1 [描述]` - 添加任务
- `next done [序号/描述]` - 完成任务
- `next plan` - AI 智能推荐

### 文件位置
`status/next_steps.md`

## 🔀 合并实验

### 触发词
- `merge` / `合并` / `整合`

### 用途
把多个相似目的的子实验合并成一份综合报告

### 工作流程
1. 解析描述，提取关键词
2. 扫描目录，匹配相关实验
3. 提取各实验的关键信息
4. 按 consolidated.md 模板生成综合报告
5. 输出到 `experiments/[topic]/exp_[topic]_consolidated_YYYYMMDD.md`

## 🤖 生成 Coding Prompt

### 触发词
- `p` / `P` / `prompt` / `生成prompt`

### 用途
在 session 脑暴后，将选中的 MVP 转化为可执行的 Coding Prompt

### 工作流程
1. **读取模板**: `_backend/template/prompt_coding.md`
2. **填写实验规格**: 数据、模型、训练配置（YAML 格式）
3. **列出参考代码路径**: 只写路径，不写代码块
4. **保存到**: `experiments/[topic]/prompts/coding_prompt_[name]_YYYYMMDD.md`

### ⚠️ 强制规则
- ❌ **禁止在 Prompt 中写任何代码**
- ✅ **只写参考代码路径**，让执行 Agent 自己读取并理解
- ✅ **确保参考代码路径存在**

## 🎬 生成演示 Slides

### 触发词
- `slide` / `slides` / `演示` / `汇报`
- `slide [exp_id]` - 单个实验生成 slides
- `slide [exp_id] 中文` - 指定语言生成（默认英文）
- `slide [topic]` - 批量生成：为该 topic 下所有实验各生成一个 slide
- `slide [topic] 中文` - 批量生成 + 指定语言

### 语言选项
- 默认：英文（bullet points + 逐字稿均为英文）
- `中文` / `cn` / `chinese`：中文输出
- `英文` / `en` / `english`：英文输出

### 用途
将实验报告压缩成 5 分钟可口头汇报的 1-3 页 slides + 逐字演讲稿

### 工作流程
1. **解析参数**: 识别 exp_id/topic + 语言选项
2. **读取模板**: `_backend/template/slide.md`（输出格式）+ `_backend/template/prompt/prompt_slides.md`（生成指令）
3. **定位实验**:
   - 如果是 exp_id → 生成单个 slide
   - 如果是 topic → 扫描 `[topic]/exp/` 下所有 `exp_*.md`，逐个生成
4. **提取关键信息**:
   - one-liner（结论 + 关键数字 + 动作）
   - X 公式（Why/How/I-O/Δ+ - Δ-）
   - Run TL;DR
   - 1-3 个关键结果（图/表）
   - decision + next steps
5. **生成 slides**: 按模板格式和指定语言输出

### 输出位置
- 单个实验：`[topic]/slides_[name]_YYYYMMDD.md`
- 批量生成：`[topic]/slides/slides_[exp_name]_YYYYMMDD.md`

### 输出格式（必须严格遵守）
- 总页数 ≤ 3
- 用 `---` 分割页面
- 每页 = 标题 + 3-6 条 bullet points + 折叠逐字稿
- 折叠逐字稿使用 `<details><summary>` 结构
- 每页逐字稿约 45-90 秒，三页总计 3-5 分钟

### 页内容建议
- **Slide 1**: Problem + Method（X 公式）+ I/O + Run TL;DR（10 秒复现入口）
- **Slide 2**: Results（最关键 2-3 条观察 + 数字 + 对照组）
- **Slide 3**: Decision + Trade-offs + Next steps

### ⚠️ 规则
- bullet points 只写"结论性信息"（带数字/对比/阈值/结论动作）
- 不要编造数字；缺失写 `TBD`
- 逐字稿口语化，讲清楚每页的 bullet points

## 🌱 子节点生长 (Grow Topic)

### 触发词
- `grow` / `生长` / `新建节点`

### 用途
当一个子节点/子topic（比如 kuailive eda）需要更深入理解和实验时，单独长出一个节点，生成配套文件结构，并移动相关文件。

### 工作流程
1. **解析参数**: 提取新 topic 名称、父 topic 名称、关键词（可选）
2. **查找相关文件**: 在父 topic 下查找包含关键词的实验和 prompt 文件
3. **创建目录结构**: 创建新 topic 目录（exp/, prompts/, img/, results/, models/）
4. **生成核心文件**: 
   - 创建 `[new_topic]_hub.md`（基于模板）
   - 创建 `[new_topic]_roadmap.md`（基于模板）
5. **移动文件**: 将相关实验和 prompt 文件移动到新 topic 目录
6. **更新链接**: 更新所有受影响的超链接（hub、roadmap、exp 文件等）

### 执行方式
- **AI 执行**: 直接调用 `_backend/scripts/grow_topic.py`
- **命令行**: `python _backend/scripts/grow_topic.py <new_topic> <parent_topic> [--keyword] [--insights] [--dry-run]`

### 示例
```
用户: grow kuailive gift_allocation

AI: 🌱 Grow Topic: kuailive (from gift_allocation)
    📋 找到 2 个实验文件
    📁 创建目录结构...
    📝 创建 hub.md...
    📝 创建 roadmap.md...
    📦 移动实验文件...
    🔗 更新所有链接...
    ✅ 完成！
```

### 注意事项
- 新 topic 可以是顶层目录（如 `gift_allocation`）或 `experiments/` 下的子目录
- 关键词默认为新 topic 名称，可用于匹配实验文件名或内容
- 支持 `--dry-run` 模式预览操作
- 移动文件后会自动更新所有相关链接

## 💬 GPT 会话归档

### 触发词
- `session` / `会话` / `gpt`
- `session new [topic]` - 创建新会话
- `session list` - 列出最近会话

### 用途
把 GPT 脑暴对话 → 结构化成可执行实验

## 🔄 系统架构

### 层级总览
```
Layer 1: 💬 Idea & GPT 会话层
         experiments/[topic]/sessions/session_*.md

Layer 2a: 🧠 智库导航层 (Hub)
         experiments/[topic]/[topic]_hub.md

Layer 2b: 🗺️ 实验追踪层 (Roadmap)
         experiments/[topic]/[topic]_roadmap.md

Layer 3: 📗 单实验层
         experiments/[topic]/exp/exp_*.md

Layer 4: 📇 知识卡片层
         experiments/[topic]/card/ 或 experiments/card/

Layer 5: 📅 日常节奏层
         status/next_steps.md
```

### 信息流
```
GPT 讨论 → session.md
    ↓
规划实验 → roadmap.md MVP 列表
    ↓
执行实验 → exp.md
    ↓
汇合洞见 → hub.md
    ↓
提炼结论 → card.md
    ↓
规划下一步 → next_steps.md
```

### Hub vs Roadmap 职责边界

**hub.md（智库）做**：
- ✅ 问题树、假设金字塔、洞见汇合、战略导航、设计原则

**roadmap.md（追踪）做**：
- ✅ Phase 规划、MVP 列表、进度追踪、数值结果

**核心区别**：
- Hub = 「我们知道了什么？下一步该往哪走？」（战略）
- Roadmap = 「我们计划跑哪些实验？进度如何？」（执行）

## 🔗 完整工作流

```
1. 规划实验
   n [实验描述]
   ↓
2. 执行实验
   python scripts/xxx.py
   ↓
3. 归档结果
   a
   ↓
4. 提炼知识卡片（可选）
   card [关键词]
   ↓
5. 生成报告
   report
```

### 快捷命令对照表

| 命令 | 作用 | 文件 |
|------|------|------|
| `?` | 查看进度状态 | `status/` |
| `n` | 新建实验计划 | `experiments/[topic]/exp/exp_*.md` |
| `a` | 归档实验结果 | `experiments/[topic]/exp/exp_*.md` |
| `u [exp_id]` | 完整更新：补全exp+同步hub/roadmap+git push | `experiments/[topic]/` |
| `p` | 生成 Coding Prompt | `experiments/[topic]/prompts/` |
| `merge` | 合并相似实验 | `experiments/[topic]/exp_*_consolidated_*.md` |
| `card` | 创建知识卡片 | `experiments/[topic]/card/` 或 `experiments/card/` |
| `design` | 提取设计原则 | `design/principles.md` |
| `next` | 管理待办 | `status/next_steps.md` |
| `report` | 生成报告 | `reports/drafts/` |
| `session` | GPT 会话归档 | `experiments/[topic]/sessions/` |
| `view <path>` | Markdown 预览 | 详见 `_backend/template/prompt/prompt_view.md` |
| `grow <new_topic> <parent_topic>` | 子节点生长 | 详见 `_backend/scripts/grow_topic.py` |
