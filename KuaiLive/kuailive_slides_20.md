---
# KuaiLive：打赏预测与全局长期分配优化（详细版）

- 目标：长期全局收益 = Revenue + 用户留存/满意度 + 主播生态健康
- 数据：KuaiLive（动态候选集 + 多行为 + 负反馈）
- 输出：
  - 我验证了哪些数据事实
  - 哪些建模假设被否定
  - 下一步怎么用“预测→分配→评估”做可控优化

Notes:
- 今天重点是“我如何把复杂问题拆解并把不确定性关闭”。
---
# 目录

1. 数据与约束：直播为什么难
2. EDA：5 个会改变决策的事实
3. 估计层：预测什么才对分配有用
4. 决策层：从排序到资源分配
5. 评估层：没有AB时如何可靠迭代
6. Roadmap：两周闭环、四周形成策略库

Notes:
- 如果你只记住三句话：即时打赏、付费专一、全局目标需要凹收益+约束。
---
# 1. 直播与传统推荐的关键差异

- 候选集不是静态：room 有 start/end，随时间动态变化
- 成本阶梯：click → like/comment → gift（稀疏性激增）
- 反馈类型更丰富：负反馈（曝光未点）、停留、互动
- 在线决策本质：在资源约束下做“匹配/分配”

Notes:
- 在直播里，推荐不只是“选相关”，还是“把稀缺资源分配给能产生长期收益的匹配”。
---
# 2. 数据规模与稀疏性（先固定现实）

- click 4,909,515；gift 72,646 → per-click gift_rate 1.48%
- 金额重尾：P50=2，P90=88，P99≈1488，max=56,246
- 集中度：User Gini≈0.942；Streamer Gini≈0.930；Top 1% 用户贡献≈60%

Notes:
- 这三行决定了：不能用“平均数思维”，评估必须控制方差，策略必须考虑生态护栏。
---
# 3. 口径陷阱：为什么“用户级打赏率”会是 100%

- 样本用户可能是“活跃用户子集” → user-level 是否打赏被抬高
- 正确默认口径：per-click / per-session
- 所有图表必须标注分母（click vs session vs user）

Notes:
- 这是我对齐论文与内部实验时最先处理的问题：不先锁口径，后面所有结论都不稳。
---
# 4. Session 构建与漏斗：为什么用 session-level

- 构建：同一 user×live 的连续观看合并
- 结果：session=4,293,908
- session CVR=1.57% ≈ click-level 1.48% → 构建合理
- 漏斗：Click → Session → Gift Session → Multi-gift

Notes:
- 关键是让“训练样本单位”与“在线决策单位”一致。
---
# 5. 事实#1：打赏是即时冲动（首 10% 窗口）

- 90.36% 打赏发生在 session 前 10% 时间
- 这意味着：
  - 很多“长时累计”特征不是第一优先级
  - “进入后的首段体验/内容匹配/提示触发”才是主杠杆

Notes:
- 这条事实直接改变产品与模型优先级：做首段窗口优化比做延迟建模更划算。
---
# 6. 事实#2：存在“高观看低付费”用户（增量池）

- 17.6% 用户：观看强但付费弱
- 启示：增量可能来自“转化效率提升”，而不是“挪头部存量”
- 策略方向：
  - 对该人群做触发/引导/更高转化供给匹配

Notes:
- 这是对“长期收益”的直接机会：提高转化效率通常比强化马太效应风险更小。
---
# 7. 事实#3：存在“高吸引低变现”主播（供给侧提升）

- 18.2% 主播：有观看但收入弱
- 启示：
  - 分配层不应只给头部堆资源
  - 需要识别并扶持“可被提升转化效率”的供给

Notes:
- 这与生态目标一致：提升这类主播的变现效率，可能同时提升用户体验与生态健康。
---
# 8. 事实#4：付费高度专一（扩展性有限）

- gift loyalty：P50=100%，P90=100%
- 解释：付费往往绑定于特定主播/内容关系
- 启示：
  - 不能指望强行分散把大哥导给陌生主播
  - 分层：保底满足偏好 + 有约束的探索

Notes:
- 这条事实决定了“生态优化”的方式：更像做增量与转化，而不是硬搬运。
---
# 9. 事实#5：异常极少，数据可直接建模

- 异常样本 <0.01%，数据健康评分 5.0/5.0
- Gift-Click 匹配率 >90%

Notes:
- 这意味着：问题不在数据清洗，而在任务定义与决策闭环。
---
# 10. 被否定的假设#1：延迟反馈是主矛盾

- 结果：延迟中位数=0s；加权校准（Chapelle）ECE 变差
- 结论：不走复杂延迟校正；工程上“截断+回补”足够

Notes:
- 我会强调：不是说延迟永远不重要，而是在这个数据设定与目标下，它不是瓶颈。
---
# 11. 被否定的假设#2：两段式(p×m)一定优于直接回归

- 公平对比：
  - Direct regression：Top-1% capture=54.5%，MAE(log)=0.044
  - Two-stage：Top-1% capture=35.8%，MAE(log)=0.081
  - 但 Two-stage 在 NDCG@100 更优（0.371 vs 0.217）

Notes:
- 结论不是“two-stage 不行”，而是“目标不同，胜负不同”：追头部捕获 vs 追金主细排。
---
# 12. 估计层：我们到底要预测什么？

- 不能只预测 gift_amount
- 必须输出“可供分配层组合”的多目标信号：
  - 收益：EV_gift
  - 用户：满意度 proxy（停留/互动）、留存 proxy（复访）
  - 供给：承接质量 proxy（转化效率、过载风险）

Notes:
- 只优化短期收益会把系统推向“榨干大哥、压扁长尾”的局部最优。
---
# 13. 估计层：推荐的标签与特征（最短有效集）

- 标签（session）：is_gift、gift_amount_session（log1p）
- 强特征（必须做 ablation）：
  - 首 10% 窗口：前 N 秒停留/互动代理、进入时段
  - user×streamer pair：历史专一度、近期交互、相似供给
  - 供给侧：观看→变现效率分位

Notes:
- 我会先用强基线验证“信号是否存在”，再决定是否上复杂模型。
---
# 14. 估计层：指标体系（避免单一指标误导）

- Gift 发生：PR-AUC + ECE
- 金额：MAE(log) + Spearman
- 排序：Top-1% capture + NDCG@K
- 必须加“生态/覆盖”副指标：Streamer Gini、长尾覆盖

Notes:
- Top-1% capture 代表“抓住大头”，NDCG 代表“细排质量”；两者一起看才不会走偏。
---
# 15. 决策层：为什么“最大化 EV 排序”会伤生态

- 重尾 + 专一 + 资源稀缺 → 贪心会把：
  - 大哥推给少数头部主播
  - 形成马太效应，伤害长尾供给与用户体验
- 我们要的：可控 trade-off

Notes:
- 这就是“爆单主播”与“长期全局收益”的分水岭。
---
# 16. 决策层：凹收益（Concave Returns）把 trade-off 写进目标

- 对每个主播的累计收益 V_s 做凹变换 g(V_s)
  - 例如 log(1+V) / sqrt(V) / 饱和型
- 优点：
  - 自动边际递减 → 自然分散
  - 可解释：头部“太贵”所以被折扣

Notes:
- 这一步把“生态健康”从口号变成数学项。
---
# 17. 决策层：影子价格 + 约束（资源约束显式化）

- 影子价格：λ_s = g'(V_s)，在线更新
- 约束：
  - 用户侧频控/疲劳预算（大哥稀缺）
  - 主播承接上限（过载风险）
  - 生态护栏（Gini/覆盖阈值）

Notes:
- 约束不是“公平政治正确”，而是系统稳定性的工程条件。
---
# 18. 评估层：为什么必须要 Simulator / OPE

- 稀疏+重尾 → 离线回放高方差，策略分布迁移严重
- 最小可行方案：
  - Simulator V1：校准 3 个关键事实（即时、重尾、专一）
  - OPE：IPS/SNIPS/DR 在 simulator 日志上先验证 bias/variance

Notes:
- 有了 simulator，分配层的 trade-off 可以快速扫超参；有了 OPE，才有机会用真实日志做反事实评估。
---
# 19. Roadmap（2周闭环，4周形成策略库）

- Week1：Gate-1
  - Direct regression + 首10%窗口 + pair 特征（做 ablation）
  - 指标：Top-1% capture + NDCG@K + ECE
- Week2：Gate-2/3
  - Simulator V1 + 凹收益分配原型
- Week3-4：
  - 多任务模型 + 约束护栏曲线 + OPE 验证

Notes:
- 我会优先把闭环跑通，让每一次迭代都能“可测、可解释、可回退”。
---
# 20. 需要决策/资源支持

- 目标函数权重（Revenue / 留存 proxy / 生态）与护栏阈值
- 是否能有小比例随机桶（支撑 propensity 与 OPE）
- 业务口径：主播承接上限、用户频控的定义与可观测信号

Notes:
- 这三项决定我们能把优化做成“工程系统”还是只能做“离线故事”。
